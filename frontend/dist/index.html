<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAPX-backandrepl</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #0f1419;
            --bg-tertiary: #151b23;
            --bg-card: #1a2129;
            --accent-primary: #00ff9d;
            --accent-secondary: #00d4ff;
            --accent-warning: #ffb300;
            --accent-danger: #ff4757;
            --text-primary: #e6e8eb;
            --text-secondary: #8b949e;
            --border-color: #2d3741;
            --gradient-glow: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(0, 255, 157, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 212, 255, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        #app { position: relative; z-index: 1; display: flex; min-height: 100vh; }
        
        /* Login Page */
        .login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }
        
        .login-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 48px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-logo h1 {
            font-size: 2rem;
            background: var(--gradient-glow);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-top: 16px;
        }
        
        .login-logo-icon {
            width: 64px;
            height: 64px;
            background: var(--gradient-glow);
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        
        .login-logo-icon svg {
            width: 36px;
            height: 36px;
            stroke: var(--bg-primary);
        }
        
        .login-error {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid var(--accent-danger);
            color: var(--accent-danger);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.875rem;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }
        
        .logo {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-glow);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--gradient-glow);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon svg { width: 20px; height: 20px; }
        
        .nav-menu {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 24px;
        }
        
        .nav-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            padding: 0 16px;
            margin-bottom: 8px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, rgba(0, 255, 157, 0.1), rgba(0, 212, 255, 0.1));
            color: var(--accent-primary);
            border: 1px solid rgba(0, 255, 157, 0.2);
        }
        
        .nav-item svg { width: 20px; height: 20px; flex-shrink: 0; }
        
        .user-menu {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 12px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient-glow);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--bg-primary);
        }
        
        .user-details { flex: 1; }
        .user-name { font-weight: 600; font-size: 0.875rem; }
        .user-role { font-size: 0.75rem; color: var(--text-secondary); text-transform: capitalize; }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 24px;
            min-height: 100vh;
        }
        
        .page-header { margin-bottom: 32px; }
        .page-title { font-size: 2rem; font-weight: 700; margin-bottom: 8px; }
        .page-subtitle { color: var(--text-secondary); }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 4px; height: 100%;
            background: var(--gradient-glow);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 4px;
        }
        
        .stat-detail {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        
        th {
            text-align: left;
            padding: 12px 16px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }
        
        tr:hover { background: rgba(255, 255, 255, 0.02); }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .btn-primary {
            background: var(--gradient-glow);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.3);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover { border-color: var(--accent-primary); }
        
        .btn-danger {
            background: rgba(255, 71, 87, 0.1);
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }
        
        .btn-sm { padding: 6px 12px; font-size: 0.75rem; }
        .btn-icon { padding: 8px; border-radius: 6px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Status Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-success { background: rgba(0, 255, 157, 0.1); color: var(--accent-primary); }
        .badge-warning { background: rgba(255, 179, 0, 0.1); color: var(--accent-warning); }
        .badge-danger { background: rgba(255, 71, 87, 0.1); color: var(--accent-danger); }
        .badge-info { background: rgba(0, 212, 255, 0.1); color: var(--accent-secondary); }
        .badge-btrfs { background: rgba(255, 159, 67, 0.15); color: #ff9f43; }
        .badge-zfs { background: rgba(0, 212, 255, 0.1); color: var(--accent-secondary); }
        .badge-pbs { background: rgba(156, 39, 176, 0.15); color: #ce93d8; }
        
        /* Sync Method Selector */
        .sync-method-option {
            flex: 1;
            padding: 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .sync-method-option:hover {
            border-color: var(--accent-secondary);
            background: rgba(0, 212, 255, 0.05);
        }
        
        .sync-method-option.active {
            border-color: var(--accent-primary);
            background: rgba(0, 255, 157, 0.1);
        }
        
        .sync-method-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .sync-method-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        
        .sync-method-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .sync-method-option.active .sync-method-title {
            color: var(--accent-primary);
        }
        
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.875rem; }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 157, 0.1);
        }
        
        .form-input::placeholder { color: var(--text-secondary); }
        select.form-input { cursor: pointer; }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-body { padding: 24px; }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            top: 24px; right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-success { border-left: 4px solid var(--accent-primary); }
        .toast-error { border-left: 4px solid var(--accent-danger); }
        
        /* Spinner */
        .spinner {
            width: 20px; height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Grid */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
        
        /* Setup page */
        .setup-step { margin-bottom: 24px; }
        .setup-step-number {
            width: 32px; height: 32px;
            background: var(--gradient-glow);
            color: var(--bg-primary);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
        }
        
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
        
        /* Status Indicators per Recovery Jobs */
        .status-indicator {
            min-width: 130px;
        }
        .status-indicator > div {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .status-icon {
            font-size: 1.2rem;
            margin-right: 6px;
        }
        .status-text {
            font-weight: 500;
            font-size: 0.85rem;
        }
        .status-running {
            color: var(--accent-warning);
        }
        .status-running .status-icon.pulse {
            animation: pulse 1.5s infinite;
        }
        .status-success {
            color: var(--accent-primary);
        }
        .status-failed {
            color: var(--accent-danger);
        }
        .status-pending {
            color: var(--text-secondary);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
        
        .btn-pulse:disabled {
            animation: btn-pulse 2s infinite;
            opacity: 0.7;
        }
        
        @keyframes btn-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 179, 0, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(255, 179, 0, 0); }
        }
        
        /* Progress bar per jobs in esecuzione */
        .progress-bar-container {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--gradient-glow);
            border-radius: 2px;
            animation: progress-indeterminate 1.5s infinite linear;
        }
        @keyframes progress-indeterminate {
            0% { transform: translateX(-100%); width: 30%; }
            50% { transform: translateX(100%); width: 30%; }
            100% { transform: translateX(300%); width: 30%; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Page -->
        <div v-if="!isAuthenticated" class="login-page">
            <!-- Setup Mode -->
            <div v-if="setupRequired" class="login-container">
                <div class="login-logo">
                    <div class="login-logo-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7c0-2-1-3-3-3H7c-2 0-3 1-3 3z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6M12 9v6"/>
                        </svg>
                    </div>
                    <h1>DAPX-backandrepl</h1>
                    <p style="color: var(--text-secondary); margin-top: 8px;">Setup Iniziale</p>
                </div>
                
                <div v-if="loginError" class="login-error">{{ loginError }}</div>
                
                <form @submit.prevent="doSetup">
                    <div class="form-group">
                        <label class="form-label">Username Admin</label>
                        <input type="text" class="form-input" v-model="setupForm.username" placeholder="admin" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" v-model="setupForm.email" placeholder="admin@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" v-model="setupForm.password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        <small style="color: var(--text-secondary);">Min 8 caratteri, maiuscole, minuscole, numeri</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nome Completo</label>
                        <input type="text" class="form-input" v-model="setupForm.full_name" placeholder="Administrator">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;" :disabled="loading">
                        <span v-if="loading" class="spinner"></span>
                        <span v-else>Crea Account Admin</span>
                    </button>
                </form>
            </div>
            
            <!-- Login Form -->
            <div v-else class="login-container">
                <div class="login-logo">
                    <img src="images/domarc-logo.png" alt="Domarc" style="max-width: 200px; margin-bottom: 20px;">
                    <h1>DAPX-backandrepl</h1>
                    <p style="color: var(--text-secondary); margin-top: 8px;">Backup & Replica per Proxmox</p>
                    <p style="color: var(--text-muted); margin-top: 4px; font-size: 0.85em;">v3.4.5</p>
                </div>
                
                <div v-if="loginError" class="login-error">{{ loginError }}</div>
                
                <form @submit.prevent="doLogin">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" v-model="loginForm.username" placeholder="Inserisci username" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" v-model="loginForm.password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <div class="form-group" v-if="authConfig.auth_method === 'proxmox' && authConfig.realms.length > 0">
                        <label class="form-label">Realm</label>
                        <select class="form-input" v-model="loginForm.realm">
                            <option v-for="r in authConfig.realms" :key="r.realm" :value="r.realm">
                                {{ r.realm }} - {{ r.comment || r.type }}
                            </option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;" :disabled="loading">
                        <span v-if="loading" class="spinner"></span>
                        <span v-else>Accedi</span>
                    </button>
                </form>
                
                <div v-if="authConfig.auth_method === 'proxmox'" style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 0.8rem;">
                    üîê Autenticazione tramite Proxmox VE
                </div>
            </div>
        </div>
        
        <!-- Main App (Authenticated) -->
        <template v-else>
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo" style="text-align: center;">
                <img src="images/domarc-logo.png" alt="Domarc" style="max-width: 140px; margin-bottom: 8px;">
                <h1 style="font-size: 1.2rem; margin-top: 4px;">
                    DAPX-backandrepl
                </h1>
                <small style="color: var(--text-secondary); font-size: 0.75rem;">v3.4.5</small>
            </div>
                
            <nav class="nav-menu">
                    <div class="nav-section">
                        <div class="nav-section-title">Principale</div>
                <div class="nav-item" :class="{ active: currentPage === 'dashboard' }" @click="currentPage = 'dashboard'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                    </svg>
                    Dashboard
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'proxmox' }" @click="currentPage = 'proxmox'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    Proxmox
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'nodes' }" @click="currentPage = 'nodes'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                    </svg>
                    Nodi
                </div>
                    </div>
                    
                    <div class="nav-section">
                        <div class="nav-section-title">Storage</div>
                <div class="nav-item" :class="{ active: currentPage === 'sync' }" @click="currentPage = 'sync'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Replica
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'backup' }" @click="currentPage = 'backup'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Backup (PBS)
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'recovery' }" @click="currentPage = 'recovery'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    Replica (PBS)
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'restore' }" @click="currentPage = 'restore'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    Restore (PBS)
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'migration' }" @click="currentPage = 'migration'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                    </svg>
                    Migrazione VM
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'vms' }" @click="currentPage = 'vms'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    VM
                </div>
                    </div>
                    
                    <div class="nav-section">
                        <div class="nav-section-title">Sistema</div>
                <div class="nav-item" :class="{ active: currentPage === 'host-backup' }" @click="currentPage = 'host-backup'; loadHostBackupData()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                    </svg>
                    Host Backup
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'logs' }" @click="currentPage = 'logs'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Log
                </div>
                        <div class="nav-item" :class="{ active: currentPage === 'users' }" @click="currentPage = 'users'" v-if="currentUser?.role === 'admin'">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                            Utenti
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'ssh-keys' }" @click="currentPage = 'ssh-keys'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                    </svg>
                    SSH Keys
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'settings' }" @click="currentPage = 'settings'">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Impostazioni
                        </div>
                <div class="nav-item" @click="showInfoModal = true">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Info
                </div>
                </div>
            </nav>
                
                <div class="user-menu">
                    <div class="user-info">
                        <div class="user-avatar">{{ currentUser?.username?.charAt(0).toUpperCase() }}</div>
                        <div class="user-details">
                            <div class="user-name">{{ currentUser?.full_name || currentUser?.username }}</div>
                            <div class="user-role">{{ currentUser?.role }} ‚Ä¢ {{ currentUser?.auth_method }}</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%;" @click="doLogout">
                        Logout
                    </button>
                </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard -->
            <div v-if="currentPage === 'dashboard'">
                <div class="page-header">
                    <h1 class="page-title">üìä Dashboard Principale</h1>
                    <p class="page-subtitle">Riepilogo job di replica, backup e log</p>
                </div>
                
                <!-- Summary Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Job Sincronia</div>
                        <div class="stat-value">{{ syncJobs.length }}</div>
                        <div class="stat-detail">Attivi: {{ syncJobs.filter(j => j.is_active).length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Recovery Jobs</div>
                        <div class="stat-value">{{ recoveryJobs.length }}</div>
                        <div class="stat-detail">Attivi: {{ recoveryJobs.filter(j => j.is_active).length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Nodi</div>
                        <div class="stat-value">{{ nodes.length }}</div>
                        <div class="stat-detail">
                            <a href="#" @click.prevent="currentPage = 'proxmox'" style="color: var(--accent-primary);">Vai a Proxmox ‚Üí</a>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Log Recenti</div>
                        <div class="stat-value">{{ recentLogs.length }}</div>
                        <div class="stat-detail">Ultimi 50</div>
                    </div>
                </div>
                
                <!-- Sync Jobs Summary -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3 class="card-title">üîÑ Job di Sincronia</h3>
                        <button class="btn btn-sm btn-secondary" @click="currentPage = 'sync'">Vedi tutti ‚Üí</button>
                    </div>
                    <div class="card-body">
                        <div v-if="syncJobs.length === 0" style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            Nessun job di sincronia configurato
                        </div>
                        <div v-else class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Sorgente</th>
                                        <th>Destinazione</th>
                                        <th>Stato</th>
                                        <th>Ultima Esecuzione</th>
                                        <th>Prossima Esecuzione</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="job in syncJobs.slice(0, 5)" :key="job.id">
                                        <td><strong>{{ job.name }}</strong></td>
                                        <td>{{ getNodeName(job.source_node_id) }}</td>
                                        <td>{{ getNodeName(job.dest_node_id) }}</td>
                                        <td>
                                            <span class="badge" :class="getStatusClass(job.last_status)">
                                                {{ job.last_status || 'N/A' }}
                                            </span>
                                            <span v-if="!job.is_active" class="badge badge-secondary" style="margin-left: 4px;">Pausa</span>
                                        </td>
                                        <td>
                                            <span v-if="job.last_run">{{ formatDate(job.last_run) }}</span>
                                            <span v-else style="color: var(--text-secondary);">Mai</span>
                                        </td>
                                        <td>
                                            <span v-if="job.schedule && job.is_active" style="font-family: monospace; font-size: 0.9em;">{{ job.schedule }}</span>
                                            <span v-else style="color: var(--text-secondary);">-</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-primary btn-sm" @click="runSyncJob(job)" :disabled="loading" title="Esegui">‚ñ∂</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div v-if="syncJobs.length > 5" style="text-align: center; padding: 12px; color: var(--text-secondary);">
                                <button class="btn btn-sm btn-secondary" @click="currentPage = 'sync'">Vedi tutti i {{ syncJobs.length }} job ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recovery Jobs Summary -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3 class="card-title">üíæ Recovery Jobs (PBS)</h3>
                        <button class="btn btn-sm btn-secondary" @click="currentPage = 'recovery'">Vedi tutti ‚Üí</button>
                    </div>
                    <div class="card-body">
                        <div v-if="recoveryJobs.length === 0" style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            Nessun recovery job configurato
                        </div>
                        <div v-else class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>VM</th>
                                        <th>Destinazione</th>
                                        <th>Stato</th>
                                        <th>Ultima Esecuzione</th>
                                        <th>Prossima Esecuzione</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="job in recoveryJobs.slice(0, 5)" :key="job.id">
                                        <td><strong>{{ job.name }}</strong></td>
                                        <td>
                                            <span v-if="job.vm_name">{{ job.vm_type?.toUpperCase() }} #{{ job.vm_id }} - {{ job.vm_name }}</span>
                                            <span v-else>{{ job.vm_type?.toUpperCase() }} #{{ job.vm_id }}</span>
                                        </td>
                                        <td>{{ getNodeName(job.dest_node_id) }}</td>
                                        <td>
                                            <span class="badge" :class="getStatusClass(job.last_status)">
                                                {{ job.last_status || 'N/A' }}
                                            </span>
                                            <span v-if="!job.is_active" class="badge badge-secondary" style="margin-left: 4px;">Pausa</span>
                                        </td>
                                        <td>
                                            <span v-if="job.last_run">{{ formatDate(job.last_run) }}</span>
                                            <span v-else style="color: var(--text-secondary);">Mai</span>
                                        </td>
                                        <td>
                                            <span v-if="job.schedule && job.is_active" style="font-family: monospace; font-size: 0.9em;">{{ job.schedule }}</span>
                                            <span v-else style="color: var(--text-secondary);">-</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-primary btn-sm" @click="runRecoveryJob(job.id)" :disabled="loading" title="Esegui">‚ñ∂</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div v-if="recoveryJobs.length > 5" style="text-align: center; padding: 12px; color: var(--text-secondary);">
                                <button class="btn btn-sm btn-secondary" @click="currentPage = 'recovery'">Vedi tutti i {{ recoveryJobs.length }} job ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Logs -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3 class="card-title">üìã Log Recenti</h3>
                        <button class="btn btn-sm btn-secondary" @click="currentPage = 'logs'">Vedi tutti ‚Üí</button>
                    </div>
                    <div class="card-body">
                        <div v-if="recentLogs.length === 0" style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            Nessun log disponibile
                        </div>
                        <div v-else class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data/Ora</th>
                                        <th>Job</th>
                                        <th>Tipo</th>
                                        <th>Stato</th>
                                        <th>Durata</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="log in recentLogs.slice(0, 10)" :key="log.id">
                                        <td>{{ formatDate(log.started_at) }}</td>
                                        <td><strong>{{ log.job_name || 'N/A' }}</strong></td>
                                        <td>
                                            <span class="badge badge-info">{{ log.job_type || 'N/A' }}</span>
                                        </td>
                                        <td>
                                            <span class="badge" :class="getStatusClass(log.status)">
                                                {{ log.status || 'N/A' }}
                                            </span>
                                        </td>
                                        <td>
                                            <span v-if="log.duration">{{ Math.round(log.duration / 60) }}m {{ log.duration % 60 }}s</span>
                                            <span v-else style="color: var(--text-secondary);">-</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" @click="showLogDetail(log)">Dettagli</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div v-if="recentLogs.length > 10" style="text-align: center; padding: 12px; color: var(--text-secondary);">
                                <button class="btn btn-sm btn-secondary" @click="currentPage = 'logs'">Vedi tutti i log ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Proxmox Dashboard (Host & VM) -->
            <div v-if="currentPage === 'proxmox'">
                <div class="page-header">
                    <h1 class="page-title">üñ•Ô∏è Dashboard Proxmox</h1>
                    <p class="page-subtitle">Panoramica completa dei nodi Proxmox e delle VM</p>
                    <div style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
                        <button class="btn btn-secondary btn-sm" @click="loadDashboard(true)" :disabled="loading">
                            üîÑ Aggiorna Dati
                        </button>
                        <span v-if="dashboardDataFromCache" style="color: var(--text-secondary); font-size: 0.9em;">
                            üì¶ Dati in cache
                        </span>
                    </div>
                </div>
                
                <!-- Overview Stats -->
                <div class="stats-grid" v-if="dashboardOverview">
                    <div class="stat-card">
                        <div class="stat-label">Nodi Totali</div>
                        <div class="stat-value">{{ dashboardOverview.total_nodes }}</div>
                        <div class="stat-detail">Online: {{ dashboardOverview.online_nodes }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">VM Totali</div>
                        <div class="stat-value">{{ dashboardOverview.total_vms }}</div>
                        <div class="stat-detail">Running: {{ dashboardOverview.running_vms }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Storage Totale</div>
                        <div class="stat-value">{{ formatSize(dashboardOverview.total_storage_gb * 1024 * 1024 * 1024) }}</div>
                        <div class="stat-detail">Usato: {{ formatSize(dashboardOverview.used_storage_gb * 1024 * 1024 * 1024) }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">RAM Totale</div>
                        <div class="stat-value">{{ formatSize(dashboardOverview.total_memory_gb * 1024 * 1024 * 1024) }}</div>
                        <div class="stat-detail">Usata: {{ formatSize(dashboardOverview.used_memory_gb * 1024 * 1024 * 1024) }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">CPU Cores</div>
                        <div class="stat-value">{{ dashboardOverview.total_cpu_cores }}</div>
                    </div>
                </div>
                
                <div v-else-if="loading" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    ‚è≥ Caricamento dati...
                </div>
                
                <!-- Tabella Nodi -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3 class="card-title">üñ•Ô∏è Nodi Proxmox</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Hostname</th>
                                    <th>Stato</th>
                                    <th>CPU</th>
                                    <th>RAM</th>
                                    <th>Storage</th>
                                    <th>VM</th>
                                    <th>Temperatura</th>
                                    <th>Versione</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="node in dashboardNodes" :key="node.id">
                                    <td><strong>{{ node.name }}</strong></td>
                                    <td>{{ node.hostname }}</td>
                                    <td>
                                        <span class="badge" :class="node.is_online ? 'badge-success' : 'badge-danger'">
                                            <span class="status-dot"></span>
                                            {{ node.is_online ? 'Online' : 'Offline' }}
                                        </span>
                                    </td>
                                    <td>
                                        <span v-if="node.cpu?.cores">{{ node.cpu.cores }} cores</span>
                                        <span v-else style="color: var(--text-secondary);">N/A</span>
                                    </td>
                                    <td>
                                        <div v-if="node.memory?.total_gb">
                                            <div>{{ formatSize(node.memory.total_gb * 1024 * 1024 * 1024) }}</div>
                                            <div style="font-size: 0.85em; color: var(--text-secondary);">
                                                Usata: {{ formatSize((node.memory.used_gb || 0) * 1024 * 1024 * 1024) }}
                                            </div>
                                        </div>
                                        <span v-else style="color: var(--text-secondary);">N/A</span>
                                    </td>
                                    <td>
                                        <div v-if="node.storage_total_gb && node.storage_total_gb > 0">
                                            <div>{{ formatSize(node.storage_total_gb * 1024 * 1024 * 1024) }}</div>
                                            <div style="font-size: 0.85em; color: var(--text-secondary);">
                                                Usato: {{ formatSize((node.storage_used_gb || 0) * 1024 * 1024 * 1024) }}
                                            </div>
                                        </div>
                                        <span v-else style="color: var(--text-secondary);">N/A</span>
                                    </td>
                                    <td>
                                        <span v-if="node.vm_count !== undefined && node.vm_count !== null">
                                            {{ node.vm_count }} 
                                            <span v-if="node.running_vm_count && node.running_vm_count > 0" style="color: var(--accent-primary);">
                                                ({{ node.running_vm_count }} running)
                                            </span>
                                        </span>
                                        <span v-else style="color: var(--text-secondary);">-</span>
                                    </td>
                                    <td>
                                        <span v-if="node.temperature_highest_c">
                                            {{ node.temperature_highest_c }}¬∞C
                                        </span>
                                        <span v-else style="color: var(--text-secondary);">N/A</span>
                                    </td>
                                    <td>
                                        <span v-if="node.proxmox_version">{{ node.proxmox_version }}</span>
                                        <span v-else style="color: var(--text-secondary);">-</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-secondary btn-sm" @click="viewNodeDetails(node.id)">Dettagli</button>
                                    </td>
                                </tr>
                                <tr v-if="dashboardNodes.length === 0 && !loading">
                                    <td colspan="10" style="text-align: center; color: var(--text-secondary);">Nessun nodo configurato</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tabella VM Aggregate -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3 class="card-title">üñ•Ô∏è VM Aggregate</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>VMID</th>
                                    <th>Nome</th>
                                    <th>Nodo</th>
                                    <th>Tipo</th>
                                    <th>Stato</th>
                                    <th>CPU</th>
                                    <th>RAM</th>
                                    <th>Storage</th>
                                    <th>Uptime</th>
                                    <th>IP</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="vm in dashboardVMs" :key="`${vm.node_id}-${vm.vmid}`">
                                    <td><strong>{{ vm.vmid }}</strong></td>
                                    <td>{{ vm.name }}</td>
                                    <td>{{ vm.node_name }}</td>
                                    <td>
                                        <span class="badge badge-info">{{ vm.type }}</span>
                                    </td>
                                    <td>
                                        <span class="badge" :class="vm.status === 'running' ? 'badge-success' : 'badge-warning'">
                                            {{ vm.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <span v-if="vm.cpu_cores">{{ vm.cpu_cores }} cores</span>
                                        <span v-else style="color: var(--text-secondary);">-</span>
                                    </td>
                                    <td>
                                        <span v-if="vm.memory_gb">{{ vm.memory_gb }} GB</span>
                                        <span v-else style="color: var(--text-secondary);">-</span>
                                    </td>
                                    <td>
                                        <span v-if="vm.disk_size">{{ formatSize(vm.disk_size) }}</span>
                                        <span v-else style="color: var(--text-secondary);">-</span>
                                    </td>
                                    <td>
                                        <span v-if="vm.uptime_seconds">{{ formatUptime(vm.uptime_seconds) }}</span>
                                        <span v-else style="color: var(--text-secondary);">-</span>
                                    </td>
                                    <td>
                                        <span v-if="vm.primary_ip" style="font-family: monospace; font-size: 0.9em;">{{ vm.primary_ip }}</span>
                                        <span v-else style="color: var(--text-secondary);">-</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-secondary btn-sm" @click="viewVMDetails(vm.node_id, vm.vmid, vm.type)">Dettagli</button>
                                    </td>
                                </tr>
                                <tr v-if="dashboardVMs.length === 0 && !loading">
                                    <td colspan="11" style="text-align: center; color: var(--text-secondary);">Nessuna VM trovata</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Node Details Page -->
            <div v-if="currentPage === 'node-details'">
                <div class="page-header">
                    <button class="btn btn-secondary btn-sm" @click="currentPage = 'proxmox'" style="margin-bottom: 12px;">
                        ‚Üê Torna a Proxmox
                    <h1 class="page-title">üñ•Ô∏è Dettagli Nodo</h1>
                    <p class="page-subtitle" v-if="selectedNodeDetail">{{ selectedNodeDetail.node_name }} ({{ selectedNodeDetail.hostname }})</p>
                </div>
                
                <div v-if="loadingNodeDetail" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    ‚è≥ Caricamento dettagli nodo...
                </div>
                
                <div v-else-if="selectedNodeDetail">
                    <!-- Overview Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìä Panoramica</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-label">Hostname</div>
                                    <div class="stat-value" style="font-size: 1.2em;">{{ selectedNodeDetail.hostname }}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Versione Proxmox</div>
                                    <div class="stat-value" style="font-size: 1.2em;">{{ selectedNodeDetail.proxmox_version || 'N/A' }}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Kernel</div>
                                    <div class="stat-value" style="font-size: 1.2em;">{{ selectedNodeDetail.kernel_version || 'N/A' }}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Uptime</div>
                                    <div class="stat-value" style="font-size: 1.2em;">{{ formatUptime(selectedNodeDetail.uptime_seconds) }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CPU Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedNodeDetail.cpu">
                        <div class="card-header">
                            <h3 class="card-title">‚öôÔ∏è CPU</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-label">Cores</div>
                                    <div class="stat-value">{{ selectedNodeDetail.cpu.cores || 'N/A' }}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Model</div>
                                    <div class="stat-value" style="font-size: 0.9em;">{{ selectedNodeDetail.cpu.model || 'N/A' }}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Frequenza</div>
                                    <div class="stat-value">{{ selectedNodeDetail.cpu.frequency_mhz ? selectedNodeDetail.cpu.frequency_mhz + ' MHz' : 'N/A' }}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Utilizzo</div>
                                    <div class="stat-value">{{ selectedNodeDetail.cpu.usage_percent ? selectedNodeDetail.cpu.usage_percent + '%' : 'N/A' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Memory Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedNodeDetail.memory">
                        <div class="card-header">
                            <h3 class="card-title">üíæ Memoria</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-label">Totale</div>
                                    <div class="stat-value">{{ formatSize((selectedNodeDetail.memory.total_gb || 0) * 1024 * 1024 * 1024) }}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Usata</div>
                                    <div class="stat-value">{{ formatSize((selectedNodeDetail.memory.used_gb || 0) * 1024 * 1024 * 1024) }}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Disponibile</div>
                                    <div class="stat-value">{{ formatSize((selectedNodeDetail.memory.available_gb || 0) * 1024 * 1024 * 1024) }}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Utilizzo</div>
                                    <div class="stat-value">{{ selectedNodeDetail.memory.usage_percent ? selectedNodeDetail.memory.usage_percent + '%' : 'N/A' }}</div>
                                </div>
                            </div>
                            <div v-if="selectedNodeDetail.memory.usage_percent" style="margin-top: 16px;">
                                <div style="background: var(--bg-secondary); border-radius: 8px; height: 24px; overflow: hidden; position: relative;">
                                    <div :style="{ width: selectedNodeDetail.memory.usage_percent + '%', background: selectedNodeDetail.memory.usage_percent > 80 ? 'var(--danger)' : selectedNodeDetail.memory.usage_percent > 60 ? 'var(--warning)' : 'var(--accent-primary)', height: '100%', transition: 'width 0.3s' }"></div>
                                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.85em; font-weight: 600;">{{ selectedNodeDetail.memory.usage_percent }}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Storage Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedNodeDetail.storage && selectedNodeDetail.storage.length > 0">
                        <div class="card-header">
                            <h3 class="card-title">üíø Storage</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Tipo</th>
                                            <th>Totale</th>
                                            <th>Usato</th>
                                            <th>Disponibile</th>
                                            <th>Utilizzo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="store in selectedNodeDetail.storage" :key="store.name">
                                            <td><strong>{{ store.name }}</strong></td>
                                            <td><span class="badge badge-info">{{ store.type || 'N/A' }}</span></td>
                                            <td>{{ formatSize((store.total_gb || 0) * 1024 * 1024 * 1024) }}</td>
                                            <td>{{ formatSize((store.used_gb || 0) * 1024 * 1024 * 1024) }}</td>
                                            <td>{{ formatSize((store.available_gb || 0) * 1024 * 1024 * 1024) }}</td>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <div style="flex: 1; background: var(--bg-secondary); border-radius: 4px; height: 16px; overflow: hidden; position: relative;">
                                                        <div :style="{ width: (store.usage_percent || 0) + '%', background: (store.usage_percent || 0) > 80 ? 'var(--danger)' : (store.usage_percent || 0) > 60 ? 'var(--warning)' : 'var(--accent-primary)', height: '100%' }"></div>
                                                    </div>
                                                    <span style="font-size: 0.9em; min-width: 45px;">{{ store.usage_percent || 0 }}%</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Network Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedNodeDetail.network && selectedNodeDetail.network.filter(n => (n.status === 'UP' || n.state === 'up' || n.status === 'up')).length > 0">
                        <div class="card-header">
                            <h3 class="card-title">üåê Network</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Interfaccia</th>
                                            <th>Tipo</th>
                                            <th>IP</th>
                                            <th>Netmask</th>
                                            <th>Gateway</th>
                                            <th>MAC</th>
                                            <th>Stato</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="net in selectedNodeDetail.network.filter(n => (n.status === 'UP' || n.state === 'up' || n.status === 'up'))" :key="net.name">
                                            <td><strong>{{ net.name }}</strong></td>
                                            <td>
                                                <span class="badge badge-info">{{ net.type || 'ethernet' }}</span>
                                                <span v-if="net.bridge" class="badge badge-secondary" style="margin-left: 4px;">Bridge: {{ net.bridge }}</span>
                                            </td>
                                            <td>{{ net.ip || (net.ipv4 && net.ipv4.length > 0 ? net.ipv4[0] : 'N/A') }}</td>
                                            <td>{{ net.netmask || 'N/A' }}</td>
                                            <td>{{ net.gateway || 'N/A' }}</td>
                                            <td style="font-family: monospace; font-size: 0.9em;">{{ net.mac || 'N/A' }}</td>
                                            <td>
                                                <span class="badge badge-success">
                                                    {{ net.status || net.state || 'UP' }}
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 24px;" v-else-if="selectedNodeDetail">
                        <div class="card-header">
                            <h3 class="card-title">üåê Network</h3>
                        </div>
                        <div class="card-body">
                            <p style="color: var(--text-secondary); text-align: center;">Nessun dato di rete disponibile</p>
                        </div>
                    </div>
                    
                    <!-- Temperature Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedNodeDetail.temperature">
                        <div class="card-header">
                            <h3 class="card-title">üå°Ô∏è Temperatura</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card" v-if="selectedNodeDetail.temperature.highest_c">
                                    <div class="stat-label">Massima</div>
                                    <div class="stat-value" :style="{ color: selectedNodeDetail.temperature.highest_c > 70 ? 'var(--danger)' : selectedNodeDetail.temperature.highest_c > 60 ? 'var(--warning)' : 'var(--accent-primary)' }">
                                        {{ selectedNodeDetail.temperature.highest_c }}¬∞C
                                    </div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.temperature.average_c">
                                    <div class="stat-label">Media</div>
                                    <div class="stat-value">{{ selectedNodeDetail.temperature.average_c }}¬∞C</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hardware Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedNodeDetail.hardware">
                        <div class="card-header">
                            <h3 class="card-title">üîß Hardware</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card" v-if="selectedNodeDetail.hardware.model">
                                    <div class="stat-label">Modello</div>
                                    <div class="stat-value" style="font-size: 0.95em;">{{ selectedNodeDetail.hardware.model }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.hardware.manufacturer">
                                    <div class="stat-label">Produttore</div>
                                    <div class="stat-value" style="font-size: 0.95em;">{{ selectedNodeDetail.hardware.manufacturer }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.hardware.serial">
                                    <div class="stat-label">Serial Number</div>
                                    <div class="stat-value" style="font-size: 0.9em; font-family: monospace;">{{ selectedNodeDetail.hardware.serial }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.hardware.board">
                                    <div class="stat-label">Scheda Madre</div>
                                    <div class="stat-value" style="font-size: 0.95em;">{{ selectedNodeDetail.hardware.board }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.hardware.bios_vendor">
                                    <div class="stat-label">BIOS Vendor</div>
                                    <div class="stat-value" style="font-size: 0.95em;">{{ selectedNodeDetail.hardware.bios_vendor }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.hardware.bios_version">
                                    <div class="stat-label">BIOS Version</div>
                                    <div class="stat-value" style="font-size: 0.95em;">{{ selectedNodeDetail.hardware.bios_version }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.hardware.bios_date">
                                    <div class="stat-label">BIOS Date</div>
                                    <div class="stat-value" style="font-size: 0.9em;">{{ selectedNodeDetail.hardware.bios_date }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CPU Details Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedNodeDetail.cpu && (selectedNodeDetail.cpu.sockets || selectedNodeDetail.cpu.threads || selectedNodeDetail.cpu.load_15m)">
                        <div class="card-header">
                            <h3 class="card-title">‚öôÔ∏è Dettagli CPU</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card" v-if="selectedNodeDetail.cpu.sockets">
                                    <div class="stat-label">Sockets</div>
                                    <div class="stat-value">{{ selectedNodeDetail.cpu.sockets }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.cpu.threads">
                                    <div class="stat-label">Threads</div>
                                    <div class="stat-value">{{ selectedNodeDetail.cpu.threads }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.cpu.load_1m !== undefined">
                                    <div class="stat-label">Load 1m</div>
                                    <div class="stat-value">{{ selectedNodeDetail.cpu.load_1m?.toFixed(2) || 'N/A' }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.cpu.load_5m !== undefined">
                                    <div class="stat-label">Load 5m</div>
                                    <div class="stat-value">{{ selectedNodeDetail.cpu.load_5m?.toFixed(2) || 'N/A' }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.cpu.load_15m !== undefined">
                                    <div class="stat-label">Load 15m</div>
                                    <div class="stat-value">{{ selectedNodeDetail.cpu.load_15m?.toFixed(2) || 'N/A' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Swap Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedNodeDetail.memory && (selectedNodeDetail.memory.swap_total_gb || selectedNodeDetail.memory.swap_used_gb)">
                        <div class="card-header">
                            <h3 class="card-title">üíæ Swap</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card" v-if="selectedNodeDetail.memory.swap_total_gb">
                                    <div class="stat-label">Totale</div>
                                    <div class="stat-value">{{ formatSize((selectedNodeDetail.memory.swap_total_gb || 0) * 1024 * 1024 * 1024) }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.memory.swap_used_gb">
                                    <div class="stat-label">Usato</div>
                                    <div class="stat-value">{{ formatSize((selectedNodeDetail.memory.swap_used_gb || 0) * 1024 * 1024 * 1024) }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- License Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedNodeDetail.license">
                        <div class="card-header">
                            <h3 class="card-title">üìú Licenza</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-label">Status</div>
                                    <div class="stat-value">
                                        <span class="badge" :class="selectedNodeDetail.license.status === 'active' ? 'badge-success' : 'badge-warning'">
                                            {{ selectedNodeDetail.license.status || 'N/A' }}
                                        </span>
                                    </div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.license.level">
                                    <div class="stat-label">Level</div>
                                    <div class="stat-value">{{ selectedNodeDetail.license.level }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.license.type">
                                    <div class="stat-label">Tipo</div>
                                    <div class="stat-value" style="font-size: 0.9em;">{{ selectedNodeDetail.license.type }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.license.key">
                                    <div class="stat-label">Key</div>
                                    <div class="stat-value" style="font-size: 0.85em; font-family: monospace;">{{ selectedNodeDetail.license.key }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.license.subscription">
                                    <div class="stat-label">Subscription</div>
                                    <div class="stat-value" style="font-size: 0.85em; font-family: monospace;">{{ selectedNodeDetail.license.subscription }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.license.sockets">
                                    <div class="stat-label">Sockets</div>
                                    <div class="stat-value">{{ selectedNodeDetail.license.sockets }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedNodeDetail.license.valid_until">
                                    <div class="stat-label">Valida fino a</div>
                                    <div class="stat-value" style="font-size: 0.9em;">{{ selectedNodeDetail.license.valid_until }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-else style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    Nessun dato disponibile
                </div>
            </div>
            
            <!-- VM Details Page -->
            <div v-if="currentPage === 'vm-details'">
                <div class="page-header">
                    <button class="btn btn-secondary btn-sm" @click="currentPage = 'proxmox'" style="margin-bottom: 12px;">
                        ‚Üê Torna a Proxmox
                    </button>
                    <h1 class="page-title">üñ•Ô∏è Dettagli VM</h1>
                    <p class="page-subtitle" v-if="selectedVMDetail">{{ selectedVMDetail.name }} (VMID: {{ selectedVMDetail.vmid }})</p>
                </div>
                
                <div v-if="loadingVMDetail" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    ‚è≥ Caricamento dettagli VM...
                </div>
                
                <div v-else-if="!selectedVMDetail" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <p>Nessun dato disponibile per questa VM</p>
                    <button class="btn btn-secondary btn-sm" @click="currentPage = 'proxmox'" style="margin-top: 12px;">
                        ‚Üê Torna a Proxmox
                    </button>
                </div>
                
                <div v-else-if="selectedVMDetail">
                    <!-- Overview Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìä Panoramica</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-label">VMID</div>
                                    <div class="stat-value">{{ selectedVMDetail.vmid }}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Nome</div>
                                    <div class="stat-value" style="font-size: 1.1em;">{{ selectedVMDetail.name }}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Tipo</div>
                                    <div class="stat-value">
                                        <span class="badge badge-info">{{ selectedVMDetail.vm_type }}</span>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Stato</div>
                                    <div class="stat-value">
                                        <span class="badge" :class="selectedVMDetail.status === 'running' ? 'badge-success' : 'badge-warning'">
                                            {{ selectedVMDetail.status }}
                                        </span>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Nodo</div>
                                    <div class="stat-value" style="font-size: 1.1em;">{{ selectedVMDetail.node_name }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Runtime Stats Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedVMDetail.runtime">
                        <div class="card-header">
                            <h3 class="card-title">‚ö° Statistiche Runtime</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card" v-if="selectedVMDetail.runtime.cpu !== undefined">
                                    <div class="stat-label">CPU Usage</div>
                                    <div class="stat-value">{{ selectedVMDetail.runtime.cpu }}%</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.runtime.mem">
                                    <div class="stat-label">Memoria Usata</div>
                                    <div class="stat-value">{{ formatSize(selectedVMDetail.runtime.mem) }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.runtime.maxmem">
                                    <div class="stat-label">Memoria Totale</div>
                                    <div class="stat-value">{{ formatSize(selectedVMDetail.runtime.maxmem) }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.runtime.uptime">
                                    <div class="stat-label">Uptime</div>
                                    <div class="stat-value" style="font-size: 0.9em;">{{ formatUptime(selectedVMDetail.runtime.uptime) }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.runtime.diskread">
                                    <div class="stat-label">Disk Read</div>
                                    <div class="stat-value" style="font-size: 0.9em;">{{ formatSize(selectedVMDetail.runtime.diskread) }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.runtime.diskwrite">
                                    <div class="stat-label">Disk Write</div>
                                    <div class="stat-value" style="font-size: 0.9em;">{{ formatSize(selectedVMDetail.runtime.diskwrite) }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.runtime.netin">
                                    <div class="stat-label">Network In</div>
                                    <div class="stat-value" style="font-size: 0.9em;">{{ formatSize(selectedVMDetail.runtime.netin) }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.runtime.netout">
                                    <div class="stat-label">Network Out</div>
                                    <div class="stat-value" style="font-size: 0.9em;">{{ formatSize(selectedVMDetail.runtime.netout) }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.runtime.pid">
                                    <div class="stat-label">PID</div>
                                    <div class="stat-value" style="font-size: 0.9em; font-family: monospace;">{{ selectedVMDetail.runtime.pid }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VM Configuration Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedVMDetail.config">
                        <div class="card-header">
                            <h3 class="card-title">‚öôÔ∏è Configurazione VM</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card" v-if="selectedVMDetail.config.cores">
                                    <div class="stat-label">CPU Cores</div>
                                    <div class="stat-value">{{ selectedVMDetail.config.cores }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.config.sockets">
                                    <div class="stat-label">CPU Sockets</div>
                                    <div class="stat-value">{{ selectedVMDetail.config.sockets }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.config.memory">
                                    <div class="stat-label">Memoria Config</div>
                                    <div class="stat-value">{{ formatSize((selectedVMDetail.config.memory || 0) * 1024 * 1024) }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.bios">
                                    <div class="stat-label">BIOS</div>
                                    <div class="stat-value">
                                        <span class="badge badge-info">{{ selectedVMDetail.bios }}</span>
                                    </div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.ostype">
                                    <div class="stat-label">OS Type</div>
                                    <div class="stat-value">
                                        <span class="badge badge-info">{{ selectedVMDetail.ostype }}</span>
                                    </div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.boot">
                                    <div class="stat-label">Boot Order</div>
                                    <div class="stat-value" style="font-size: 0.9em; font-family: monospace;">{{ selectedVMDetail.boot }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.agent_enabled !== undefined">
                                    <div class="stat-label">Agent Enabled</div>
                                    <div class="stat-value">
                                        <span class="badge" :class="selectedVMDetail.agent_enabled ? 'badge-success' : 'badge-warning'">
                                            {{ selectedVMDetail.agent_enabled ? 'Yes' : 'No' }}
                                        </span>
                                    </div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.primary_bridge">
                                    <div class="stat-label">Primary Bridge</div>
                                    <div class="stat-value" style="font-size: 0.95em;">{{ selectedVMDetail.primary_bridge }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.primary_ip">
                                    <div class="stat-label">Primary IP</div>
                                    <div class="stat-value" style="font-size: 0.95em; font-family: monospace;">{{ selectedVMDetail.primary_ip }}</div>
                                </div>
                                <div class="stat-card" v-if="selectedVMDetail.tags">
                                    <div class="stat-label">Tags</div>
                                    <div class="stat-value" style="font-size: 0.9em;">
                                        <span v-for="tag in selectedVMDetail.tags.split(',')" :key="tag" class="badge badge-secondary" style="margin-right: 4px;">
                                            {{ tag.trim() }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Disks Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedVMDetail.disks && selectedVMDetail.disks.length > 0">
                        <div class="card-header">
                            <h3 class="card-title">üíø Dischi</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Type</th>
                                            <th>Volume</th>
                                            <th>Media</th>
                                            <th>Storage</th>
                                            <th>Discard</th>
                                            <th>IOThread</th>
                                            <th>Size</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="disk in selectedVMDetail.disks" :key="disk.id">
                                            <td><strong>{{ disk.id }}</strong></td>
                                            <td>
                                                <span class="badge badge-info">{{ disk.type || 'disk' }}</span>
                                            </td>
                                            <td style="font-family: monospace; font-size: 0.9em;">{{ disk.volume || disk.dataset || 'none' }}</td>
                                            <td>{{ disk.media || '-' }}</td>
                                            <td>{{ disk.storage || '-' }}</td>
                                            <td>
                                                <span v-if="disk.discard" class="badge badge-success">{{ disk.discard }}</span>
                                                <span v-else>-</span>
                                            </td>
                                            <td>
                                                <span v-if="disk.iothread" class="badge badge-info">{{ disk.iothread }}</span>
                                                <span v-else>-</span>
                                            </td>
                                            <td>{{ disk.size ? formatSize(disk.size) : (disk.size_bytes ? formatSize(disk.size_bytes) : '-') }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Network Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedVMDetail.networks && selectedVMDetail.networks.length > 0">
                        <div class="card-header">
                            <h3 class="card-title">üåê Network</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Interfaccia</th>
                                            <th>MAC</th>
                                            <th>Bridge</th>
                                            <th>Model</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="net in selectedVMDetail.networks" :key="net.name">
                                            <td><strong>{{ net.name }}</strong></td>
                                            <td>{{ net.mac || 'N/A' }}</td>
                                            <td>{{ net.bridge || 'N/A' }}</td>
                                            <td>{{ net.model || 'N/A' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div v-if="selectedVMDetail.ip_addresses && Object.keys(selectedVMDetail.ip_addresses).length > 0" style="margin-top: 16px;">
                                <h4 style="margin-bottom: 8px;">Indirizzi IP</h4>
                                <div v-for="(ips, iface) in selectedVMDetail.ip_addresses" :key="iface" style="margin-bottom: 8px;">
                                    <strong>{{ iface }}:</strong>
                                    <span v-for="(ip, idx) in ips" :key="idx" style="margin-left: 8px;">
                                        <span class="badge badge-info">{{ ip }}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Config Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedVMDetail.config">
                        <div class="card-header">
                            <h3 class="card-title">‚öôÔ∏è Configurazione</h3>
                        </div>
                        <div class="card-body">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; font-family: monospace; font-size: 0.9em; overflow-x: auto;">
                                <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">{{ JSON.stringify(selectedVMDetail.config, null, 2) }}</pre>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Snapshots Card -->
                    <div class="card" style="margin-top: 24px;" v-if="selectedVMDetail.snapshots && selectedVMDetail.snapshots.count > 0">
                        <div class="card-header">
                            <h3 class="card-title">üì∏ Snapshot</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-label">Totale Snapshot</div>
                                    <div class="stat-value">{{ selectedVMDetail.snapshots.count || 0 }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-else style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    Nessun dato disponibile
                </div>
            </div>
                
                <!-- Users Page (Admin Only) -->
                <div v-if="currentPage === 'users' && currentUser?.role === 'admin'">
                    <div class="page-header">
                        <h1 class="page-title">Gestione Utenti</h1>
                        <p class="page-subtitle">Amministrazione utenti e permessi</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üë• Utenti</h3>
                            <button class="btn btn-primary" @click="showUserModal = true">+ Nuovo Utente</button>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr><th>Username</th><th>Email</th><th>Nome</th><th>Ruolo</th><th>Auth</th><th>Stato</th><th>Ultimo Login</th><th>Azioni</th></tr>
                                </thead>
                                <tbody>
                                    <tr v-for="u in users" :key="u.id">
                                        <td>{{ u.username }}</td>
                                        <td>{{ u.email || '-' }}</td>
                                        <td>{{ u.full_name || '-' }}</td>
                                        <td><span class="badge badge-info">{{ u.role }}</span></td>
                                        <td><span class="badge" :class="u.auth_method === 'proxmox' ? 'badge-success' : 'badge-warning'">{{ u.auth_method }}</span></td>
                                        <td>
                                            <span class="badge" :class="u.is_active ? 'badge-success' : 'badge-danger'">
                                                {{ u.is_active ? 'Attivo' : 'Disabilitato' }}
                                            </span>
                                        </td>
                                        <td>{{ u.last_login ? formatDate(u.last_login) : 'Mai' }}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" @click="editUser(u)" v-if="u.id !== currentUser.id">Modifica</button>
                                            <button class="btn btn-danger btn-sm" @click="deleteUser(u)" v-if="u.id !== currentUser.id">Elimina</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                    </div>
                </div>
            </div>
            
            <!-- Nodes Page -->
            <div v-if="currentPage === 'nodes'">
                <div class="page-header">
                    <h1 class="page-title">Nodi Proxmox</h1>
                    <p class="page-subtitle">Gestione nodi e connessioni SSH</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista Nodi</h3>
                            <button class="btn btn-primary" @click="showNodeModal = true" v-if="canEdit">+ Aggiungi Nodo</button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                    <tr><th>Nome</th><th>Tipo</th><th>Hostname</th><th>Storage</th><th>Stato</th><th>Tools</th><th>Auth</th><th>Azioni</th></tr>
                            </thead>
                            <tbody>
                                <tr v-for="node in nodes" :key="node.id">
                                    <td>{{ node.name }}</td>
                                    <td>
                                        <span class="badge" :class="node.node_type === 'pbs' ? 'badge-pbs' : 'badge-info'">
                                            {{ node.node_type === 'pbs' ? 'üóÑÔ∏è PBS' : 'üñ•Ô∏è PVE' }}
                                        </span>
                                    </td>
                                    <td>{{ node.hostname }}:{{ node.ssh_port }}</td>
                                    <td>
                                        <span v-if="node.node_type === 'pbs'" class="badge badge-pbs">
                                            üì¶ {{ node.pbs_datastore || 'datastore1' }}
                                        </span>
                                        <span v-else class="badge" :class="node.storage_type === 'btrfs' ? 'badge-btrfs' : 'badge-zfs'">
                                            {{ node.storage_type === 'btrfs' ? 'üì¶ BTRFS' : 'üóÑÔ∏è ZFS' }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge" :class="node.is_online ? 'badge-success' : 'badge-danger'">
                                            <span class="status-dot"></span>
                                            {{ node.is_online ? 'Online' : 'Offline' }}
                                        </span>
                                    </td>
                                        <td>
                                            <span v-if="node.node_type === 'pbs'" class="badge" :class="node.pbs_available ? 'badge-success' : 'badge-warning'">{{ node.pbs_available ? 'PBS ' + (node.pbs_version || 'OK') : 'N/A' }}</span>
                                            <span v-else-if="node.storage_type === 'btrfs'" class="badge" :class="node.btrfs_available ? 'badge-success' : 'badge-warning'">{{ node.btrfs_available ? 'BTRFS OK' : 'N/A' }}</span>
                                            <span v-else class="badge" :class="node.sanoid_installed ? 'badge-success' : 'badge-warning'">{{ node.sanoid_installed ? 'Sanoid OK' : 'N/A' }}</span>
                                        </td>
                                        <td><span v-if="node.is_auth_node" class="badge badge-info">üîê</span></td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" @click="testNode(node)" :disabled="loading">Test</button>
                                            <button class="btn btn-sm" style="background: #3b82f6;" @click="editNode(node)" :disabled="loading" v-if="canEdit">‚úèÔ∏è Modifica</button>
                                            <button v-if="node.node_type !== 'pbs'" class="btn btn-secondary btn-sm" @click="refreshNodeDatasets(node)" :disabled="loading">Refresh</button>
                                            <button v-if="node.node_type !== 'pbs' && node.storage_type !== 'btrfs' && !node.sanoid_installed && canEdit" class="btn btn-primary btn-sm" @click="installSanoid(node)" :disabled="loading">Sanoid</button>
                                            <button v-if="currentUser?.role === 'admin'" class="btn btn-danger btn-sm" @click="deleteNode(node)" :disabled="loading">Elimina</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
                <!-- Snapshots, Sync, VMs, Logs, Settings pages... -->
                <!-- (keeping existing implementation but with auth checks) -->
                
            <!-- Pagina Snapshot rimossa - funzionalit√† migrata nella pagina VM -->
            <!-- 
            <div v-if="currentPage === 'snapshots'">
                ... pagina snapshot rimossa ...
            </div>
            -->
            
            <div v-if="currentPage === 'sync'">
                <div class="page-header">
                    <h1 class="page-title">üîÑ Replica VM</h1>
                    <p class="page-subtitle">Replica completa di Virtual Machine tra nodi Proxmox (ZFS o BTRFS)</p>
                </div>
                
                <!-- Wizard Nuova Replica VM -->
                <div class="card" v-if="!vmReplicaWizard.active && !btrfsWizard.active">
                    <div class="card-header">
                        <h3 class="card-title">Crea Nuova Replica VM</h3>
                    </div>
                    
                    <!-- Sync Method Selector -->
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                        <label class="form-label" style="margin-bottom: 12px;">üîß Metodo di Sincronizzazione</label>
                        <div style="display: flex; gap: 12px;">
                            <label class="sync-method-option" :class="{ active: vmReplicaWizard.syncMethod === 'syncoid' }" @click="vmReplicaWizard.syncMethod = 'syncoid'">
                                <input type="radio" v-model="vmReplicaWizard.syncMethod" value="syncoid" style="display: none;">
                                <div class="sync-method-icon">üóÑÔ∏è</div>
                                <div class="sync-method-title">ZFS / Syncoid</div>
                                <div class="sync-method-desc">Replica con ZFS send/receive tramite Syncoid</div>
                            </label>
                            <label class="sync-method-option" :class="{ active: vmReplicaWizard.syncMethod === 'btrfs_send' }" @click="vmReplicaWizard.syncMethod = 'btrfs_send'">
                                <input type="radio" v-model="vmReplicaWizard.syncMethod" value="btrfs_send" style="display: none;">
                                <div class="sync-method-icon">üì¶</div>
                                <div class="sync-method-title">BTRFS</div>
                                <div class="sync-method-desc">Replica con btrfs send/receive</div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="grid-2" style="padding: 20px;">
                        <div class="form-group">
                            <label class="form-label">üì§ Nodo Sorgente</label>
                            <select class="form-input" v-model="vmReplicaWizard.sourceNodeId" @change="loadSourceVMs">
                                <option value="">Seleziona nodo sorgente</option>
                                <option v-for="n in nodes" :key="n.id" :value="n.id">{{ n.name }} ({{ n.hostname }}) {{ n.storage_type === 'btrfs' ? 'üî∂ BTRFS' : '' }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üì• Nodo Destinazione</label>
                            <select class="form-input" v-model="vmReplicaWizard.destNodeId" @change="loadDestPools">
                                <option value="">Seleziona nodo destinazione</option>
                                <option v-for="n in nodes" :key="n.id" :value="n.id" :disabled="n.id == vmReplicaWizard.sourceNodeId">{{ n.name }} ({{ n.hostname }}) {{ n.storage_type === 'btrfs' ? 'üî∂ BTRFS' : '' }}</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- BTRFS Configuration (shown when BTRFS method selected) -->
                    <div v-if="vmReplicaWizard.syncMethod === 'btrfs_send'" style="padding: 0 20px 20px; border-top: 1px solid var(--border-color); margin-top: 0; padding-top: 20px;">
                        <h4 style="margin-bottom: 12px; color: #ff9f43;">üì¶ Configurazione BTRFS</h4>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Mount Point BTRFS Sorgente</label>
                                <input type="text" class="form-input" v-model="vmReplicaWizard.btrfsMount" placeholder="/mnt/btrfs-storage">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Directory Snapshot</label>
                                <input type="text" class="form-input" v-model="vmReplicaWizard.btrfsSnapshotDir" placeholder="Lascia vuoto per default (.snapshots)">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Max Snapshot da Mantenere</label>
                                <input type="number" class="form-input" v-model.number="vmReplicaWizard.btrfsMaxSnapshots" min="1" max="50">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista VM -->
                    <div v-if="sourceVMs.length > 0" style="padding: 0 20px 20px;">
                        <h4 style="margin-bottom: 12px; color: var(--accent-primary);">üñ•Ô∏è Seleziona VM da Replicare</h4>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>VMID</th><th>Nome</th><th>Tipo</th><th>Stato</th><th>Azione</th></tr></thead>
                                <tbody>
                                    <tr v-for="vm in sourceVMs" :key="vm.vmid">
                                        <td><strong>{{ vm.vmid }}</strong></td>
                                        <td>{{ vm.name }}</td>
                                        <td><span class="badge badge-info">{{ vm.type }}</span></td>
                                        <td><span class="badge" :class="vm.status === 'running' ? 'badge-success' : 'badge-warning'">{{ vm.status }}</span></td>
                                        <td>
                                            <button class="btn btn-primary btn-sm" @click="selectVMForReplica(vm)" :disabled="!vmReplicaWizard.destNodeId">
                                                Configura Replica ‚Üí
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Configurazione Replica VM -->
                <div class="card" v-if="vmReplicaWizard.active">
                    <div class="card-header">
                        <h3 class="card-title">‚öôÔ∏è Configura Replica VM {{ vmReplicaWizard.selectedVM?.vmid }} - {{ vmReplicaWizard.selectedVM?.name }}</h3>
                        <button class="btn btn-secondary" @click="cancelVMReplica">‚Üê Indietro</button>
                    </div>
                    
                    <div style="padding: 20px;">
                        <!-- Info Dischi -->
                        <div v-if="vmReplicaWizard.disks.length > 0">
                            <h4 style="margin-bottom: 12px; color: var(--accent-secondary);">üíæ Dischi da Replicare</h4>
                            <div class="table-container" style="margin-bottom: 20px;">
                                <table>
                                    <thead><tr><th>Disco</th><th>Dataset ZFS</th><th>Dimensione</th><th>Replica</th></tr></thead>
                                    <tbody>
                                        <tr v-for="disk in vmReplicaWizard.disks" :key="disk.disk_name">
                                            <td><strong>{{ disk.disk_name }}</strong></td>
                                            <td><code style="font-size: 0.85rem;">{{ disk.dataset || 'N/A' }}</code></td>
                                            <td><span class="badge badge-info">{{ disk.size }}</span></td>
                                            <td>
                                                <input type="checkbox" v-model="disk.selected" :disabled="!disk.dataset">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                                <strong>üìä Totale:</strong> {{ vmReplicaWizard.disks.filter(d => d.selected).length }} dischi selezionati, 
                                <span style="color: var(--accent-primary);">{{ vmReplicaWizard.totalSize }}</span> da trasferire
                            </div>
                        </div>
                        <div v-else style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            <span v-if="loading">‚è≥ Caricamento dischi...</span>
                            <span v-else>‚ö†Ô∏è Nessun disco ZFS trovato per questa VM</span>
                        </div>
                        
                        <!-- Configurazione Destinazione -->
                        <h4 style="margin: 20px 0 12px; color: var(--accent-warning);">üì• Destinazione</h4>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Pool ZFS Destinazione</label>
                                <select class="form-input" v-model="vmReplicaWizard.destPool">
                                    <option value="">Seleziona pool</option>
                                    <option v-for="pool in destPools" :key="pool" :value="pool">{{ pool }}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sottocartella ZFS</label>
                                <input type="text" class="form-input" v-model="vmReplicaWizard.destSubfolder" placeholder="replica">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nome Storage Proxmox Destinazione 
                                <small style="color: var(--text-secondary);">(verr√† creato automaticamente se non esiste)</small>
                            </label>
                            <input type="text" class="form-input" v-model="vmReplicaWizard.destStorage" :placeholder="vmReplicaWizard.destSubfolder || 'replica-storage'">
                            <small style="color: var(--accent-warning); display: block; margin-top: 4px;">
                                ‚ö†Ô∏è Questo storage verr√† usato nella configurazione della VM replicata
                            </small>
                        </div>
                        <div class="grid-3">
                            <div class="form-group">
                                <label class="form-label">VMID Destinazione <small style="color: var(--text-secondary);">(se diverso)</small></label>
                                <input type="number" class="form-input" v-model="vmReplicaWizard.destVmId" :placeholder="vmReplicaWizard.selectedVM?.vmid">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Suffisso Nome VM</label>
                                <input type="text" class="form-input" v-model="vmReplicaWizard.destVmNameSuffix" placeholder="-replica">
                                <small style="color: var(--text-secondary);">Es: VM "web01" ‚Üí "web01-replica"</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Schedule</label>
                                <select class="form-input" v-model="vmReplicaWizard.schedulePreset" @change="onSchedulePresetChange(vmReplicaWizard)">
                                    <option v-for="preset in schedulePresets" :key="preset.value" :value="preset.value">
                                        {{ preset.label }}
                                    </option>
                                </select>
                                <input v-if="vmReplicaWizard.schedulePreset === 'custom'" type="text" class="form-input" v-model="vmReplicaWizard.schedule" placeholder="es: 0 2 * * *" style="margin-top: 8px;">
                            </div>
                        </div>
                        
                        <!-- Opzioni -->
                        <h4 style="margin: 20px 0 12px; color: var(--accent-info);">‚ö° Opzioni</h4>
                        <div class="grid-3">
                            <div class="form-group">
                                <label class="form-label">Compressione</label>
                                <select class="form-input" v-model="vmReplicaWizard.compress">
                                    <option value="lz4">LZ4 (veloce)</option>
                                    <option value="zstd">ZSTD (bilanciato)</option>
                                    <option value="gzip">GZIP (compatibile)</option>
                                    <option value="none">Nessuna</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üì∏ Versioni da mantenere</label>
                                <input type="number" class="form-input" v-model.number="vmReplicaWizard.keep_snapshots" min="0" max="100">
                                <small style="color: var(--text-secondary);">0 = solo ultima</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px; margin-top: 24px;">
                                    <input type="checkbox" v-model="vmReplicaWizard.registerVM">
                                    Registra VM su destinazione
                                </label>
                            </div>
                        </div>
                        
                        <!-- Notifiche -->
                        <h4 style="margin: 20px 0 12px; color: var(--accent-info);">üìß Notifiche</h4>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Invio Email</label>
                                <select class="form-input" v-model="vmReplicaWizard.notify_mode">
                                    <option value="daily">üìÖ Solo nel riepilogo giornaliero</option>
                                    <option value="always">üì® Ad ogni esecuzione</option>
                                    <option value="failure">‚ö†Ô∏è Solo in caso di errore</option>
                                    <option value="never">üîï Disabilitate</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Soggetto Email</label>
                                <input type="text" class="form-input" v-model="vmReplicaWizard.notify_subject" placeholder="[REPLICA] {vm_name}">
                            </div>
                        </div>
                        
                        <!-- Preview Destinazione -->
                        <div v-if="vmReplicaWizard.destPool" style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-top: 20px;">
                            <h5 style="margin-bottom: 8px;">üìã Anteprima Dataset Destinazione:</h5>
                            <div v-for="disk in vmReplicaWizard.disks.filter(d => d.selected && d.dataset)" :key="disk.disk_name" style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; margin: 4px 0;">
                                {{ disk.disk_name }}: <span style="color: var(--accent-primary);">{{ vmReplicaWizard.destPool }}{{ vmReplicaWizard.destSubfolder ? '/' + vmReplicaWizard.destSubfolder : '' }}/{{ disk.dataset.split('/').pop() }}</span>
                            </div>
                        </div>
                        
                        <!-- Azioni -->
                        <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="btn btn-secondary" @click="cancelVMReplica">Annulla</button>
                            <button class="btn btn-primary" @click="createVMReplica" :disabled="loading || !vmReplicaWizard.destPool || vmReplicaWizard.disks.filter(d => d.selected).length === 0">
                                üöÄ Crea {{ vmReplicaWizard.disks.filter(d => d.selected).length }} Job di Replica
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Job Esistenti Raggruppati per VM -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">üìã Repliche VM Configurate</h3>
                        <button class="btn btn-secondary" @click="loadSyncJobs" :disabled="loading">üîÑ Aggiorna</button>
                    </div>
                    
                    <div v-if="vmGroups.length > 0">
                        <div v-for="group in vmGroups" :key="group.vm_group_id" style="border-bottom: 1px solid var(--border-color); padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div>
                                    <h4 style="color: var(--accent-primary); margin: 0;">
                                        üñ•Ô∏è <strong>{{ group.vm_name || `VM ${group.vm_id}` }}</strong> <span style="color: var(--text-secondary); font-size: 0.9em;">(ID: {{ group.vm_id }})</span>
                                        <span v-if="group.dest_vm_id && group.dest_vm_id != group.vm_id" style="color: var(--text-secondary);"> ‚Üí VM {{ group.dest_vm_id }}</span>
                                        <span class="badge" :class="group.sync_method === 'btrfs_send' ? 'badge-btrfs' : 'badge-zfs'" style="margin-left: 8px; font-size: 0.7rem;">
                                            {{ group.sync_method === 'btrfs_send' ? 'üì¶ BTRFS' : 'üóÑÔ∏è ZFS' }}
                                        </span>
                                    </h4>
                                    <small style="color: var(--text-secondary);">
                                        {{ group.jobs.length }} dischi ‚Ä¢ {{ group.source_node }} ‚Üí {{ group.dest_node }} ‚Ä¢ 
                                        <span v-if="group.schedule">‚è∞ {{ group.schedule }}</span>
                                        <span v-else>Manuale</span>
                                        <span v-if="group.last_sync_type"> ‚Ä¢ {{ group.last_sync_type }}</span>
                                    </small>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-primary btn-sm" @click="runVMGroup(group.vm_group_id)" :disabled="loading" title="Esegui tutti">‚ñ∂ Run All</button>
                                    <button class="btn btn-secondary btn-sm" @click="showGroupSnapshots(group)" :disabled="loading" title="Vedi Snapshot">üì∑ Snapshot</button>
                                    <button class="btn btn-info btn-sm" @click="registerVMGroup(group)" :disabled="loading" v-if="group.register_vm" title="Registra VM">üìã Registra</button>
                                    <button class="btn btn-danger btn-sm" @click="deleteVMGroup(group.vm_group_id)" :disabled="loading" title="Elimina gruppo">üóëÔ∏è</button>
                                </div>
                            </div>
                            
                            <!-- Mini tabella dischi -->
                            <table style="width: 100%; font-size: 0.85rem;">
                                <thead><tr><th>Disco</th><th>Dataset</th><th>Stato</th><th>Ultimo Run</th><th>Azioni</th></tr></thead>
                                <tbody>
                                    <tr v-for="job in group.jobs" :key="job.id">
                                        <td>{{ job.disk_name || 'disk' }}</td>
                                        <td style="font-family: 'JetBrains Mono', monospace;">{{ job.source_dataset.split('/').pop() }}</td>
                                        <td><span class="badge" :class="getStatusClass(job.last_status)">{{ job.last_status || 'N/A' }}</span></td>
                                        <td>{{ job.last_run ? formatDate(job.last_run) : '-' }}</td>
                                        <td>
                                            <button class="btn btn-primary btn-sm" @click="runSyncJob(job)" :disabled="loading" title="Esegui" style="padding: 2px 6px;">‚ñ∂</button>
                                            <button class="btn btn-secondary btn-sm" @click="viewJobSnapshots(job)" :disabled="loading" title="Versioni" style="padding: 2px 6px;">üì∏</button>
                                            <button class="btn btn-secondary btn-sm" @click="editSyncJob(job)" :disabled="loading" title="Modifica" style="padding: 2px 6px;">‚úèÔ∏è</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Job Singoli (senza gruppo) -->
                    <div v-if="singleJobs.length > 0" style="padding: 16px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 12px;">üìÅ Job Singoli (Legacy)</h4>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Nome</th><th>Sorgente</th><th>Destinazione</th><th>Stato</th><th>Azioni</th></tr></thead>
                                <tbody>
                                    <tr v-for="job in singleJobs" :key="job.id">
                                        <td>{{ job.name }}</td>
                                        <td>{{ job.source_dataset }}</td>
                                        <td>{{ job.dest_dataset }}</td>
                                        <td><span class="badge" :class="getStatusClass(job.last_status)">{{ job.last_status || 'N/A' }}</span></td>
                                        <td>
                                            <button class="btn btn-primary btn-sm" @click="runSyncJob(job)" :disabled="loading" title="Esegui">‚ñ∂</button>
                                            <button class="btn btn-secondary btn-sm" @click="viewJobSnapshots(job)" :disabled="loading" title="Versioni">üì∏</button>
                                            <button class="btn btn-secondary btn-sm" @click="editSyncJob(job)" :disabled="loading" title="Modifica">‚úèÔ∏è</button>
                                            <button class="btn btn-danger btn-sm" @click="deleteSyncJob(job)" :disabled="loading" title="Elimina">‚úï</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div v-if="vmGroups.length === 0 && singleJobs.length === 0" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                        Nessuna replica configurata. Seleziona una VM sopra per iniziare.
                    </div>
                </div>
            </div>
            
            <!-- Backup Jobs (PBS) Page -->
            <div v-if="currentPage === 'backup'">
                <div class="page-header">
                    <h1 class="page-title">üì¶ Backup Jobs (PBS)</h1>
                    <p class="page-subtitle">Backup automatici VM verso Proxmox Backup Server</p>
                </div>
                
                <!-- Info Box -->
                <div class="card" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(3, 169, 244, 0.1)); border-color: #2196f3;">
                    <div style="display: flex; gap: 16px; align-items: flex-start;">
                        <div style="font-size: 2rem;">‚òÅÔ∏è</div>
                        <div>
                            <h3 style="color: #64b5f6; margin-bottom: 8px;">Backup verso PBS</h3>
                            <p style="color: var(--text-secondary); line-height: 1.6;">
                                Configura backup schedulati delle tue VM verso Proxmox Backup Server.<br>
                                <strong>Funzionalit√†:</strong> Backup incrementali ‚Ä¢ Compressione ‚Ä¢ Retention policy ‚Ä¢ Notifiche
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ backupJobs.length }}</div>
                        <div class="stat-label">Backup Jobs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ backupJobs.filter(j => j.is_active).length }}</div>
                        <div class="stat-label">Attivi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ backupJobs.filter(j => j.last_status === 'success').length }}</div>
                        <div class="stat-label">Ultimi OK</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ backupJobs.filter(j => j.last_status === 'failed').length }}</div>
                        <div class="stat-label">Falliti</div>
                    </div>
                </div>
                
                <!-- Nuovo Backup Job -->
                <div class="card">
                    <h3 class="card-title">‚ûï Nuovo Backup Job</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label class="form-label">Nome Job</label>
                            <input type="text" class="form-input" v-model="newBackupJob.name" placeholder="es: Backup-VM-Web">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nodo Sorgente (PVE)</label>
                            <select class="form-input" v-model="newBackupJob.source_node_id" @change="loadSourceVmsForBackup">
                                <option value="">-- Seleziona --</option>
                                <option v-for="node in pveNodes" :key="node.id" :value="node.id">{{ node.name }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">VM da backuppare</label>
                            <select class="form-input" v-model="newBackupJob.vm_id" @change="selectBackupVm">
                                <option value="">-- Seleziona VM --</option>
                                <option v-for="vm in sourceVmsForBackup" :key="vm.vmid" :value="vm.vmid">
                                    {{ vm.vmid }} - {{ vm.name || 'VM' }} ({{ vm.type }})
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="grid-3">
                        <div class="form-group">
                            <label class="form-label">Nodo PBS Destinazione</label>
                            <select class="form-input" v-model="newBackupJob.pbs_node_id">
                                <option value="">-- Seleziona PBS --</option>
                                <option v-for="node in pbsNodes" :key="node.id" :value="node.id">{{ node.name }} ({{ node.hostname }})</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Storage PBS (sul nodo sorgente)</label>
                            <select class="form-input" v-model="newBackupJob.pbs_storage_id" v-if="backupPbsStorages.length > 0">
                                <option value="">-- Seleziona Storage PBS --</option>
                                <option v-for="st in backupPbsStorages" :key="st.storage" :value="st.storage">
                                    {{ st.storage }} ({{ st.server || 'PBS' }})
                                </option>
                            </select>
                            <input type="text" class="form-input" v-model="newBackupJob.pbs_storage_id" placeholder="es: pbs-backup" v-else>
                            <small style="color: var(--text-secondary);" v-if="backupPbsStorages.length === 0 && newBackupJob.source_node_id">
                                Nessuno storage PBS trovato sul nodo. Inserisci manualmente.
                            </small>
                            <small style="color: var(--text-secondary);" v-else-if="!newBackupJob.source_node_id">
                                Seleziona prima il nodo sorgente
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Modalit√† Backup</label>
                            <select class="form-input" v-model="newBackupJob.backup_mode">
                                <option value="snapshot">Snapshot (Live)</option>
                                <option value="stop">Stop (Arresto VM)</option>
                                <option value="suspend">Suspend</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Schedule</label>
                            <select class="form-input" v-model="newBackupJob.schedulePreset" @change="onSchedulePresetChange(newBackupJob)">
                                <option v-for="preset in schedulePresets" :key="preset.value" :value="preset.value">
                                    {{ preset.label }}
                                </option>
                            </select>
                            <input v-if="newBackupJob.schedulePreset === 'custom'" type="text" class="form-input" v-model="newBackupJob.schedule" placeholder="es: 0 2 * * * (cron)" style="margin-top: 8px;">
                        </div>
                    </div>
                    <div class="grid-3">
                        <div class="form-group">
                            <label class="form-label">Mantieni ultimi N backup</label>
                            <input type="number" class="form-input" v-model="newBackupJob.keep_last" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Compressione</label>
                            <select class="form-input" v-model="newBackupJob.backup_compress">
                                <option value="zstd">ZSTD (Consigliato)</option>
                                <option value="lzo">LZO (Veloce)</option>
                                <option value="gzip">GZIP</option>
                                <option value="none">Nessuna</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Soggetto Email</label>
                            <input type="text" class="form-input" v-model="newBackupJob.notify_subject" placeholder="[BACKUP] {vm_name}">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Notifiche Email</label>
                            <select class="form-input" v-model="newBackupJob.notify_mode">
                                <option value="daily">üìÖ Solo nel riepilogo giornaliero</option>
                                <option value="always">üì® Ad ogni esecuzione</option>
                                <option value="failure">‚ö†Ô∏è Solo in caso di errore</option>
                                <option value="never">üîï Disabilitate</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" @click="createBackupJob" :disabled="!newBackupJob.name || !newBackupJob.source_node_id || !newBackupJob.vm_id || !newBackupJob.pbs_node_id">
                                ‚ûï Crea Backup Job
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Lista Backup Jobs -->
                <div class="card">
                    <h3 class="card-title">üìã Backup Jobs Configurati</h3>
                    <table class="table" v-if="backupJobs.length > 0">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>VM</th>
                                <th>PBS</th>
                                <th>Schedule</th>
                                <th>Ultimo Backup</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="job in backupJobs" :key="job.id">
                                <td>
                                    <strong>{{ job.name }}</strong>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">
                                        {{ job.backup_mode }} ‚Ä¢ {{ job.backup_compress }}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-info">{{ job.vm_type?.toUpperCase() }} #{{ job.vm_id }}</span>
                                    <div v-if="job.vm_name" style="font-size: 0.85em;">{{ job.vm_name }}</div>
                                </td>
                                <td>{{ job.pbs_node_name || 'N/A' }}</td>
                                <td>
                                    <span v-if="job.schedule" class="badge badge-primary">{{ formatSchedule(job.schedule) }}</span>
                                    <span v-else class="badge badge-secondary">Manuale</span>
                                </td>
                                <td>
                                    <div v-if="job.last_backup_time">
                                        {{ formatDate(job.last_backup_time) }}
                                        <div style="font-size: 0.85em; color: var(--text-secondary);">
                                            {{ job.last_duration ? job.last_duration + 's' : '' }}
                                        </div>
                                    </div>
                                    <span v-else style="color: var(--text-secondary);">Mai</span>
                                </td>
                                <td>
                                    <span v-if="job.current_status === 'running'" class="badge badge-warning">‚è≥ In corso</span>
                                    <span v-else-if="job.last_status === 'success'" class="badge badge-success">‚úì OK</span>
                                    <span v-else-if="job.last_status === 'failed'" class="badge badge-error">‚úó Fallito</span>
                                    <span v-else class="badge badge-secondary">-</span>
                                    <div v-if="!job.is_active" style="font-size: 0.8em; color: var(--text-secondary);">‚è∏Ô∏è Disattivato</div>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 4px;">
                                        <button class="btn btn-sm btn-primary" @click="runBackupJob(job.id)" :disabled="job.current_status === 'running'" title="Esegui ora">‚ñ∂Ô∏è</button>
                                        <button class="btn btn-sm btn-secondary" @click="editBackupJob(job)" title="Modifica">‚úèÔ∏è</button>
                                        <button class="btn btn-sm btn-error" @click="deleteBackupJob(job.id)" title="Elimina">üóëÔ∏è</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div v-else style="padding: 40px; text-align: center; color: var(--text-secondary);">
                        Nessun backup job configurato. Crea il primo backup sopra.
                    </div>
                </div>
            </div>
            
            <!-- Edit Backup Job Modal -->
            <div class="modal-overlay" v-if="showEditBackupJobModal && editingBackupJob" @click.self="showEditBackupJobModal = false">
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">‚úèÔ∏è Modifica Backup Job</h3>
                        <button class="btn btn-icon btn-secondary" @click="showEditBackupJobModal = false">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Nome Job</label>
                            <input type="text" class="form-input" v-model="editingBackupJob.name">
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Modalit√†</label>
                                <select class="form-input" v-model="editingBackupJob.backup_mode">
                                    <option value="snapshot">Snapshot</option>
                                    <option value="stop">Stop</option>
                                    <option value="suspend">Suspend</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Compressione</label>
                                <select class="form-input" v-model="editingBackupJob.backup_compress">
                                    <option value="zstd">ZSTD</option>
                                    <option value="lzo">LZO</option>
                                    <option value="gzip">GZIP</option>
                                    <option value="none">Nessuna</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Mantieni ultimi N</label>
                                <input type="number" class="form-input" v-model="editingBackupJob.keep_last" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Schedule</label>
                                <select class="form-input" v-model="editingBackupJob.schedulePreset" @change="onSchedulePresetChange(editingBackupJob)">
                                    <option v-for="preset in schedulePresets" :key="preset.value" :value="preset.value">
                                        {{ preset.label }}
                                    </option>
                                </select>
                                <input v-if="editingBackupJob.schedulePreset === 'custom'" type="text" class="form-input" v-model="editingBackupJob.schedule" placeholder="cron" style="margin-top: 8px;">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">üìß Notifiche Email</label>
                                <select class="form-input" v-model="editingBackupJob.notify_mode">
                                    <option value="daily">üìÖ Solo nel riepilogo giornaliero</option>
                                    <option value="always">üì® Ad ogni esecuzione</option>
                                    <option value="failure">‚ö†Ô∏è Solo in caso di errore</option>
                                    <option value="never">üîï Disabilitate</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Soggetto Email</label>
                                <input type="text" class="form-input" v-model="editingBackupJob.notify_subject" placeholder="[BACKUP] {vm_name}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" v-model="editingBackupJob.is_active">
                                <span :style="{ color: editingBackupJob.is_active ? 'var(--accent-primary)' : 'var(--text-secondary)' }">
                                    {{ editingBackupJob.is_active ? '‚úÖ Job Attivo' : '‚è∏Ô∏è Job Disattivato' }}
                                </span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="showEditBackupJobModal = false">Annulla</button>
                        <button class="btn btn-primary" @click="saveBackupJob">üíæ Salva</button>
                    </div>
                </div>
            </div>
            
            <!-- Recovery Jobs (PBS) Page -->
            <div v-if="currentPage === 'recovery'">
                <div class="page-header">
                    <h1 class="page-title">üîÑ Recovery Jobs (PBS)</h1>
                    <p class="page-subtitle">Replica basata su backup Proxmox Backup Server - per filesystem non supportati (LVM, local, etc.)</p>
                </div>
                
                <!-- Info Box -->
                <div class="card" style="background: linear-gradient(135deg, rgba(156, 39, 176, 0.1), rgba(103, 58, 183, 0.1)); border-color: #9c27b0;">
                    <div style="display: flex; gap: 16px; align-items: flex-start;">
                        <div style="font-size: 2rem;">üí°</div>
                        <div>
                            <h3 style="color: #ce93d8; margin-bottom: 8px;">Come funziona la Recovery PBS</h3>
                            <p style="color: var(--text-secondary); line-height: 1.6;">
                                Questa funzionalit√† permette di replicare VM anche con storage non supportati da ZFS/BTRFS (es. LVM, local, etc.).<br>
                                <strong>Workflow:</strong> 1Ô∏è‚É£ Backup VM sorgente ‚Üí PBS  2Ô∏è‚É£ Restore automatico su nodo destinazione  3Ô∏è‚É£ Registrazione VM
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ recoveryJobs.length }}</div>
                        <div class="stat-label">Recovery Jobs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ recoveryJobs.filter(j => j.is_active).length }}</div>
                        <div class="stat-label">Attivi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ pbsNodes.length }}</div>
                        <div class="stat-label">Nodi PBS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ recoveryJobs.filter(j => j.last_status === 'success').length }}</div>
                        <div class="stat-label">Completati OK</div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚ö° Azioni Rapide</div>
                        <button class="btn btn-primary" @click="showAddRecoveryJobModal = true">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Nuovo Recovery Job
                        </button>
                    </div>
                    
                    <!-- PBS Nodes Status -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="margin-bottom: 12px; color: var(--text-secondary);">üóÑÔ∏è Nodi PBS Disponibili</h4>
                        <div v-if="pbsNodes.length === 0" style="color: var(--text-secondary); padding: 20px; text-align: center; background: var(--bg-tertiary); border-radius: 8px;">
                            Nessun nodo PBS configurato. 
                            <a href="#" @click.prevent="currentPage = 'nodes'" style="color: var(--accent-primary);">Aggiungi un nodo PBS</a>
                        </div>
                        <div v-else class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Hostname</th>
                                        <th>Datastore</th>
                                        <th>Stato</th>
                                        <th>Versione</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="node in pbsNodes" :key="node.id">
                                        <td><strong>{{ node.name }}</strong></td>
                                        <td>{{ node.hostname }}</td>
                                        <td>{{ node.pbs_datastore || 'datastore1' }}</td>
                                        <td>
                                            <span class="badge" :class="node.pbs_available ? 'badge-success' : 'badge-danger'">
                                                {{ node.pbs_available ? '‚óè Online' : '‚óã Offline' }}
                                            </span>
                                        </td>
                                        <td>{{ node.pbs_version || '-' }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" @click="testPbsNode(node.id)">
                                                Test
                                            </button>
                                            <button class="btn btn-sm btn-primary" @click="browsePbsBackups(node.id)" style="margin-left: 4px;">
                                                üìÇ Sfoglia
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Browse PBS Backups Section -->
                    <div v-if="pbsBrowseData.nodeId" style="margin-top: 24px; padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4 style="color: var(--accent-primary);">üìÇ Backup su {{ pbsBrowseData.nodeName }}</h4>
                            <button class="btn btn-sm btn-secondary" @click="pbsBrowseData.nodeId = null">‚úï Chiudi</button>
                        </div>
                        
                        <div v-if="pbsBrowseData.loading" style="text-align: center; padding: 20px;">
                            <span class="badge badge-warning">‚è≥ Caricamento backup...</span>
                        </div>
                        
                        <div v-else-if="pbsBrowseData.backups.length === 0" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            Nessun backup trovato sul datastore {{ pbsBrowseData.datastore }}
                        </div>
                        
                        <div v-else>
                            <p style="margin-bottom: 12px; color: var(--text-secondary);">
                                Trovati <strong>{{ pbsBrowseData.backups.length }}</strong> backup sul datastore <strong>{{ pbsBrowseData.datastore }}</strong>
                            </p>
                            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>VM/CT</th>
                                            <th>Tipo</th>
                                            <th>Backup ID</th>
                                            <th>Data</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="backup in pbsBrowseData.backups" :key="backup['backup-id']">
                                            <td>
                                                <strong>{{ extractVmIdFromBackup(backup['backup-id']) }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge badge-info">{{ extractTypeFromBackup(backup['backup-id']) }}</span>
                                            </td>
                                            <td style="font-size: 0.85em; font-family: monospace;">
                                                {{ backup['backup-id'] }}
                                            </td>
                                            <td>{{ formatBackupDate(backup['backup-id']) }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary" @click="createRecoveryFromPbsBackup(backup)">
                                                    üîÑ Restore
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recovery Jobs List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìã Recovery Jobs Configurati</div>
                        <button class="btn btn-sm btn-secondary" @click="loadRecoveryJobs">
                            üîÑ Aggiorna
                        </button>
                    </div>
                    
                    <div v-if="recoveryJobs.length === 0" style="color: var(--text-secondary); padding: 40px; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">üì¶</div>
                        <p>Nessun recovery job configurato.</p>
                        <p style="margin-top: 8px;">Crea un nuovo job per iniziare la replica basata su backup.</p>
                    </div>
                    
                    <div v-else class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>VM</th>
                                    <th>Sorgente ‚Üí PBS ‚Üí Dest</th>
                                    <th>Schedule</th>
                                    <th>Ultimo Run</th>
                                    <th>Durate</th>
                                    <th>Stato</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="job in recoveryJobs" :key="job.id">
                                    <td>
                                        <strong>{{ job.name }}</strong>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                            {{ job.backup_mode }} / {{ job.backup_compress }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge badge-info">{{ job.vm_type.toUpperCase() }} #{{ job.vm_id }}</span>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">
                                            <strong>{{ job.vm_name || `VM ${job.vm_id}` }}</strong>
                                        </div>
                                    </td>
                                    <td style="font-size: 0.8rem;">
                                        {{ getNodeName(job.source_node_id) }} ‚Üí 
                                        <span style="color: #ce93d8;">{{ getNodeName(job.pbs_node_id) }}</span> ‚Üí 
                                        {{ getNodeName(job.dest_node_id) }}
                                    </td>
                                    <td>
                                        <code v-if="job.schedule">{{ job.schedule }}</code>
                                        <span v-else style="color: var(--text-secondary);">Manuale</span>
                                    </td>
                                    <td>
                                        <span v-if="job.last_run">{{ formatDate(job.last_run) }}</span>
                                        <span v-else style="color: var(--text-secondary);">Mai</span>
                                    </td>
                                    <td style="font-size: 0.8rem;">
                                        <div v-if="job.last_backup_duration || job.last_restore_duration">
                                            <div v-if="job.last_backup_duration" style="margin-bottom: 4px;">
                                                <span style="color: #6c757d;">üì¶ Backup:</span>
                                                <strong>{{ Math.floor(job.last_backup_duration / 60) }}m {{ job.last_backup_duration % 60 }}s</strong>
                                            </div>
                                            <div v-if="job.last_restore_duration">
                                                <span style="color: #6c757d;">üîÑ Restore:</span>
                                                <strong>{{ Math.floor(job.last_restore_duration / 60) }}m {{ job.last_restore_duration % 60 }}s</strong>
                                            </div>
                                        </div>
                                        <span v-else style="color: var(--text-secondary);">-</span>
                                    </td>
                                    <td>
                                        <!-- Status Indicator Migliorato -->
                                        <div class="status-indicator">
                                            <!-- In esecuzione -->
                                            <div v-if="job.current_status === 'backing_up'" class="status-running">
                                                <span class="status-icon pulse">üì¶</span>
                                                <span class="status-text">Backup in corso...</span>
                                                <div class="progress-bar-container"><div class="progress-bar"></div></div>
                                            </div>
                                            <div v-else-if="job.current_status === 'restoring'" class="status-running">
                                                <span class="status-icon pulse">üîÑ</span>
                                                <span class="status-text">Restore in corso...</span>
                                                <div class="progress-bar-container"><div class="progress-bar"></div></div>
                                            </div>
                                            <div v-else-if="job.current_status === 'registering'" class="status-running">
                                                <span class="status-icon pulse">üìù</span>
                                                <span class="status-text">Registrazione...</span>
                                            </div>
                                            <!-- Completato -->
                                            <div v-else-if="job.last_status === 'success'" class="status-success">
                                                <span class="status-icon">‚úÖ</span>
                                                <span class="status-text">Completato</span>
                                                <small v-if="job.last_duration" style="display: block; color: var(--text-secondary);">
                                                    {{ Math.floor(job.last_duration / 60) }}m {{ job.last_duration % 60 }}s
                                                </small>
                                            </div>
                                            <!-- Fallito -->
                                            <div v-else-if="job.last_status === 'failed'" class="status-failed">
                                                <span class="status-icon">‚ùå</span>
                                                <span class="status-text">Fallito</span>
                                                <small v-if="job.consecutive_failures > 1" style="display: block; color: var(--accent-danger);">
                                                    {{ job.consecutive_failures }} tentativi
                                                </small>
                                            </div>
                                            <!-- Mai eseguito -->
                                            <div v-else class="status-pending">
                                                <span class="status-icon">‚è∏Ô∏è</span>
                                                <span class="status-text">In attesa</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn btn-sm btn-primary" @click="runRecoveryJob(job.id)" 
                                                    :disabled="['backing_up', 'restoring', 'registering'].includes(job.current_status)"
                                                    :class="{'btn-pulse': ['backing_up', 'restoring', 'registering'].includes(job.current_status)}">
                                                <span v-if="['backing_up', 'restoring', 'registering'].includes(job.current_status)">‚è≥</span>
                                                <span v-else>‚ñ∂</span> Esegui
                                            </button>
                                            <button class="btn btn-sm btn-secondary" @click="editRecoveryJob(job)">
                                                ‚úèÔ∏è
                                            </button>
                                            <button class="btn btn-sm btn-danger" @click="deleteRecoveryJob(job.id)">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Add Recovery Job Modal -->
            <div class="modal-overlay" v-if="showAddRecoveryJobModal" @click.self="showAddRecoveryJobModal = false">
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">‚ûï Nuovo Recovery Job (PBS)</h3>
                        <button class="btn btn-icon btn-secondary" @click="showAddRecoveryJobModal = false">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Nome Job</label>
                            <input type="text" class="form-input" v-model="newRecoveryJob.name" placeholder="es: Recovery VM-100 Daily">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label class="form-label">üñ•Ô∏è Nodo Sorgente (PVE)</label>
                                <select class="form-input" v-model="newRecoveryJob.source_node_id" @change="loadSourceVms">
                                    <option value="">-- Seleziona --</option>
                                    <option v-for="node in pveNodes" :key="node.id" :value="node.id">{{ node.name }}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üéØ VM da Replicare</label>
                                <select class="form-input" v-model="newRecoveryJob.vm_id">
                                    <option value="">-- Seleziona VM --</option>
                                    <option v-for="vm in sourceVmsForRecovery" :key="vm.vmid" :value="vm.vmid">
                                        {{ vm.vmid }} - {{ vm.name }} ({{ vm.type }})
                                    </option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label class="form-label">üóÑÔ∏è Nodo PBS (Backup Server)</label>
                                <select class="form-input" v-model="newRecoveryJob.pbs_node_id">
                                    <option value="">-- Seleziona PBS --</option>
                                    <option v-for="node in pbsNodes" :key="node.id" :value="node.id">{{ node.name }} ({{ node.hostname }})</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üíæ Storage PBS su Sorgente</label>
                                <select class="form-input" v-model="newRecoveryJob.pbs_storage_id" :disabled="!sourcePbsStorages.length">
                                    <option value="">-- Auto (crea nuovo) --</option>
                                    <option v-for="s in sourcePbsStorages" :key="s.name" :value="s.name">
                                        {{ s.name }} {{ s.server ? '‚Üí ' + s.server : '' }}
                                    </option>
                                </select>
                                <small v-if="newRecoveryJob.source_node_id && !sourcePbsStorages.length" style="color: var(--text-secondary);">
                                    Nessuno storage PBS configurato sul nodo sorgente
                                </small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üìç Nodo Destinazione (PVE)</label>
                            <select class="form-input" v-model="newRecoveryJob.dest_node_id" @change="loadDestStorages">
                                <option value="">-- Seleziona --</option>
                                <option v-for="node in pveNodes" :key="node.id" :value="node.id">{{ node.name }}</option>
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label class="form-label">Storage Destinazione</label>
                                <select class="form-input" v-model="newRecoveryJob.dest_storage" :disabled="!destStorages.length">
                                    <option value="">-- Seleziona Storage --</option>
                                    <option v-for="s in destStorages" :key="s.name" :value="s.name">
                                        {{ s.name }} ({{ s.type }})
                                    </option>
                                </select>
                                <small v-if="destStorages.length === 0 && newRecoveryJob.dest_node_id" style="color: var(--text-secondary);">
                                    Caricamento storage...
                                </small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">VMID Destinazione</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" class="form-input" v-model="newRecoveryJob.dest_vm_id" 
                                           :placeholder="newRecoveryJob.vm_id || 'Stesso della sorgente'"
                                           @blur="checkDestVmid"
                                           style="flex: 1;">
                                    <button class="btn btn-sm btn-secondary" @click="checkDestVmid" :disabled="!newRecoveryJob.dest_node_id" title="Verifica disponibilit√†">
                                        üîç
                                    </button>
                                </div>
                                <small v-if="vmidCheckResult" 
                                       :style="{ color: vmidCheckResult.available ? 'var(--accent-primary)' : 'var(--accent-danger)' }">
                                    {{ vmidCheckResult.message }}
                                </small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üè∑Ô∏è Suffisso Nome VM <small style="color: var(--text-secondary);">(aggiunto al nome originale)</small></label>
                            <input type="text" class="form-input" v-model="newRecoveryJob.dest_vm_name_suffix" placeholder="es: -replica, -dr, -backup">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label class="form-label">Modalit√† Backup</label>
                                <select class="form-input" v-model="newRecoveryJob.backup_mode">
                                    <option value="snapshot">Snapshot (Live)</option>
                                    <option value="stop">Stop (Arresto VM)</option>
                                    <option value="suspend">Suspend (Sospensione)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Compressione</label>
                                <select class="form-input" v-model="newRecoveryJob.backup_compress">
                                    <option value="zstd">ZSTD (Consigliato)</option>
                                    <option value="lzo">LZO (Veloce)</option>
                                    <option value="gzip">GZIP</option>
                                    <option value="none">Nessuna</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">‚è∞ Schedule</label>
                                <select class="form-input" v-model="newRecoveryJob.schedulePreset" @change="onSchedulePresetChange(newRecoveryJob)">
                                    <option v-for="preset in schedulePresets" :key="preset.value" :value="preset.value">
                                        {{ preset.label }}
                                    </option>
                                </select>
                                <input v-if="newRecoveryJob.schedulePreset === 'custom'" type="text" class="form-input" v-model="newRecoveryJob.schedule" placeholder="es: 0 2 * * *" style="margin-top: 8px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">üìß Notifiche Email</label>
                                <select class="form-input" v-model="newRecoveryJob.notify_mode">
                                    <option value="daily">üìÖ Solo nel riepilogo giornaliero</option>
                                    <option value="always">üì® Ad ogni esecuzione</option>
                                    <option value="failure">‚ö†Ô∏è Solo in caso di errore</option>
                                    <option value="never">üîï Disabilitate</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Soggetto Email</label>
                            <input type="text" class="form-input" v-model="newRecoveryJob.notify_subject" placeholder="[REPLICA PBS] {vm_name}">
                        </div>
                        
                        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 16px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" v-model="newRecoveryJob.restore_start_vm">
                                Avvia VM dopo restore
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" v-model="newRecoveryJob.overwrite_existing">
                                Sovrascrivi se esiste
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="showAddRecoveryJobModal = false">Annulla</button>
                        <button class="btn btn-primary" @click="createRecoveryJob">Crea Recovery Job</button>
                    </div>
                </div>
            </div>
            
            <!-- Edit Recovery Job Modal -->
            <div class="modal-overlay" v-if="showEditRecoveryJobModal && editingRecoveryJob" @click.self="showEditRecoveryJobModal = false">
                <div class="modal" style="max-width: 550px;">
                    <div class="modal-header">
                        <h3 class="modal-title">‚úèÔ∏è Modifica Recovery Job</h3>
                        <button class="btn btn-icon btn-secondary" @click="showEditRecoveryJobModal = false">‚úï</button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <!-- Info Base -->
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin-bottom: 12px; color: var(--accent-primary);">üìã Informazioni Base</h4>
                            <div class="form-group">
                                <label class="form-label">Nome Job</label>
                                <input type="text" class="form-input" v-model="editingRecoveryJob.name">
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">VM Sorgente</label>
                                    <input type="text" class="form-input" :value="editingRecoveryJob.vm_type?.toUpperCase() + ' #' + editingRecoveryJob.vm_id + (editingRecoveryJob.vm_name ? ' - ' + editingRecoveryJob.vm_name : '')" disabled>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Storage PBS</label>
                                    <input type="text" class="form-input" v-model="editingRecoveryJob.pbs_storage_id" placeholder="es: PBS-BACK">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Destinazione -->
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin-bottom: 12px; color: var(--accent-secondary);">üìç Destinazione</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">VMID Destinazione</label>
                                    <input type="number" class="form-input" v-model="editingRecoveryJob.dest_vm_id" :placeholder="editingRecoveryJob.vm_id || 'Stesso'">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Storage Dischi</label>
                                    <input type="text" class="form-input" v-model="editingRecoveryJob.dest_storage" placeholder="es: local-lvm, zfs">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üè∑Ô∏è Suffisso Nome VM</label>
                                <input type="text" class="form-input" v-model="editingRecoveryJob.dest_vm_name_suffix" placeholder="es: -replica, -dr">
                                <small style="color: var(--text-secondary);">Aggiunto al nome originale della VM</small>
                            </div>
                        </div>
                        
                        <!-- Opzioni Backup -->
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin-bottom: 12px; color: var(--accent-warning);">üì¶ Opzioni Backup</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">Modalit√†</label>
                                    <select class="form-input" v-model="editingRecoveryJob.backup_mode">
                                        <option value="snapshot">Snapshot (Live)</option>
                                        <option value="stop">Stop (Arresto VM)</option>
                                        <option value="suspend">Suspend (Sospensione)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Compressione</label>
                                    <select class="form-input" v-model="editingRecoveryJob.backup_compress">
                                        <option value="zstd">ZSTD (Consigliato)</option>
                                        <option value="lzo">LZO (Veloce)</option>
                                        <option value="gzip">GZIP</option>
                                        <option value="none">Nessuna</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Opzioni Restore -->
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin-bottom: 12px; color: var(--accent-primary);">üîÑ Opzioni Restore</h4>
                            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" v-model="editingRecoveryJob.restore_start_vm">
                                    Avvia VM dopo restore
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" v-model="editingRecoveryJob.overwrite_existing">
                                    Sovrascrivi se esiste
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" v-model="editingRecoveryJob.restore_unique">
                                    UUID unici
                                </label>
                            </div>
                            
                        </div>
                        
                        <!-- Scheduling & Notifiche -->
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin-bottom: 12px; color: var(--text-secondary);">‚è∞ Scheduling & Notifiche</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">Schedule</label>
                                    <select class="form-input" v-model="editingRecoveryJob.schedulePreset" @change="onSchedulePresetChange(editingRecoveryJob)">
                                        <option v-for="preset in schedulePresets" :key="preset.value" :value="preset.value">
                                            {{ preset.label }}
                                        </option>
                                    </select>
                                    <input v-if="editingRecoveryJob.schedulePreset === 'custom'" type="text" class="form-input" v-model="editingRecoveryJob.schedule" placeholder="es: 0 2 * * *" style="margin-top: 8px;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">üìß Notifiche Email</label>
                                    <select class="form-input" v-model="editingRecoveryJob.notify_mode">
                                        <option value="daily">üìÖ Solo nel riepilogo giornaliero</option>
                                        <option value="always">üì® Ad ogni esecuzione</option>
                                        <option value="failure">‚ö†Ô∏è Solo in caso di errore</option>
                                        <option value="never">üîï Disabilitate</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">Soggetto Email</label>
                                    <input type="text" class="form-input" v-model="editingRecoveryJob.notify_subject" placeholder="[REPLICA PBS] {vm_name}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Stato Job</label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-top: 8px;">
                                        <input type="checkbox" v-model="editingRecoveryJob.is_active">
                                        <span :style="{ color: editingRecoveryJob.is_active ? 'var(--accent-primary)' : 'var(--text-secondary)' }">
                                            {{ editingRecoveryJob.is_active ? '‚úÖ Job Attivo' : '‚è∏Ô∏è Job Disattivato' }}
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="showEditRecoveryJobModal = false">Annulla</button>
                        <button class="btn btn-primary" @click="saveRecoveryJob">üíæ Salva Modifiche</button>
                    </div>
                </div>
            </div>
            
            <!-- PAGINA RESTORE PBS -->
            <div v-if="currentPage === 'restore'">
                <div class="page-header">
                    <h1 class="page-title">üîÑ Restore da PBS</h1>
                    <p class="page-subtitle">Sfoglia e ripristina backup esistenti da Proxmox Backup Server</p>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">üìÇ Seleziona Server PBS</h3>
                    <p style="color: #9ca3af; margin-bottom: 1rem;">Seleziona un nodo PBS per visualizzare i backup disponibili e procedere al restore.</p>
                    
                    <div v-if="pbsNodes.length === 0" class="empty-state">
                        <p>Nessun nodo PBS configurato. Aggiungi un nodo PBS dalla pagina Nodi.</p>
                    </div>
                    
                    <div class="table-container" v-else>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome PBS</th>
                                    <th>Host</th>
                                    <th>Datastore</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="pbs in pbsNodes" :key="pbs.id">
                                    <td><strong>{{ pbs.name }}</strong></td>
                                    <td>{{ pbs.host }}</td>
                                    <td>{{ pbs.pbs_datastore || 'Default' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" @click="browseRestorePbs(pbs)">
                                            üìÇ Sfoglia Backup
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Lista backup del PBS selezionato - Raggruppati per VM -->
                <div class="card" v-if="restorePbsBackups.length > 0" style="margin-top: 1rem;">
                    <h3 style="margin-bottom: 1rem;">
                        üì¶ Backup disponibili su {{ selectedRestorePbs?.name }}
                        <span style="font-size: 0.8em; color: var(--text-secondary); margin-left: 1rem;">
                            {{ Object.keys(groupedRestoreBackups).length }} VM/CT ‚Ä¢ {{ restorePbsBackups.length }} backup totali
                        </span>
                    </h3>
                    
                    <!-- Gruppi VM/CT -->
                    <div v-for="(backups, vmKey) in groupedRestoreBackups" :key="vmKey" 
                         style="border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.75rem; overflow: hidden;">
                        
                        <!-- Header gruppo (cliccabile) -->
                        <div @click="toggleBackupGroup(vmKey)" 
                             style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: var(--bg-secondary); cursor: pointer;"
                             :style="{ background: expandedBackupGroups[vmKey] ? 'var(--bg-tertiary)' : 'var(--bg-secondary)' }">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="font-size: 1.2em;">{{ expandedBackupGroups[vmKey] ? 'üìÇ' : 'üìÅ' }}</span>
                                <div>
                                    <strong style="font-size: 1.1em;">
                                        {{ backups[0].vm_name || (backups[0].vm_type?.toUpperCase() || 'VM') + ' #' + backups[0].vmid }}
                                    </strong>
                                    <span v-if="backups[0].vm_name" style="color: var(--text-secondary); margin-left: 0.5rem; font-size: 0.9em;">
                                        ({{ backups[0].vm_type?.toUpperCase() }} #{{ backups[0].vmid }})
                                    </span>
                                    <span class="badge badge-secondary" style="margin-left: 0.5rem;">{{ backups.length }} backup</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="color: var(--text-secondary); font-size: 0.9em;">
                                    Ultimo: {{ formatDate(backups[0].backup_time) }}
                                </span>
                                <button class="btn btn-sm" style="background: #10b981;" 
                                        @click.stop="startRestore(backups[0])" title="Restore ultimo backup">
                                    üîÑ Ultimo
                                </button>
                                <span style="color: var(--text-secondary);">{{ expandedBackupGroups[vmKey] ? '‚ñ≤' : '‚ñº' }}</span>
                            </div>
                        </div>
                        
                        <!-- Lista versioni (espandibile) -->
                        <div v-if="expandedBackupGroups[vmKey]" style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table" style="margin: 0;">
                                <thead>
                                    <tr>
                                        <th style="width: 40%;">Backup ID</th>
                                        <th style="width: 25%;">Data</th>
                                        <th style="width: 20%;">Size</th>
                                        <th style="width: 15%;">Azione</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="backup in backups" :key="backup.backup_id">
                                        <td style="font-family: monospace; font-size: 0.85rem;">
                                            {{ backup.backup_id.split('/').slice(-1)[0] || backup.backup_id }}
                                        </td>
                                        <td>{{ formatDate(backup.backup_time) }}</td>
                                        <td>{{ formatSize(backup.size) }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" @click="startRestore(backup)">
                                                üîÑ
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card" v-if="selectedRestorePbs && restorePbsBackups.length === 0" style="margin-top: 1rem;">
                    <div class="empty-state">
                        <p>Nessun backup trovato sul PBS {{ selectedRestorePbs?.name }}</p>
                    </div>
                </div>
            </div>
            
            <!-- MODAL RESTORE -->
            <div class="modal-overlay" v-if="showRestoreModal" @click.self="showRestoreModal = false">
                <div class="modal" style="max-width: 550px;">
                    <div class="modal-header">
                        <h2>üîÑ Restore VM/CT da PBS</h2>
                        <button class="modal-close" @click="showRestoreModal = false">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Backup da ripristinare</label>
                            <input type="text" class="form-input" :value="restoreData.backup_id" disabled style="font-size: 0.85rem;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">VM/CT Originale</label>
                            <input type="text" class="form-input" :value="(restoreData.vm_name || '') + ' (' + restoreData.vm_type?.toUpperCase() + ' #' + restoreData.vmid + ')'" disabled>
                        </div>
                        
                        <hr style="border-color: var(--border-color); margin: 16px 0;">
                        <h4 style="margin-bottom: 12px; color: var(--accent-primary);">üìç Destinazione</h4>
                        
                        <div class="form-group">
                            <label class="form-label">Nodo Destinazione *</label>
                            <select class="form-input" v-model="restoreData.dest_node_id" @change="loadRestoreStorages" required>
                                <option value="">Seleziona nodo...</option>
                                <option v-for="node in pveNodes" :key="node.id" :value="node.id">
                                    {{ node.name }} ({{ node.hostname }})
                                </option>
                            </select>
                        </div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">VMID Destinazione</label>
                                <input type="number" class="form-input" v-model="restoreData.dest_vmid" placeholder="Auto">
                                <small style="color: var(--text-secondary);">Vuoto = prossimo disponibile</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nome VM</label>
                                <input type="text" class="form-input" v-model="restoreData.dest_vm_name" :placeholder="restoreData.vm_name || 'nome-vm'">
                                <small style="color: var(--text-secondary);">Vuoto = nome originale</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Storage Destinazione *</label>
                            <select class="form-input" v-model="restoreData.dest_storage" v-if="restoreStorages.length > 0">
                                <option value="">Seleziona storage...</option>
                                <option v-for="st in restoreStorages" :key="st.storage" :value="st.storage">
                                    {{ st.storage }} ({{ st.type }}) - {{ formatSize(st.avail) }} liberi
                                </option>
                            </select>
                            <input type="text" class="form-input" v-model="restoreData.dest_storage" v-else placeholder="es: local-lvm, zfs-pool">
                            <small style="color: var(--text-secondary);" v-if="!restoreData.dest_node_id">Seleziona prima un nodo per vedere gli storage</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-check">
                                <input type="checkbox" v-model="restoreData.start_after_restore">
                                <span>Avvia VM dopo il restore</span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="showRestoreModal = false">Annulla</button>
                        <button class="btn btn-primary" @click="executeRestore" :disabled="!restoreData.dest_node_id || !restoreData.dest_storage">
                            üîÑ Esegui Restore
                        </button>
                    </div>
                </div>
            </div>
            
            <div v-if="currentPage === 'vms'">
                <div class="page-header">
                    <h1 class="page-title">üñ•Ô∏è Virtual Machines</h1>
                    <p class="page-subtitle">Gestione VM, backup e replica</p>
                </div>
                
                <!-- Selezione Nodo -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Seleziona Nodo</h3>
                        <button class="btn btn-secondary btn-sm" @click="loadNodeVms" :disabled="!selectedVmNodeId || loading">üîÑ Aggiorna</button>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <select class="form-input" v-model="selectedVmNodeId" @change="loadNodeVms">
                            <option value="">-- Seleziona un nodo PVE --</option>
                            <option v-for="node in pveNodes" :key="node.id" :value="node.id">
                                {{ node.name }} ({{ node.hostname }})
                            </option>
                        </select>
                    </div>
                </div>
                
                <!-- Lista VM -->
                <div class="card" v-if="nodeVms.length > 0">
                    <div class="card-header">
                        <h3 class="card-title">VM/CT su {{ nodes.find(n => n.id == selectedVmNodeId)?.name }}</h3>
                        <span class="badge badge-info">{{ nodeVms.length }} elementi</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>VMID</th>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>Stato</th>
                                    <th>Backup PBS</th>
                                    <th style="min-width: 280px;">Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="vm in nodeVms" :key="vm.vmid">
                                    <td><strong>{{ vm.vmid }}</strong></td>
                                    <td>{{ vm.name || '(senza nome)' }}</td>
                                    <td>
                                        <span class="badge" :class="vm.type === 'lxc' ? 'badge-warning' : 'badge-info'">
                                            {{ vm.type === 'lxc' ? 'üì¶ CT' : 'üñ•Ô∏è VM' }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge" :class="vm.status === 'running' ? 'badge-success' : 'badge-secondary'">
                                            {{ vm.status === 'running' ? '‚ñ∂Ô∏è Running' : '‚èπÔ∏è Stopped' }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm" style="background: rgba(156,39,176,0.2); color: #ce93d8; border: 1px solid #9c27b0;" 
                                                @click="showVmBackups(vm)" :disabled="loading">
                                            üì¶ {{ vm.backup_count || '?' }} backup
                                        </button>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <button class="btn btn-primary btn-sm" @click="createBackupJobFromVm(vm)" title="Crea job di backup verso PBS">
                                                ‚òÅÔ∏è Backup PBS
                                            </button>
                                            <button class="btn btn-primary btn-sm" @click="createRecoveryJobFromVm(vm)" title="Crea job di replica via PBS">
                                                üîÑ Replica PBS
                                            </button>
                                            <button class="btn btn-primary btn-sm" @click="createSyncJobFromVm(vm)" title="Crea job di replica ZFS/BTRFS">
                                                ‚ö° Replica ZFS
                                            </button>
                                            <button class="btn btn-secondary btn-sm" @click="showVmSnapshots(vm)" title="Visualizza snapshot locali">
                                                üì∑ Snapshot
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Nessuna VM -->
                <div class="card" v-else-if="selectedVmNodeId && !loading" style="text-align: center; padding: 40px;">
                    <p style="color: var(--text-secondary);">Nessuna VM/CT trovata su questo nodo</p>
                </div>
                
                <!-- Modal Backup VM -->
                <div class="modal-overlay" v-if="showVmBackupsModal" @click.self="showVmBackupsModal = false">
                    <div class="modal" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3 class="modal-title">üì¶ Backup disponibili per {{ selectedVmForBackups?.name || 'VM' }} #{{ selectedVmForBackups?.vmid }}</h3>
                            <button class="btn btn-icon" @click="showVmBackupsModal = false">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <div v-if="vmBackupsList.length > 0">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr><th>Data</th><th>Sorgente PBS</th><th>Dimensione</th><th>Azioni</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="backup in vmBackupsList" :key="backup.backup_id">
                                            <td>{{ formatDate(backup.backup_time) }}</td>
                                            <td>{{ backup.pbs_name || 'PBS' }}</td>
                                            <td>{{ formatSize(backup.size) }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary" @click="startRestoreFromVmBackup(backup)">
                                                    üîÑ Restore
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div v-else style="text-align: center; padding: 30px; color: var(--text-secondary);">
                                <p>Nessun backup trovato per questa VM</p>
                                <button class="btn btn-primary" @click="createBackupJobFromVm(selectedVmForBackups); showVmBackupsModal = false">
                                    ‚òÅÔ∏è Crea primo backup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Migration Jobs Page -->
            <div v-if="currentPage === 'migration'">
                <div class="page-header">
                    <h1 class="page-title">üöÄ Migrazione VM</h1>
                    <p class="page-subtitle">Copia o migra VM tra nodi Proxmox con riconfigurazione hardware</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìã Job di Migrazione</h3>
                        <button class="btn btn-primary" @click="showMigrationJobModal = true; editingMigrationJobId = null; resetMigrationJobForm()">
                            ‚ûï Nuovo Job
                        </button>
                    </div>
                    <div class="card-body">
                        <div v-if="loading" style="text-align: center; padding: 40px;">
                            <span class="spinner"></span>
                        </div>
                        <div v-else-if="migrationJobs.length === 0" class="empty-state">
                            <p>Nessun job di migrazione configurato</p>
                            <button class="btn btn-primary" @click="showMigrationJobModal = true; resetMigrationJobForm()">
                                Crea primo job
                            </button>
                        </div>
                        <div v-else class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Sorgente</th>
                                        <th>Destinazione</th>
                                        <th>VM</th>
                                        <th>Schedule</th>
                                        <th>Ultima Esecuzione</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="job in migrationJobs" :key="job.id">
                                        <td><strong>{{ job.name }}</strong></td>
                                        <td>{{ job.source_node_name }}</td>
                                        <td>{{ job.dest_node_name }}</td>
                                        <td>{{ job.vm_type === 'qemu' ? 'üñ•Ô∏è' : 'üì¶' }} {{ job.vm_id }}{{ job.dest_vm_id && job.dest_vm_id !== job.vm_id ? ` ‚Üí ${job.dest_vm_id}` : '' }}</td>
                                        <td>
                                            <span v-if="job.schedule" class="badge badge-info">{{ job.schedule }}</span>
                                            <span v-else class="badge badge-secondary">Manuale</span>
                                        </td>
                                        <td>
                                            <span v-if="job.last_run">{{ formatDate(job.last_run) }}</span>
                                            <span v-else style="color: var(--text-secondary);">Mai eseguito</span>
                                        </td>
                                        <td>
                                            <span class="badge" 
                                                  :class="job.last_status === 'success' ? 'badge-success' : 
                                                         job.last_status === 'failed' ? 'badge-error' : 
                                                         job.last_status === 'running' ? 'badge-warning' : 'badge-secondary'">
                                                {{ job.last_status || 'pending' }}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 6px;">
                                                <button class="btn btn-sm btn-primary" @click="runMigrationJob(job.id)" 
                                                        :disabled="job.last_status === 'running' || !job.is_active">
                                                    ‚ñ∂Ô∏è
                                                </button>
                                                <button class="btn btn-sm btn-secondary" @click="editMigrationJob(job)">
                                                    ‚úèÔ∏è
                                                </button>
                                                <button class="btn btn-sm" 
                                                        :class="job.is_active ? 'btn-warning' : 'btn-success'"
                                                        @click="toggleMigrationJob(job.id)">
                                                    {{ job.is_active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è' }}
                                                </button>
                                                <button class="btn btn-sm btn-danger" @click="deleteMigrationJob(job.id)">
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="currentPage === 'logs'">
                <div class="page-header">
                    <h1 class="page-title">Log Operazioni</h1>
                    <p class="page-subtitle">Storico delle attivit√†</p>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Log Recenti</h3>
                            <button class="btn btn-secondary" @click="loadLogs" :disabled="loading">Aggiorna</button>
                    </div>
                    <div class="table-container">
                        <table>
                                <thead><tr><th>Data</th><th>Tipo</th><th>Nodo/Dataset</th><th>Stato</th><th>Durata</th><th>Dettagli</th></tr></thead>
                            <tbody>
                                    <tr v-for="log in allLogs" :key="log.id" :style="log.status === 'failed' ? 'background: rgba(255,71,87,0.05)' : ''">
                                    <td>{{ formatDate(log.started_at) }}</td>
                                    <td>{{ log.job_type }}</td>
                                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                            <div>{{ log.node_name }}</div>
                                            <small style="color: var(--text-secondary);">{{ log.dataset }}</small>
                                    </td>
                                        <td><span class="badge" :class="getStatusClass(log.status)">{{ log.status }}</span></td>
                                    <td>{{ log.duration ? log.duration + 's' : '-' }}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" @click="showLogDetail(log)">
                                                {{ log.error ? '‚ö†Ô∏è Errore' : 'Dettagli' }}
                                            </button>
                                        </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    </div>
                    
                    <!-- Log Detail Modal -->
                    <div class="modal-overlay" v-if="isAuthenticated && selectedLog" @click.self="selectedLog = null">
                        <div class="modal" style="max-width: 800px;">
                            <div class="modal-header">
                                <h3 class="modal-title">Dettagli Log #{{ selectedLog.id }}</h3>
                                <button class="btn btn-icon" @click="selectedLog = null">‚úï</button>
                            </div>
                            <div class="modal-body">
                                <div class="grid-2" style="margin-bottom: 20px;">
                                    <div>
                                        <strong>Tipo:</strong> {{ selectedLog.job_type }}<br>
                                        <strong>Nodo:</strong> {{ selectedLog.node_name }}<br>
                                        <strong>Dataset:</strong> {{ selectedLog.dataset }}
                                    </div>
                                    <div>
                                        <strong>Stato:</strong> <span class="badge" :class="getStatusClass(selectedLog.status)">{{ selectedLog.status }}</span><br>
                                        <strong>Durata:</strong> {{ selectedLog.duration ? selectedLog.duration + ' secondi' : '-' }}<br>
                                        <strong>Trasferito:</strong> {{ selectedLog.transferred || '-' }}
                </div>
            </div>
            
                                <div v-if="selectedLog.error" style="background: rgba(255,71,87,0.1); border: 1px solid var(--accent-danger); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                    <h4 style="color: var(--accent-danger); margin-bottom: 8px;">‚ùå Errore</h4>
                                    <pre style="white-space: pre-wrap; font-size: 0.85rem; color: var(--accent-danger); margin: 0;">{{ selectedLog.error }}</pre>
                                </div>
                                
                                <div v-if="selectedLog.output" style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                                    <h4 style="margin-bottom: 8px;">üìã Output</h4>
                                    <pre style="white-space: pre-wrap; font-size: 0.85rem; max-height: 300px; overflow-y: auto; margin: 0;">{{ selectedLog.output }}</pre>
                                </div>
                                
                                <div v-if="!selectedLog.error && !selectedLog.output" style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                    Nessun dettaglio disponibile
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            
            <!-- HOST BACKUP PAGE -->
            <div v-if="currentPage === 'host-backup'">
                <div class="page-header">
                    <h1 class="page-title">üñ•Ô∏è Host Config Backup</h1>
                    <p class="page-subtitle">
                        Backup configurazione host Proxmox PVE e PBS - 
                        <a href="https://github.com/tis24dev/proxsave" target="_blank" style="color: var(--accent-info);">Ispirato a ProxSave</a>
                    </p>
                </div>
                
                <!-- Info Box -->
                <div class="card" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(3, 169, 244, 0.1)); border-color: #2196f3;">
                    <div style="display: flex; gap: 16px; align-items: flex-start;">
                        <div style="font-size: 2rem;">üí°</div>
                        <div>
                            <h3 style="color: #64b5f6; margin-bottom: 8px;">Cos'√® l'Host Config Backup?</h3>
                            <p style="color: var(--text-secondary); line-height: 1.6;">
                                Backup dei <strong>file di configurazione del sistema Proxmox</strong> (non delle VM).<br>
                                Include: <code>/etc/pve</code>, <code>/etc/network</code>, configurazione cluster, chiavi SSH, cron jobs.<br>
                                <strong>Utile per:</strong> Disaster recovery, migrazioni server, ripristino configurazione.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Crea Nuovo Job -->
                <div class="card">
                    <h3 class="card-title">‚ûï Crea Job Host Backup Schedulato</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Nome Job</label>
                            <input type="text" class="form-input" v-model="hostBackupJob.name" placeholder="Backup Config PVE">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nodo</label>
                            <select class="form-input" v-model="hostBackupJob.node_id" @change="loadHostBackupPaths">
                                <option value="">-- Seleziona nodo --</option>
                                <option v-for="node in nodes.filter(n => n.node_type === 'pve' || n.node_type === 'pbs')" :key="node.id" :value="node.id">
                                    {{ node.name }} ({{ node.node_type?.toUpperCase() }})
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="grid-3">
                        <div class="form-group">
                            <label class="form-label">Schedule</label>
                            <select class="form-input" v-model="hostBackupJob.schedulePreset" @change="onSchedulePresetChange(hostBackupJob)">
                                <option v-for="preset in schedulePresets" :key="preset.value" :value="preset.value">
                                    {{ preset.label }}
                                </option>
                            </select>
                            <input v-if="hostBackupJob.schedulePreset === 'custom'" type="text" class="form-input" v-model="hostBackupJob.schedule" placeholder="es: 0 2 * * *" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Retention (mantieni ultimi)</label>
                            <input type="number" class="form-input" v-model="hostBackupJob.keep_last" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Percorso Destinazione</label>
                            <input type="text" class="form-input" v-model="hostBackupJob.dest_path" placeholder="/var/backups/proxmox-config">
                        </div>
                    </div>
                    <div class="grid-3">
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" v-model="hostBackupJob.compress"> Comprimi (gzip)
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" v-model="hostBackupJob.encrypt"> Cripta (AES-256)
                            </label>
                        </div>
                        <div class="form-group" v-if="hostBackupJob.encrypt">
                            <label class="form-label">Password Cifratura</label>
                            <input type="password" class="form-input" v-model="hostBackupJob.encrypt_password" placeholder="Password">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">üìß Notifiche Email</label>
                            <select class="form-input" v-model="hostBackupJob.notify_mode">
                                <option value="daily">üìÖ Solo nel riepilogo giornaliero</option>
                                <option value="always">üì® Ad ogni esecuzione</option>
                                <option value="failure">‚ö†Ô∏è Solo in caso di errore</option>
                                <option value="never">üîï Disabilitate</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Soggetto Email</label>
                            <input type="text" class="form-input" v-model="hostBackupJob.notify_subject" placeholder="[HOST BACKUP] {node_name}">
                        </div>
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn btn-primary" @click="createHostBackupJob" :disabled="loading || !hostBackupJob.name || !hostBackupJob.node_id">
                            ‚ûï Crea Job
                        </button>
                    </div>
                </div>
                
                <!-- Lista Job Esistenti -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìã Job Host Backup Configurati</h3>
                        <button class="btn btn-secondary btn-sm" @click="loadHostBackupJobs">üîÑ Aggiorna</button>
                    </div>
                    <table class="table" v-if="hostBackupJobs.length > 0">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Nodo</th>
                                <th>Schedule</th>
                                <th>Retention</th>
                                <th>Ultimo Backup</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="job in hostBackupJobs" :key="job.id">
                                <td>
                                    <strong>{{ job.name }}</strong>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">
                                        {{ job.compress ? 'üì¶ Compresso' : '' }} {{ job.encrypt ? 'üîê Cifrato' : '' }}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge" :class="job.node_type === 'pve' ? 'badge-primary' : 'badge-info'">
                                        {{ job.node_name }}
                                    </span>
                                </td>
                                <td>
                                    <span v-if="job.schedule" class="badge badge-primary">{{ formatSchedule(job.schedule) }}</span>
                                    <span v-else class="badge badge-secondary">Manuale</span>
                                </td>
                                <td>{{ job.keep_last }}</td>
                                <td>
                                    <div v-if="job.last_backup_time">
                                        {{ formatDate(job.last_backup_time) }}
                                        <div style="font-size: 0.85em; color: var(--text-secondary);">
                                            {{ job.last_duration ? job.last_duration + 's' : '' }}
                                        </div>
                                    </div>
                                    <span v-else style="color: var(--text-secondary);">Mai</span>
                                </td>
                                <td>
                                    <span v-if="job.current_status === 'running'" class="badge badge-warning">‚è≥ In corso</span>
                                    <span v-else-if="job.last_status === 'success'" class="badge badge-success">‚úì OK</span>
                                    <span v-else-if="job.last_status === 'failed'" class="badge badge-danger">‚úó Errore</span>
                                    <span v-else class="badge badge-secondary">‚Äî</span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 4px;">
                                        <button class="btn btn-sm btn-primary" @click="runHostBackupJob(job.id)" :disabled="loading" title="Esegui ora">‚ñ∂Ô∏è</button>
                                        <button class="btn btn-sm btn-secondary" @click="editHostBackupJob(job)" title="Modifica">‚úèÔ∏è</button>
                                        <button class="btn btn-sm btn-danger" @click="deleteHostBackupJob(job.id)" title="Elimina">üóëÔ∏è</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div v-else class="empty-state">
                        <p>Nessun job configurato. Crea un nuovo job per iniziare.</p>
                    </div>
                </div>
                
                <!-- Backup Manuale Rapido -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‚ö° Backup Manuale Rapido</h3>
                    </div>
                    <div class="grid-3">
                        <div class="form-group">
                            <label class="form-label">Nodo</label>
                            <select class="form-input" v-model="hostBackup.selectedNodeId" @change="loadHostBackupPaths">
                                <option value="">-- Seleziona nodo --</option>
                                <option v-for="node in nodes.filter(n => n.node_type === 'pve' || n.node_type === 'pbs')" :key="node.id" :value="node.id">
                                    {{ node.name }} ({{ node.node_type?.toUpperCase() }})
                                </option>
                            </select>
                        </div>
                        <div class="form-group" v-if="hostBackup.hostType">
                            <label class="form-label">Tipo</label>
                            <div class="form-input" style="background: var(--bg-tertiary); border: none;">
                                <span :class="hostBackup.hostType === 'pve' ? 'badge badge-primary' : 'badge badge-info'">
                                    {{ hostBackup.hostType === 'pve' ? 'üñ•Ô∏è PVE' : 'üóÑÔ∏è PBS' }}
                                </span>
                                <span v-if="hostBackup.totalSizeHuman" style="margin-left: 8px;">{{ hostBackup.totalSizeHuman }}</span>
                            </div>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" @click="createHostBackup" :disabled="loading || !hostBackup.selectedNodeId">
                                üíæ Backup Ora
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Lista Backup Esistenti sul Nodo -->
                <div class="card" v-if="hostBackup.selectedNodeId && hostBackup.backups.length > 0">
                    <div class="card-header">
                        <h3 class="card-title">üìã Backup sul Nodo</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" @click="loadHostBackups">üîÑ</button>
                            <button class="btn btn-warning btn-sm" @click="showHostRetentionModal = true">üóëÔ∏è Retention</button>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr><th>File</th><th>Dimensione</th><th>Data</th><th>Azioni</th></tr>
                        </thead>
                        <tbody>
                            <tr v-for="backup in hostBackup.backups" :key="backup.filename">
                                <td style="font-family: monospace; font-size: 0.85em;">
                                    {{ backup.filename }}
                                    <span v-if="backup.encrypted" class="badge badge-warning" style="margin-left: 8px;">üîê</span>
                                </td>
                                <td>{{ backup.size_human }}</td>
                                <td>{{ backup.date }}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" @click="deleteHostBackup(backup)">üóëÔ∏è</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Modal Retention Host Backup -->
            <div class="modal-overlay" v-if="showHostRetentionModal" @click.self="showHostRetentionModal = false">
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3 class="modal-title">üóëÔ∏è Applica Retention</h3>
                        <button class="btn btn-icon" @click="showHostRetentionModal = false">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Mantieni ultimi N backup</label>
                            <input type="number" class="form-input" v-model="hostRetentionCount" min="1" max="100">
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9em;">
                            I backup pi√π vecchi verranno eliminati. Attualmente ci sono {{ hostBackup.backups.length }} backup.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="showHostRetentionModal = false">Annulla</button>
                        <button class="btn btn-warning" @click="applyHostRetention">Applica</button>
                    </div>
                </div>
            </div>
            
            <div v-if="currentPage === 'settings'">
                <div class="page-header">
                    <h1 class="page-title">Impostazioni</h1>
                        <p class="page-subtitle">Configurazione del sistema</p>
                </div>
                
                    <div class="tabs">
                        <div class="tab" :class="{active: settingsTab === 'general'}" @click="settingsTab = 'general'">Generale</div>
                        <div class="tab" :class="{active: settingsTab === 'auth'}" @click="settingsTab = 'auth'" v-if="currentUser?.role === 'admin'">Autenticazione</div>
                        <div class="tab" :class="{active: settingsTab === 'notifications'}" @click="settingsTab = 'notifications'; loadNotifSettings()" v-if="currentUser?.role === 'admin'">Notifiche</div>
                        <div class="tab" :class="{active: settingsTab === 'ssl'}" @click="settingsTab = 'ssl'; loadSslStatus()" v-if="currentUser?.role === 'admin'">üîí SSL/HTTPS</div>
                    </div>
                    
                    <div class="card" v-if="settingsTab === 'general'">
                        <h3 class="card-title" style="margin-bottom: 20px;">‚öôÔ∏è Impostazioni Generali</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Compressione Default</label>
                                <select class="form-input" v-model="settings.syncoid_default_compress" :disabled="!isAdmin">
                                <option value="none">Nessuna</option>
                                <option value="gzip">gzip</option>
                                <option value="lz4">lz4</option>
                                <option value="zstd">zstd</option>
                            </select>
                        </div>
                        <div class="form-group">
                                <label class="form-label">Buffer Size</label>
                                <input type="text" class="form-input" v-model="settings.syncoid_default_mbuffer" :disabled="!isAdmin">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Retention Log (giorni)</label>
                                <input type="number" class="form-input" v-model="settings.log_retention_days" :disabled="!isAdmin">
                        </div>
                        </div>
                        <button class="btn btn-primary" @click="saveSettings" :disabled="loading || !isAdmin" v-if="isAdmin">Salva</button>
                    </div>
                    
                    <div class="card" v-if="settingsTab === 'auth' && isAdmin">
                        <h3 class="card-title" style="margin-bottom: 20px;">üîê Autenticazione</h3>
                        <div class="grid-2">
                        <div class="form-group">
                                <label class="form-label">Metodo Autenticazione</label>
                                <select class="form-input" v-model="authSettings.auth_method">
                                    <option value="local">Locale</option>
                                    <option value="proxmox">Proxmox VE</option>
                                </select>
                        </div>
                            <div class="form-group">
                                <label class="form-label">Timeout Sessione (minuti)</label>
                                <input type="number" class="form-input" v-model="authSettings.auth_session_timeout">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" v-model="authSettings.auth_allow_local_fallback">
                                    Permetti fallback locale
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-primary" @click="saveAuthSettings" :disabled="loading">Salva</button>
                    </div>
                    
                    <div class="card" v-if="settingsTab === 'notifications' && isAdmin">
                        <h3 class="card-title" style="margin-bottom: 20px;">üîî Notifiche Email</h3>
                        
                        <div class="form-group">
                            <label class="form-label"><input type="checkbox" v-model="notifSettings.smtp_enabled"> Abilita Notifiche Email</label>
                        </div>
                        
                        <div v-if="notifSettings.smtp_enabled">
                            <h4 style="color: var(--accent-primary); margin: 20px 0 12px;">üìß Configurazione Server SMTP</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">Server SMTP</label>
                                    <input type="text" class="form-input" v-model="notifSettings.smtp_host" placeholder="smtp.gmail.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Porta</label>
                                    <input type="number" class="form-input" v-model.number="notifSettings.smtp_port" placeholder="587">
                                </div>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">Username SMTP</label>
                                    <input type="text" class="form-input" v-model="notifSettings.smtp_user" placeholder="user@example.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Password SMTP</label>
                                    <input type="password" class="form-input" v-model="notifSettings.smtp_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><input type="checkbox" v-model="notifSettings.smtp_tls"> Usa TLS (STARTTLS)</label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 4px;">
                                    ‚Ä¢ Porta 25: disabilita TLS (nessuna cifratura)<br>
                                    ‚Ä¢ Porta 465: SSL automatico (ignora checkbox)<br>
                                    ‚Ä¢ Porta 587: abilita TLS (STARTTLS)
                                </small>
                            </div>
                            
                            <h4 style="color: var(--accent-secondary); margin: 20px 0 12px;">üì§ Mittente e Destinatari</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">Email Mittente (From)</label>
                                    <input type="email" class="form-input" v-model="notifSettings.smtp_from" placeholder="sanoid@example.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email Destinatari (To)</label>
                                    <input type="text" class="form-input" v-model="notifSettings.smtp_to" placeholder="admin@example.com, team@example.com">
                                    <small style="color: var(--text-secondary);">Separare pi√π indirizzi con virgola</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Prefisso Oggetto Email</label>
                                <input type="text" class="form-input" v-model="notifSettings.smtp_subject_prefix" placeholder="[DAPX]">
                                <small style="color: var(--text-secondary);">Es: "[Backup Proxmox]" ‚Üí "[Backup Proxmox] ‚úÖ Replica Completata"</small>
                            </div>
                            
                            <div style="margin-top: 16px;">
                                <button class="btn btn-secondary" @click="testEmailNotification" :disabled="loading || !notifSettings.smtp_host || !notifSettings.smtp_to">
                                    üß™ Invia Email di Test
                                </button>
                            </div>
                        </div>
                        
                        <hr style="border-color: var(--border-color); margin: 20px 0;">
                        
                        <h4 style="color: var(--accent-warning); margin-bottom: 12px;">üîî Quando Notificare</h4>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label"><input type="checkbox" v-model="notifSettings.notify_on_failure"> ‚ùå Notifica su errori</label>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><input type="checkbox" v-model="notifSettings.notify_on_success"> ‚úÖ Notifica su successi</label>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><input type="checkbox" v-model="notifSettings.notify_on_warning"> ‚ö†Ô∏è Notifica su warning</label>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" @click="saveNotifSettings" :disabled="loading">üíæ Salva Configurazione</button>
                        </div>
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <h4 style="color: var(--accent-secondary); margin-bottom: 12px;">üìä Riepilogo Giornaliero</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                                Ricevi ogni giorno un riepilogo con lo stato di tutti i job di replica configurati.
                            </p>
                            <div class="grid-2" style="margin-bottom: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Orario invio (UTC)</label>
                                    <select class="form-input" v-model="dailySummaryHour">
                                        <option v-for="h in 24" :key="h-1" :value="h-1">{{ String(h-1).padStart(2, '0') }}:00</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button class="btn btn-secondary" @click="saveDailySummaryHour" :disabled="loading" style="width: 100%;">
                                        üíæ Salva Orario
                                    </button>
                                </div>
                            </div>
                            <button class="btn btn-primary" @click="sendDailySummary" :disabled="loading || !notifSettings.smtp_enabled" style="width: 100%;">
                                üìß Invia Riepilogo Ora
                            </button>
                            <small v-if="!notifSettings.smtp_enabled" style="display: block; margin-top: 8px; color: var(--accent-warning);">
                                ‚ö†Ô∏è Abilita le notifiche email per usare questa funzione
                            </small>
                        </div>
                    </div>
                    
                    <!-- SSL/HTTPS Settings Tab -->
                    <div class="card" v-if="settingsTab === 'ssl' && isAdmin">
                        <h3 class="card-title" style="margin-bottom: 20px;">üîí Configurazione SSL/HTTPS</h3>
                        
                        <!-- Stato Corrente -->
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 12px; color: var(--accent-secondary);">üìä Stato Corrente</h4>
                            <div class="grid-2" v-if="sslStatus">
                                <div>
                                    <div style="margin-bottom: 8px;">
                                        <strong>HTTPS:</strong>
                                        <span :style="{ color: sslStatus.ssl_enabled ? 'var(--accent-primary)' : 'var(--text-secondary)' }">
                                            {{ sslStatus.ssl_enabled ? '‚úÖ Attivo' : '‚ö´ Non attivo' }}
                                        </span>
                                    </div>
                                    <div>
                                        <strong>Certificato:</strong>
                                        <span :style="{ color: sslStatus.cert_exists ? 'var(--accent-primary)' : 'var(--accent-warning)' }">
                                            {{ sslStatus.cert_exists ? '‚úÖ Presente' : '‚ö†Ô∏è Non trovato' }}
                                        </span>
                                    </div>
                                </div>
                                <div v-if="sslStatus.cert_info">
                                    <div style="margin-bottom: 8px;">
                                        <strong>Validit√†:</strong>
                                        <span :style="{ color: sslStatus.cert_info.valid ? 'var(--accent-primary)' : 'var(--accent-danger)' }">
                                            {{ sslStatus.cert_info.valid ? '‚úÖ Valido' : '‚ùå Non valido' }}
                                        </span>
                                    </div>
                                    <div v-if="sslStatus.cert_info.days_remaining">
                                        <strong>Scadenza:</strong>
                                        <span :style="{ color: sslStatus.cert_info.days_remaining < 30 ? 'var(--accent-warning)' : 'var(--text-primary)' }">
                                            {{ sslStatus.cert_info.days_remaining }} giorni
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div v-else style="color: var(--text-secondary);">
                                Caricamento stato SSL...
                            </div>
                        </div>
                        
                        <!-- Genera Certificato Auto-firmato -->
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 12px; color: var(--accent-primary);">üîß Genera Certificato Auto-firmato</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                                Genera automaticamente un certificato SSL auto-firmato. Utile per ambienti di sviluppo o reti interne.
                            </p>
                            <div class="grid-2" style="margin-bottom: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Hostname</label>
                                    <input type="text" class="form-input" v-model="sslGenHostname" placeholder="es: server.local">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Validit√† (giorni)</label>
                                    <input type="number" class="form-input" v-model="sslGenDays" min="30" max="3650">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label class="form-label">IP Aggiuntivi (opzionale, separati da virgola)</label>
                                <input type="text" class="form-input" v-model="sslGenIps" placeholder="es: 192.168.1.10, 10.0.0.5">
                            </div>
                            <button class="btn btn-primary" @click="generateSslCert" :disabled="sslLoading">
                                üîê Genera Certificato
                            </button>
                        </div>
                        
                        <!-- Carica Certificato Personalizzato -->
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 12px; color: var(--accent-secondary);">üì§ Carica Certificato Personalizzato</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                                Carica un certificato SSL esistente (es. da Let's Encrypt o CA aziendale). Formato PEM richiesto.
                            </p>
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label class="form-label">Certificato (PEM)</label>
                                <textarea class="form-input" v-model="sslUploadCert" rows="4" 
                                    placeholder="-----BEGIN CERTIFICATE-----&#10;...&#10;-----END CERTIFICATE-----"
                                    style="font-family: 'JetBrains Mono', monospace; font-size: 12px;"></textarea>
                            </div>
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label class="form-label">Chiave Privata (PEM)</label>
                                <textarea class="form-input" v-model="sslUploadKey" rows="4" 
                                    placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----"
                                    style="font-family: 'JetBrains Mono', monospace; font-size: 12px;"></textarea>
                            </div>
                            <button class="btn btn-primary" @click="uploadSslCert" :disabled="sslLoading || !sslUploadCert || !sslUploadKey">
                                üì§ Carica Certificato
                            </button>
                        </div>
                        
                        <!-- Istruzioni Attivazione HTTPS -->
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <h4 style="margin-bottom: 12px; color: var(--accent-warning);">üìã Come Attivare HTTPS</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 14px;">
                                Dopo aver generato o caricato il certificato, riavvia il server con SSL:
                            </p>
                            <pre style="background: var(--bg-primary); padding: 12px; border-radius: 4px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent-primary);">./start.sh --ssl</pre>
                            <p style="color: var(--text-secondary); margin-top: 12px; font-size: 13px;">
                                Oppure con variabili d'ambiente per certificati custom:
                            </p>
                            <pre style="background: var(--bg-primary); padding: 12px; border-radius: 4px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent-secondary);">DAPX_SSL_CERT=/path/to/cert.pem DAPX_SSL_KEY=/path/to/key.pem ./start.sh --ssl</pre>
                        </div>
                        
                        <!-- Elimina Certificato -->
                        <div v-if="sslStatus?.cert_exists" style="margin-top: 20px; text-align: right;">
                            <button class="btn btn-danger" @click="deleteSslCert" :disabled="sslLoading">
                                üóëÔ∏è Elimina Certificato
                            </button>
                        </div>
                    </div>
            </div>
            
            <!-- SSH Keys Management Page -->
            <div v-if="currentPage === 'ssh-keys'">
                <div class="page-header">
                    <h1 class="page-title">üîë Gestione Chiavi SSH</h1>
                    <p class="page-subtitle">Configura e distribuisci le chiavi SSH per la replica tra nodi</p>
                </div>
                
                <!-- Stato Chiave Locale -->
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 20px;">üîê Chiave SSH Locale</h3>
                    
                    <div v-if="sshKeyInfo.exists" style="margin-bottom: 20px;">
                        <div class="status-badge" :class="sshKeyInfo.exists ? 'success' : 'warning'" style="display: inline-block; margin-bottom: 16px;">
                            {{ sshKeyInfo.exists ? '‚úÖ Chiave presente' : '‚ö†Ô∏è Chiave non trovata' }}
                        </div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Tipo Chiave</label>
                                <input type="text" class="form-input" :value="sshKeyInfo.key_type" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fingerprint</label>
                                <input type="text" class="form-input" :value="sshKeyInfo.fingerprint" disabled style="font-family: 'JetBrains Mono', monospace; font-size: 12px;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Chiave Pubblica</label>
                            <textarea class="form-input" :value="sshKeyInfo.public_key" disabled rows="3" style="font-family: 'JetBrains Mono', monospace; font-size: 11px;"></textarea>
                            <button class="btn btn-secondary" style="margin-top: 8px;" @click="copyPublicKey">üìã Copia Chiave</button>
                        </div>
                    </div>
                    
                    <div v-else style="text-align: center; padding: 30px; background: var(--bg-tertiary); border-radius: 12px;">
                        <p style="color: var(--accent-warning); margin-bottom: 16px;">‚ö†Ô∏è Nessuna chiave SSH trovata</p>
                        <button class="btn btn-primary" @click="generateSSHKey" :disabled="loading">
                            üîß Genera Nuova Chiave
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;" v-if="sshKeyInfo.exists">
                        <h4 style="color: var(--accent-warning); margin-bottom: 12px;">‚ö†Ô∏è Rigenera Chiave</h4>
                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">
                            Attenzione: rigenerare la chiave richieder√† di ridistribuirla a tutti i nodi!
                        </p>
                        <button class="btn btn-danger" @click="regenerateSSHKey" :disabled="loading">
                            üîÑ Rigenera Chiave
                        </button>
                    </div>
                </div>
                
                <!-- Stato Nodi -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="card-title">üñ•Ô∏è Stato Connessione Nodi</h3>
                        <div>
                            <button class="btn btn-secondary" @click="testAllSSHConnections" :disabled="loading" style="margin-right: 8px;">
                                üß™ Testa Tutti
                            </button>
                            <button class="btn btn-secondary" @click="showDistributeModal = true" :disabled="loading || !sshKeyInfo.exists" style="margin-right: 8px;">
                                üîë Distribuisci Chiave
                            </button>
                            <button class="btn btn-primary" @click="setupMeshSSH" :disabled="loading || !sshKeyInfo.exists">
                                üîÑ Setup Mesh
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="nodes.length === 0" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p>Nessun nodo configurato</p>
                        <button class="btn btn-primary" style="margin-top: 16px;" @click="currentPage = 'nodes'">
                            ‚ûï Aggiungi Nodo
                        </button>
                    </div>
                    
                    <table class="table" v-else>
                        <thead>
                            <tr>
                                <th>Nodo</th>
                                <th>Host</th>
                                <th>Porta</th>
                                <th>Stato SSH</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="node in nodes" :key="node.id">
                                <td><strong>{{ node.name }}</strong></td>
                                <td><code>{{ node.hostname }}</code></td>
                                <td>{{ node.ssh_port || 22 }}</td>
                                <td>
                                    <span v-if="sshTestResults[node.id] === undefined" class="status-badge warning">Non testato</span>
                                    <span v-else-if="sshTestResults[node.id]?.success" class="status-badge success">‚úÖ Connesso</span>
                                    <span v-else class="status-badge danger" :title="sshTestResults[node.id]?.message">‚ùå Errore</span>
                                </td>
                                <td>
                                    <button class="btn btn-secondary btn-sm" @click="testSingleSSH(node.id)" :disabled="loading" title="Test connessione">
                                        üß™
                                    </button>
                                    <button class="btn btn-primary btn-sm" @click="distributeSingleKey(node.id)" :disabled="loading || !sshKeyInfo.exists" title="Distribuisci chiave">
                                        üîë
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Guida -->
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 16px;">üìñ Guida Rapida</h3>
                    <div style="color: var(--text-secondary); font-size: 14px; line-height: 1.8;">
                        <p><strong>1. Genera/Verifica Chiave:</strong> Assicurati che esista una chiave SSH locale.</p>
                        <p><strong>2. Aggiungi Nodi:</strong> Configura i nodi Proxmox nella sezione "Nodi".</p>
                        <p><strong>3. Distribuisci Chiave:</strong> Copia solo la chiave pubblica (per connessioni dal server centrale).</p>
                        <p><strong>4. Setup Mesh:</strong> <span style="color: var(--accent-primary);">Copia la stessa chiave su tutti i nodi</span> per permettere replica bidirezionale tra qualsiasi coppia di nodi.</p>
                        <p><strong>5. Testa Connessioni:</strong> Verifica che tutto funzioni senza password.</p>
                        
                        <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <strong style="color: var(--accent-warning);">üîÑ Setup Mesh</strong><br>
                            Copia la <strong>stessa coppia di chiavi</strong> (pubblica + privata) su tutti i nodi.<br>
                            Ogni nodo potr√† connettersi a ogni altro nodo senza password.
                        </div>
                        
                        <p style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            üí° <strong>Tip:</strong> Se la distribuzione automatica fallisce, esegui manualmente:
                            <br><code style="color: var(--accent-primary);">ssh-copy-id -i /root/.ssh/id_rsa.pub root@NODO_IP</code>
                        </p>
                    </div>
                </div>
            </div>
        </main>
        </template>
        
        <!-- Modal Distribuzione Chiave -->
        <div class="modal-overlay" v-if="showDistributeModal" @click.self="showDistributeModal = false">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">üöÄ Distribuisci Chiave SSH</h3>
                    <button class="btn btn-icon" @click="showDistributeModal = false">‚úï</button>
                </div>
                
                <div class="modal-body">
                    <p style="margin-bottom: 16px; color: var(--text-secondary);">
                        Se √® la prima volta che distribuisci la chiave, potrebbe essere necessaria la password root dei nodi.
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">Password Root (opzionale)</label>
                        <input type="password" class="form-input" v-model="distributePassword" placeholder="Lascia vuoto se la chiave √® gi√† installata">
                        <small style="color: var(--text-secondary);">Usata solo per la prima distribuzione se non c'√® gi√† accesso SSH</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nodi da aggiornare</label>
                        <div style="max-height: 200px; overflow-y: auto; background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                            <label v-for="node in nodes" :key="node.id" style="display: block; margin-bottom: 8px;">
                                <input type="checkbox" v-model="selectedNodesForDistribute" :value="node.id">
                                {{ node.name }} ({{ node.hostname }})
                            </label>
                        </div>
                    </div>
                    
                    <div v-if="distributeResults.length > 0" style="margin-top: 16px;">
                        <h4 style="margin-bottom: 8px;">Risultati:</h4>
                        <div v-for="r in distributeResults" :key="r.host" style="padding: 8px; margin-bottom: 4px; border-radius: 6px;" 
                             :style="{ background: r.success ? 'rgba(0,255,157,0.1)' : 'rgba(255,71,87,0.1)' }">
                            <strong>{{ r.host }}:</strong> 
                            <span :style="{ color: r.success ? 'var(--accent-primary)' : 'var(--accent-danger)' }">
                                {{ r.message }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showDistributeModal = false">Chiudi</button>
                    <button class="btn btn-primary" @click="distributeKeyToSelected" :disabled="loading || selectedNodesForDistribute.length === 0">
                        üöÄ Distribuisci
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal Password SSH per Distribuzione -->
        <div class="modal-overlay" v-if="showPasswordPrompt" @click.self="showPasswordPrompt = false">
            <div class="modal" style="max-width: 400px;">
                <div class="modal-header">
                    <h3 class="modal-title">üîê Password Richiesta</h3>
                    <button class="btn btn-icon" @click="showPasswordPrompt = false; sshPassword = ''">‚úï</button>
                </div>
                
                <div class="modal-body">
                    <div style="padding: 16px; background: rgba(255, 179, 0, 0.1); border-radius: 8px; margin-bottom: 16px;">
                        <p style="color: var(--accent-warning); margin: 0;">
                            ‚ö†Ô∏è La chiave SSH non √® ancora autorizzata su questo nodo.
                        </p>
                        <p style="color: var(--text-secondary); margin: 8px 0 0 0; font-size: 0.9rem;">
                            Inserisci la password root del nodo per autorizzare la chiave.
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password Root del Nodo</label>
                        <input type="password" class="form-input" v-model="sshPassword" 
                               placeholder="Inserisci password..."
                               @keyup.enter="retryDistributeWithPassword"
                               autofocus>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showPasswordPrompt = false; sshPassword = ''">Annulla</button>
                    <button class="btn btn-primary" @click="retryDistributeWithPassword" :disabled="loading || !sshPassword">
                        üîë Autorizza Chiave
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal Snapshot VM -->
        <div class="modal-overlay" v-if="showVmSnapshotModal" @click.self="showVmSnapshotModal = false">
            <div class="modal" style="max-width: 1000px;">
                <div class="modal-header">
                    <h3 class="modal-title">üì∑ Snapshot VM {{ vmSnapshotData.vmId }} - {{ vmSnapshotData.vmName }}</h3>
                    <button class="btn btn-icon" @click="showVmSnapshotModal = false">‚úï</button>
                </div>
                
                <div class="modal-body">
                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color);">
                        <button class="btn" :class="vmSnapshotTab === 'snapshots' ? 'btn-primary' : 'btn-secondary'" 
                                @click="vmSnapshotTab = 'snapshots'" style="border-radius: 8px 8px 0 0;">
                            üì∏ Snapshot ({{ (vmSnapshotData.proxmoxTotal || 0) + (vmSnapshotData.sanoidTotal || 0) + (vmSnapshotData.syncoidTotal || 0) + (vmSnapshotData.backupTotal || 0) }})
                        </button>
                        <button class="btn" :class="vmSnapshotTab === 'config' ? 'btn-primary' : 'btn-secondary'" 
                                @click="vmSnapshotTab = 'config'" style="border-radius: 8px 8px 0 0;">
                            ‚öôÔ∏è Configurazione Sanoid
                        </button>
                    </div>
                    
                    <!-- Tab: Snapshot -->
                    <div v-if="vmSnapshotTab === 'snapshots'">
                        <div v-if="vmSnapshotData.loading" style="text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 16px;">Caricamento snapshot...</p>
                        </div>
                        
                        <div v-else-if="(vmSnapshotData.proxmoxTotal || 0) === 0 && (vmSnapshotData.sanoidTotal || 0) === 0 && (vmSnapshotData.syncoidTotal || 0) === 0 && (vmSnapshotData.backupTotal || 0) === 0" 
                             style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <p>Nessuno snapshot trovato per questa VM</p>
                        </div>
                        
                        <div v-else>
                            <!-- Snapshot Proxmox -->
                            <div v-if="vmSnapshotData.proxmoxDatasets && Object.keys(vmSnapshotData.proxmoxDatasets).length > 0" style="margin-bottom: 30px;">
                                <h4 style="color: var(--accent-primary); margin-bottom: 12px;">
                                    üñ•Ô∏è Snapshot Proxmox ({{ vmSnapshotData.proxmoxTotal || 0 }})
                                </h4>
                                <div v-for="(snaps, dataset) in vmSnapshotData.proxmoxDatasets" :key="'proxmox-' + dataset" style="margin-bottom: 20px;">
                                    <h5 style="color: var(--accent-secondary); margin-bottom: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;">
                                        üìÅ {{ dataset }}
                                    </h5>
                                    <div class="table-container" style="max-height: 250px; overflow-y: auto;">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Snapshot</th>
                                                    <th>Dimensione</th>
                                                    <th>Data Creazione</th>
                                                    <th>Azioni</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="snap in snaps" :key="snap.full_name">
                                                    <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--accent-primary);">
                                                        {{ snap.snapshot }}
                                                    </td>
                                                    <td>{{ snap.used }}</td>
                                                    <td>{{ snap.creation }}</td>
                                                    <td>
                                                        <button class="btn btn-danger btn-sm" @click="rollbackToSnapshot(snap)" :disabled="loading" title="Rollback (distruttivo!)">
                                                            üîÑ Rollback
                                                        </button>
                                                        <button class="btn btn-secondary btn-sm" @click="cloneSnapshot(snap)" :disabled="loading" title="Crea clone" style="margin-left: 4px;">
                                                            üìã Clone
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Snapshot Sanoid -->
                            <div v-if="vmSnapshotData.sanoidSnapshots && vmSnapshotData.sanoidSnapshots.length > 0" style="margin-bottom: 30px;">
                                <h4 style="color: var(--accent-secondary); margin-bottom: 12px;">
                                    ‚ö° Snapshot Sanoid ({{ vmSnapshotData.sanoidTotal || 0 }})
                                </h4>
                                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Dataset</th>
                                                <th>Snapshot</th>
                                                <th>Dimensione</th>
                                                <th>Data Creazione</th>
                                                <th>Azioni</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="snap in vmSnapshotData.sanoidSnapshots" :key="snap.full_name">
                                                <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">{{ snap.dataset.split('/').pop() }}</td>
                                                <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--accent-secondary);">
                                                    {{ snap.snapshot }}
                                                </td>
                                                <td>{{ snap.used }}</td>
                                                <td>{{ snap.creation }}</td>
                                                <td>
                                                    <button class="btn btn-danger btn-sm" @click="rollbackToSnapshot(snap)" :disabled="loading" title="Rollback (distruttivo!)">
                                                        üîÑ Rollback
                                                    </button>
                                                    <button class="btn btn-secondary btn-sm" @click="cloneSnapshot(snap)" :disabled="loading" title="Crea clone" style="margin-left: 4px;">
                                                        üìã Clone
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Snapshot Backup (retention) -->
                            <div v-if="vmSnapshotData.backupSnapshots && vmSnapshotData.backupSnapshots.length > 0" style="margin-bottom: 30px;">
                                <h4 style="color: #9c27b0; margin-bottom: 12px;">
                                    üíæ Snapshot Backup ({{ vmSnapshotData.backupTotal || 0 }})
                                </h4>
                                <small style="color: var(--text-secondary); display: block; margin-bottom: 8px;">
                                    Snapshot di retention create per mantenere versioni multiple
                                </small>
                                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Dataset</th>
                                                <th>Snapshot</th>
                                                <th>Dimensione</th>
                                                <th>Data Creazione</th>
                                                <th>Azioni</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="snap in vmSnapshotData.backupSnapshots" :key="snap.full_name">
                                                <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">{{ snap.dataset.split('/').pop() }}</td>
                                                <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #9c27b0;">
                                                    {{ snap.snapshot }}
                                                </td>
                                                <td>{{ snap.used }}</td>
                                                <td>{{ snap.creation }}</td>
                                                <td>
                                                    <button class="btn btn-danger btn-sm" @click="rollbackToSnapshot(snap)" :disabled="loading" title="Rollback (distruttivo!)">
                                                        üîÑ Rollback
                                                    </button>
                                                    <button class="btn btn-secondary btn-sm" @click="cloneSnapshot(snap)" :disabled="loading" title="Crea clone" style="margin-left: 4px;">
                                                        üìã Clone
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Snapshot Syncoid (da job di replica) -->
                            <div v-if="vmSnapshotData.syncoidSnapshots && vmSnapshotData.syncoidSnapshots.length > 0" style="margin-bottom: 30px;">
                                <h4 style="color: #ff9f43; margin-bottom: 12px;">
                                    üîÑ Snapshot Syncoid ({{ vmSnapshotData.syncoidTotal || 0 }})
                                </h4>
                                <small style="color: var(--text-secondary); display: block; margin-bottom: 8px;">
                                    Snapshot creati durante le repliche ZFS/BTRFS
                                </small>
                                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Dataset</th>
                                                <th>Snapshot</th>
                                                <th>Dimensione</th>
                                                <th>Data Creazione</th>
                                                <th>Azioni</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="snap in vmSnapshotData.syncoidSnapshots" :key="snap.full_name">
                                                <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">{{ snap.dataset.split('/').pop() }}</td>
                                                <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #ff9f43;">
                                                    {{ snap.snapshot }}
                                                </td>
                                                <td>{{ snap.used }}</td>
                                                <td>{{ snap.creation }}</td>
                                                <td>
                                                    <button class="btn btn-danger btn-sm" @click="rollbackToSnapshot(snap)" :disabled="loading" title="Rollback (distruttivo!)">
                                                        üîÑ Rollback
                                                    </button>
                                                    <button class="btn btn-secondary btn-sm" @click="cloneSnapshot(snap)" :disabled="loading" title="Crea clone" style="margin-left: 4px;">
                                                        üìã Clone
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 13px;">
                                <strong style="color: var(--accent-warning);">‚ö†Ô∏è Attenzione:</strong>
                                <ul style="margin: 8px 0 0 20px; color: var(--text-secondary);">
                                    <li><strong>Rollback</strong>: Ripristina il dataset allo stato dello snapshot. <span style="color: var(--accent-danger);">DISTRUTTIVO - i dati successivi verranno persi!</span></li>
                                    <li><strong>Clone</strong>: Crea una copia scrivibile del dataset. Non distruttivo.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Configurazione Sanoid -->
                    <div v-if="vmSnapshotTab === 'config'">
                        <div v-if="vmSnapshotConfigLoading" style="text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 16px;">Caricamento configurazione...</p>
                        </div>
                        
                        <div v-else>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" v-model="vmSnapshotConfig.enabled" @change="saveVmSnapshotConfig()" style="width: 18px; height: 18px;">
                                    <span><strong>Abilita snapshot automatici Sanoid per questa VM</strong></span>
                                </label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 4px;">
                                    Sanoid creer√† snapshot automatici sui dataset ZFS della VM secondo la schedulazione configurata
                                </small>
                            </div>
                            
                            <div v-if="vmSnapshotConfig.enabled" style="margin-top: 20px; padding: 20px; background: var(--bg-tertiary); border-radius: 8px;">
                                <h4 style="margin-bottom: 16px; color: var(--accent-primary);">‚è∞ Schedulazione</h4>
                                
                                <div class="form-group">
                                    <label class="form-label">Preset Schedulazione</label>
                                    <select class="form-input" v-model="vmSnapshotConfigSchedulePreset" @change="onSchedulePresetChange(vmSnapshotConfig)">
                                        <option v-for="preset in schedulePresets" :key="preset.value" :value="preset.value">
                                            {{ preset.label }}
                                        </option>
                                    </select>
                                    <input v-if="vmSnapshotConfigSchedulePreset === 'custom'" type="text" class="form-input" 
                                           v-model="vmSnapshotConfig.schedule" @change="saveVmSnapshotConfig()" 
                                           placeholder="es: 0 */6 * * *" style="margin-top: 8px;">
                                </div>
                                
                                <h4 style="margin-top: 24px; margin-bottom: 16px; color: var(--accent-primary);">üìä Retention</h4>
                                
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Hourly</label>
                                        <input type="number" class="form-input" v-model.number="vmSnapshotConfig.hourly" 
                                               @change="saveVmSnapshotConfig()" min="0" max="24">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Daily</label>
                                        <input type="number" class="form-input" v-model.number="vmSnapshotConfig.daily" 
                                               @change="saveVmSnapshotConfig()" min="0" max="365">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Weekly</label>
                                        <input type="number" class="form-input" v-model.number="vmSnapshotConfig.weekly" 
                                               @change="saveVmSnapshotConfig()" min="0" max="52">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Monthly</label>
                                        <input type="number" class="form-input" v-model.number="vmSnapshotConfig.monthly" 
                                               @change="saveVmSnapshotConfig()" min="0" max="12">
                                    </div>
                                </div>
                                
                                <div class="form-group" style="margin-top: 16px;">
                                    <label class="form-label">Template</label>
                                    <select class="form-input" v-model="vmSnapshotConfig.template" @change="saveVmSnapshotConfig()">
                                        <option value="production">Production</option>
                                        <option value="default">Default</option>
                                        <option value="minimal">Minimal</option>
                                        <option value="backup">Backup</option>
                                        <option value="vm">VM</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="loadVmSnapshots()" :disabled="loading">üîÑ Aggiorna</button>
                    <button class="btn btn-primary" @click="showVmSnapshotModal = false">Chiudi</button>
                </div>
            </div>
        </div>
        
        <!-- Modals... (keeping existing but simplified) -->
        <div class="modal-overlay" v-if="isAuthenticated && showNodeModal" @click.self="showNodeModal = false">
            <div class="modal" style="max-width: 550px;">
                <div class="modal-header">
                    <h3 class="modal-title">Aggiungi Nodo</h3>
                    <button class="btn btn-icon" @click="showNodeModal = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <!-- Node Type Selection -->
                    <div class="form-group">
                        <label class="form-label">üîß Tipo Nodo</label>
                        <div style="display: flex; gap: 12px;">
                            <div class="sync-method-option" :class="{ active: newNode.node_type === 'pve' }" @click="newNode.node_type = 'pve'" style="flex: 1;">
                                <div class="sync-method-icon">üñ•Ô∏è</div>
                                <div class="sync-method-title">Proxmox VE</div>
                                <div class="sync-method-desc">Hypervisor</div>
                            </div>
                            <div class="sync-method-option" :class="{ active: newNode.node_type === 'pbs' }" @click="newNode.node_type = 'pbs'" style="flex: 1;">
                                <div class="sync-method-icon">üóÑÔ∏è</div>
                                <div class="sync-method-title">Proxmox BS</div>
                                <div class="sync-method-desc">Backup Server</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nome</label>
                        <input type="text" class="form-input" v-model="newNode.name" :placeholder="newNode.node_type === 'pbs' ? 'pbs-backup-01' : 'pve-node-01'">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hostname/IP</label>
                        <input type="text" class="form-input" v-model="newNode.hostname" placeholder="192.168.1.10">
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Porta SSH</label>
                            <input type="number" class="form-input" v-model="newNode.ssh_port">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Utente</label>
                            <input type="text" class="form-input" v-model="newNode.ssh_user">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Chiave SSH</label>
                        <input type="text" class="form-input" v-model="newNode.ssh_key_path">
                    </div>
                    
                    <!-- SSH Auto-Setup -->
                    <div style="background: rgba(76, 175, 80, 0.1); padding: 16px; border-radius: 8px; margin-top: 16px; border: 1px solid rgba(76, 175, 80, 0.3);">
                        <h4 style="color: #4caf50; margin-bottom: 12px;">üîë Setup Automatico SSH</h4>
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" v-model="newNode.auto_distribute_key" style="width: 18px; height: 18px;">
                                <span>Distribuisci automaticamente la chiave SSH al nodo</span>
                            </label>
                        </div>
                        <div class="form-group" v-if="newNode.auto_distribute_key" style="margin-bottom: 0;">
                            <label class="form-label">Password Root (per primo accesso)</label>
                            <input type="password" class="form-input" v-model="newNode.ssh_password" placeholder="Inserisci la password root del nodo">
                            <small style="color: var(--text-secondary); display: block; margin-top: 4px;">
                                La password √® necessaria solo per la prima configurazione. Dopo non sar√† pi√π richiesta.
                            </small>
                        </div>
                    </div>
                    
                    <!-- PBS Config (shown when PBS selected) -->
                    <div v-if="newNode.node_type === 'pbs'" style="background: rgba(156, 39, 176, 0.1); padding: 16px; border-radius: 8px; margin-top: 16px; border: 1px solid rgba(156, 39, 176, 0.3);">
                        <h4 style="color: #ce93d8; margin-bottom: 12px;">üóÑÔ∏è Configurazione PBS</h4>
                        <div class="form-group">
                            <label class="form-label">Datastore</label>
                            <input type="text" class="form-input" v-model="newNode.pbs_datastore" placeholder="datastore1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fingerprint SSL (opzionale)</label>
                            <input type="text" class="form-input" v-model="newNode.pbs_fingerprint" placeholder="aa:bb:cc:dd:...">
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">üë§ Utente PBS</label>
                                <input type="text" class="form-input" v-model="newNode.pbs_username" placeholder="root@pam">
                                <small style="color: var(--text-secondary);">es: root@pam, backup@pbs</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üîë Password PBS</label>
                                <input type="password" class="form-input" v-model="newNode.pbs_password" placeholder="Password utente">
                            </div>
                        </div>
                    </div>
                    
                    <!-- PVE Config (shown when PVE selected) -->
                    <div v-if="newNode.node_type === 'pve'">
                        <!-- Storage Type -->
                        <div class="form-group" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <label class="form-label">üì¶ Tipo Storage</label>
                            <select class="form-input" v-model="newNode.storage_type">
                                <option value="zfs">ZFS (Sanoid/Syncoid)</option>
                                <option value="btrfs">BTRFS</option>
                            </select>
                        </div>
                        
                        <!-- BTRFS Config (shown when BTRFS selected) -->
                        <div v-if="newNode.storage_type === 'btrfs'" style="background: rgba(255, 159, 67, 0.1); padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <h4 style="color: #ff9f43; margin-bottom: 12px;">üì¶ Configurazione BTRFS</h4>
                            <div class="form-group">
                                <label class="form-label">Mount Point BTRFS</label>
                                <input type="text" class="form-input" v-model="newNode.btrfs_mount" placeholder="/mnt/btrfs-storage">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Directory Snapshot (opzionale)</label>
                                <input type="text" class="form-input" v-model="newNode.btrfs_snapshot_dir" placeholder="Lascia vuoto per default (.snapshots)">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showNodeModal = false">Annulla</button>
                    <button class="btn btn-primary" @click="createNode" :disabled="loading">Aggiungi</button>
                </div>
            </div>
        </div>
        
        <!-- Modal Modifica Nodo -->
        <div class="modal-overlay" v-if="isAuthenticated && showEditNodeModal" @click.self="showEditNodeModal = false">
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">‚úèÔ∏è Modifica Nodo: {{ editingNode?.name }}</h3>
                    <button class="btn btn-icon" @click="showEditNodeModal = false">‚úï</button>
                </div>
                <div class="modal-body" v-if="editingNode">
                    <!-- Tipo Nodo (readonly) -->
                    <div class="form-group">
                        <label class="form-label">Tipo Nodo</label>
                        <input type="text" class="form-input" :value="editingNode.node_type === 'pbs' ? 'üóÑÔ∏è PBS' : 'üñ•Ô∏è PVE'" disabled>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Nome</label>
                            <input type="text" class="form-input" v-model="editingNode.name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hostname/IP</label>
                            <input type="text" class="form-input" v-model="editingNode.hostname">
                        </div>
                    </div>
                    
                    <div class="grid-3">
                        <div class="form-group">
                            <label class="form-label">Porta SSH</label>
                            <input type="number" class="form-input" v-model="editingNode.ssh_port">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Utente SSH</label>
                            <input type="text" class="form-input" v-model="editingNode.ssh_user">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Attivo</label>
                            <select class="form-input" v-model="editingNode.is_active">
                                <option :value="true">‚úÖ Attivo</option>
                                <option :value="false">‚è∏Ô∏è Disattivato</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Path Chiave SSH</label>
                        <input type="text" class="form-input" v-model="editingNode.ssh_key_path">
                    </div>
                    
                    <!-- PBS Config -->
                    <div v-if="editingNode.node_type === 'pbs'" style="background: rgba(156, 39, 176, 0.1); padding: 16px; border-radius: 8px; margin-top: 16px; border: 1px solid rgba(156, 39, 176, 0.3);">
                        <h4 style="color: #ce93d8; margin-bottom: 12px;">üóÑÔ∏è Configurazione PBS</h4>
                        <div class="form-group">
                            <label class="form-label">Datastore</label>
                            <input type="text" class="form-input" v-model="editingNode.pbs_datastore" placeholder="datastore1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fingerprint SSL</label>
                            <input type="text" class="form-input" v-model="editingNode.pbs_fingerprint" placeholder="aa:bb:cc:dd:...">
                            <small style="color: var(--text-secondary);">Fingerprint del certificato PBS per connessioni sicure</small>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">üë§ Utente PBS</label>
                                <input type="text" class="form-input" v-model="editingNode.pbs_username" placeholder="root@pam">
                                <small style="color: var(--text-secondary);">es: root@pam, backup@pbs</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üîë Password PBS</label>
                                <input type="password" class="form-input" v-model="editingNode.pbs_password" placeholder="Password utente">
                            </div>
                        </div>
                        <small style="color: var(--text-secondary); display: block; margin-top: 8px;">
                            Credenziali necessarie per registrazione automatica storage PBS su altri nodi
                        </small>
                    </div>
                    
                    <!-- PVE Config -->
                    <div v-if="editingNode.node_type === 'pve'">
                        <div class="form-group" style="margin-top: 16px;">
                            <label class="form-label">üì¶ Tipo Storage</label>
                            <select class="form-input" v-model="editingNode.storage_type">
                                <option value="zfs">ZFS (Sanoid/Syncoid)</option>
                                <option value="btrfs">BTRFS</option>
                            </select>
                        </div>
                        
                        <div v-if="editingNode.storage_type === 'btrfs'" style="background: rgba(255, 159, 67, 0.1); padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <h4 style="color: #ff9f43; margin-bottom: 12px;">üì¶ Configurazione BTRFS</h4>
                            <div class="form-group">
                                <label class="form-label">Mount Point</label>
                                <input type="text" class="form-input" v-model="editingNode.btrfs_mount" placeholder="/mnt/btrfs-storage">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Directory Snapshot</label>
                                <input type="text" class="form-input" v-model="editingNode.btrfs_snapshot_dir" placeholder=".snapshots">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 16px;">
                        <label class="form-label">Note</label>
                        <textarea class="form-input" v-model="editingNode.notes" rows="2" placeholder="Note opzionali sul nodo..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showEditNodeModal = false">Annulla</button>
                    <button class="btn btn-primary" @click="saveNode" :disabled="loading">üíæ Salva Modifiche</button>
                </div>
            </div>
        </div>
        
        <div class="modal-overlay" v-if="isAuthenticated && showSyncJobModal" @click.self="showSyncJobModal = false">
            <div class="modal" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 class="modal-title">{{ editingSyncJobId ? '‚úèÔ∏è Modifica Job Replica' : '‚ûï Nuovo Job Replica' }}</h3>
                    <button class="btn btn-icon" @click="showSyncJobModal = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome Job</label>
                        <input type="text" class="form-input" v-model="newSyncJob.name" placeholder="backup-vm-100">
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h4 style="margin-bottom: 12px; color: var(--accent-primary);">üì§ Sorgente</h4>
                    <div class="grid-2">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Nodo</label>
                                <select class="form-input" v-model="newSyncJob.source_node_id" @change="loadSourceDatasets">
                                    <option value="">-- Seleziona nodo --</option>
                                    <option v-for="n in nodes" :key="n.id" :value="n.id">{{ n.name }} ({{ n.hostname }})</option>
                            </select>
                        </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Dataset</label>
                                <select class="form-input" v-model="newSyncJob.source_dataset" @change="updateDestDataset" v-if="sourceDatasets.length > 0">
                                    <option value="">-- Seleziona dataset --</option>
                                    <option v-for="ds in sourceDatasets" :key="ds.name" :value="ds.name">{{ ds.name }}</option>
                            </select>
                                <input type="text" class="form-input" v-model="newSyncJob.source_dataset" @input="updateDestDataset" placeholder="rpool/data/vm-100-disk-0" v-else>
                        </div>
                    </div>
                        </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h4 style="margin-bottom: 12px; color: var(--accent-secondary);">üì• Destinazione</h4>
                        <div class="form-group">
                            <label class="form-label">Nodo</label>
                            <select class="form-input" v-model="newSyncJob.dest_node_id" @change="onDestNodeChange">
                                <option value="">-- Seleziona nodo --</option>
                                <option v-for="n in nodes" :key="n.id" :value="n.id">{{ n.name }} ({{ n.hostname }})</option>
                            </select>
                        </div>
                        <div class="form-group" v-if="newSyncJob.dest_node_id">
                            <label class="form-label">Pool/Root Destinazione</label>
                            <div style="display: flex; gap: 8px;">
                                <select class="form-input" v-model="destRootPool" @change="updateDestDataset" style="flex: 1;">
                                    <option value="">-- Seleziona pool --</option>
                                    <option v-for="pool in destPools" :key="pool" :value="pool">{{ pool }}</option>
                                </select>
                                <input type="text" class="form-input" v-model="destSubPath" @input="updateDestDataset" 
                                       placeholder="replica" style="flex: 1;">
                    </div>
                            <small style="color: var(--text-secondary);">Pool + sottocartella (es: replica, backup)</small>
                    </div>
                        <div class="form-group" style="margin-bottom: 0;" v-if="newSyncJob.dest_node_id">
                            <label class="form-label">Dataset Destinazione Finale</label>
                            <input type="text" class="form-input" v-model="newSyncJob.dest_dataset" 
                                   placeholder="ZFS/replica/vm-202-disk-0"
                                   style="font-family: 'JetBrains Mono', monospace; background: var(--bg-primary);">
                            <small v-if="newSyncJob.source_dataset && suggestedDestDataset" style="color: var(--accent-primary); cursor: pointer;" @click="newSyncJob.dest_dataset = suggestedDestDataset">
                                üí° Clicca per usare: <strong>{{ suggestedDestDataset }}</strong>
                            </small>
                        </div>
                    </div>
                    
                    <!-- Compatibility Warnings -->
                    <div v-if="syncJobCompatibility.loading" style="padding: 12px; text-align: center; color: var(--text-secondary);">
                        <span class="spinner" style="margin-right: 8px;"></span> Verifica compatibilit√†...
                    </div>
                    <div v-else-if="syncJobCompatibility.warnings && syncJobCompatibility.warnings.length > 0" 
                         style="margin: 16px 0; padding: 12px; border-radius: 8px; background: var(--bg-primary); border: 1px solid var(--border-color);">
                        <h5 style="margin: 0 0 8px 0; color: var(--accent-warning);">‚ö†Ô∏è Avvisi Compatibilit√†</h5>
                        <div v-for="(warn, idx) in syncJobCompatibility.warnings" :key="idx" 
                             :style="{
                                 padding: '8px 12px',
                                 marginBottom: '8px',
                                 borderRadius: '6px',
                                 background: warn.level === 'error' ? 'rgba(255,82,82,0.1)' : warn.level === 'warning' ? 'rgba(255,159,67,0.15)' : 'rgba(0,184,148,0.1)',
                                 borderLeft: warn.level === 'error' ? '3px solid #ff5252' : warn.level === 'warning' ? '3px solid #ff9f43' : '3px solid #00b894'
                             }">
                            <div style="font-weight: 500;" :style="{ color: warn.level === 'error' ? '#ff5252' : warn.level === 'warning' ? '#ff9f43' : '#00b894' }">
                                {{ warn.type === 'network' ? 'üîå' : warn.type === 'cpu' ? 'üíª' : 'üíæ' }} {{ warn.message }}
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 4px;">{{ warn.details }}</div>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Schedule</label>
                            <select class="form-input" v-model="newSyncJob.schedulePreset" @change="onSchedulePresetChange(newSyncJob)">
                                <option v-for="preset in schedulePresets" :key="preset.value" :value="preset.value">
                                    {{ preset.label }}
                                </option>
                            </select>
                            <input v-if="newSyncJob.schedulePreset === 'custom'" type="text" class="form-input" v-model="newSyncJob.schedule" placeholder="es: 0 2 * * *" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Compressione</label>
                            <select class="form-input" v-model="newSyncJob.compress">
                                <option value="none">Nessuna</option>
                                <option value="lz4">LZ4 (veloce)</option>
                                <option value="gzip">Gzip (bilanciato)</option>
                                <option value="zstd">Zstd (efficiente)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üì∏ Versioni da mantenere</label>
                            <input type="number" class="form-input" v-model.number="newSyncJob.keep_snapshots" min="0" max="100" placeholder="0">
                            <small style="color: var(--text-secondary);">0 = solo ultima, N = mantieni ultime N snapshot</small>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">üìß Notifiche Email</label>
                            <select class="form-input" v-model="newSyncJob.notify_mode">
                                <option value="daily">üìÖ Solo nel riepilogo giornaliero</option>
                                <option value="always">üì® Ad ogni esecuzione</option>
                                <option value="failure">‚ö†Ô∏è Solo in caso di errore</option>
                                <option value="never">üîï Disabilitate</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Soggetto Email</label>
                            <input type="text" class="form-input" v-model="newSyncJob.notify_subject" placeholder="[REPLICA ZFS] {vm_name}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" v-model="newSyncJob.recursive"> Ricorsivo (include sotto-dataset)
                        </label>
                    </div>
                    
                    <hr style="border-color: var(--border-color); margin: 20px 0;">
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" v-model="newSyncJob.register_vm"> üñ•Ô∏è Registra VM dopo replica
                        </label>
                        <small style="color: var(--text-secondary); display: block;">La VM verr√† registrata sul nodo destinazione in stato spento</small>
                    </div>
                    
                    <div v-if="newSyncJob.register_vm" style="background: rgba(0, 212, 255, 0.1); padding: 16px; border-radius: 8px; border: 1px solid var(--accent-secondary);">
                        <div class="grid-3">
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label class="form-label">VMID Sorgente</label>
                                <input type="number" class="form-input" v-model="newSyncJob.vm_id" placeholder="100">
                            </div>
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label class="form-label">VMID Destinazione <small style="color: var(--text-secondary);">(opz.)</small></label>
                                <input type="number" class="form-input" v-model="newSyncJob.dest_vm_id" :placeholder="newSyncJob.vm_id || '100'">
                            </div>
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label class="form-label">Suffisso Nome VM</label>
                                <input type="text" class="form-input" v-model="newSyncJob.dest_vm_name_suffix" placeholder="-replica">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label class="form-label">Tipo VM</label>
                                <select class="form-input" v-model="newSyncJob.vm_type">
                                    <option value="qemu">QEMU/KVM</option>
                                    <option value="lxc">LXC Container</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" v-model="newSyncJob.force_cpu_host">
                                    üíª Forza CPU "host"
                                </label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 4px;">
                                    Risolve incompatibilit√† CPU tra nodi diversi
                                </small>
                            </div>
                        </div>
                        <small style="color: var(--text-secondary); display: block; margin-top: 8px;">
                            üí° Il suffisso verr√† aggiunto al nome della VM (es: web01 ‚Üí web01-replica)
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showSyncJobModal = false">Annulla</button>
                    <button class="btn btn-primary" @click="createSyncJob" :disabled="loading">
                        <span v-if="loading" class="spinner"></span>
                        <span v-else>Crea Job</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Migration Job Modal -->
        <div class="modal-overlay" v-if="isAuthenticated && showMigrationJobModal" @click.self="showMigrationJobModal = false">
            <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3 class="modal-title">{{ editingMigrationJobId ? '‚úèÔ∏è Modifica Job Migrazione' : '‚ûï Nuovo Job Migrazione' }}</h3>
                    <button class="btn btn-icon" @click="showMigrationJobModal = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome Job *</label>
                        <input type="text" class="form-input" v-model="newMigrationJob.name" placeholder="migrazione-vm-100">
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">üì§ Nodo Sorgente *</label>
                            <select class="form-input" v-model="newMigrationJob.source_node_id" @change="loadMigrationSourceVMs">
                                <option value="">-- Seleziona nodo --</option>
                                <option v-for="n in nodes" :key="n.id" :value="n.id">{{ n.name }} ({{ n.hostname }})</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üì• Nodo Destinazione *</label>
                            <select class="form-input" v-model="newMigrationJob.dest_node_id" @change="loadMigrationDestResources">
                                <option value="">-- Seleziona nodo --</option>
                                <option v-for="n in nodes" :key="n.id" :value="n.id" :disabled="n.id == newMigrationJob.source_node_id">{{ n.name }} ({{ n.hostname }})</option>
                            </select>
                        </div>
                    </div>
                    
                    <div v-if="newMigrationJob.source_node_id" class="form-group">
                        <label class="form-label">üñ•Ô∏è VM da Migrare *</label>
                        <select class="form-input" v-model="newMigrationJob.vm_id" @change="loadMigrationVmDetails">
                            <option value="">-- Seleziona VM --</option>
                            <option v-for="vm in sourceVMs" :key="vm.vmid" :value="vm.vmid">
                                {{ vm.vmid }} - {{ vm.name || '(senza nome)' }} ({{ vm.type }})
                            </option>
                        </select>
                    </div>
                    
                    <div v-if="selectedMigrationVm" style="background: rgba(0, 212, 255, 0.1); padding: 16px; border-radius: 8px; margin: 16px 0;">
                        <h4 style="margin-bottom: 12px;">‚öôÔ∏è Riconfigurazione Hardware</h4>
                        
                        <!-- CPU e RAM -->
                        <div class="grid-3">
                            <div class="form-group">
                                <label class="form-label">RAM (MB)</label>
                                <input type="number" class="form-input" v-model.number="newMigrationJob.hw_config.memory" 
                                       :placeholder="selectedMigrationVm.memory || '1024'">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CPU Cores</label>
                                <input type="number" class="form-input" v-model.number="newMigrationJob.hw_config.cores" 
                                       :placeholder="selectedMigrationVm.cores || '1'">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CPU Sockets</label>
                                <input type="number" class="form-input" v-model.number="newMigrationJob.hw_config.sockets" 
                                       :placeholder="selectedMigrationVm.sockets || '1'">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">CPU Type</label>
                            <select class="form-input" v-model="newMigrationJob.hw_config.cpu">
                                <option value="">Mantieni originale</option>
                                <option value="host">host</option>
                                <option value="x86-64-v2-AES">x86-64-v2-AES</option>
                                <option value="x86-64-v3">x86-64-v3</option>
                                <option value="x86-64-v4">x86-64-v4</option>
                            </select>
                        </div>
                        
                        <!-- Network Cards -->
                        <div v-if="migrationVmNetworks.length > 0" style="margin-top: 16px;">
                            <h5 style="margin-bottom: 8px;">üîå Network Cards</h5>
                            <div v-for="(net, idx) in migrationVmNetworks" :key="idx" style="margin-bottom: 12px; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong>{{ net.interface }}</strong>
                                    <span style="font-size: 0.85em; color: var(--text-secondary);">{{ net.current_bridge || 'N/A' }}</span>
                                </div>
                                <select class="form-input" v-model="newMigrationJob.hw_config.network[net.interface]" 
                                        @change="updateNetworkConfig(net.interface)">
                                    <option :value="null">Mantieni bridge originale</option>
                                    <option v-for="bridge in destNodeBridges" :key="bridge" :value="`bridge=${bridge}`">
                                        {{ bridge }}
                                    </option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Dischi -->
                        <div v-if="migrationVmDisks.length > 0" style="margin-top: 16px;">
                            <h5 style="margin-bottom: 8px;">üíæ Dischi</h5>
                            <div v-for="(disk, idx) in migrationVmDisks" :key="idx" style="margin-bottom: 12px; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong>{{ disk.name }}</strong>
                                    <span style="font-size: 0.85em; color: var(--text-secondary);">{{ disk.size || 'N/A' }}</span>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="color: var(--text-secondary);">Storage attuale: {{ disk.storage || 'N/A' }}</span>
                                </div>
                                <select class="form-input" v-model="newMigrationJob.hw_config.storage[disk.name]" 
                                        style="margin-top: 8px;">
                                    <option :value="null">Mantieni storage originale</option>
                                    <option v-for="storage in destNodeStorages" :key="storage.storage" :value="storage.storage">
                                        {{ storage.storage }} ({{ storage.type }}) - {{ storage.avail || 'N/A' }} disponibile
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <hr style="border-color: var(--border-color); margin: 20px 0;">
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">VMID Destinazione</label>
                            <input type="number" class="form-input" v-model.number="newMigrationJob.dest_vm_id" 
                                   :placeholder="newMigrationJob.vm_id || '100'">
                            <small style="color: var(--text-secondary);">Lascia vuoto per usare stesso VMID</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Suffisso Nome VM</label>
                            <input type="text" class="form-input" v-model="newMigrationJob.dest_vm_name_suffix" placeholder="-migrated">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Tipo Migrazione</label>
                            <select class="form-input" v-model="newMigrationJob.migration_type">
                                <option value="copy">üìã Copia (mantiene originale)</option>
                                <option value="move">üöö Sposta (elimina originale)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üì∏ Snapshot</label>
                            <div>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" v-model="newMigrationJob.create_snapshot">
                                    Crea snapshot prima della migrazione
                                </label>
                                <input v-if="newMigrationJob.create_snapshot" type="number" class="form-input" 
                                       v-model.number="newMigrationJob.keep_snapshots" min="1" max="10" 
                                       style="margin-top: 8px;">
                                <small style="color: var(--text-secondary); display: block; margin-top: 4px;">
                                    Mantieni ultimi N snapshot (1 per migrazione, pi√π per replica)
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" v-model="newMigrationJob.start_after_migration">
                            ‚ñ∂Ô∏è Avvia VM dopo migrazione
                        </label>
                    </div>
                    
                    <hr style="border-color: var(--border-color); margin: 20px 0;">
                    
                    <div class="form-group">
                        <label class="form-label">Schedule</label>
                        <select class="form-input" v-model="newMigrationJob.schedulePreset" @change="onSchedulePresetChange(newMigrationJob)">
                            <option v-for="preset in schedulePresets" :key="preset.value" :value="preset.value">
                                {{ preset.label }}
                            </option>
                        </select>
                        <input v-if="newMigrationJob.schedulePreset === 'custom'" type="text" class="form-input" 
                               v-model="newMigrationJob.schedule" placeholder="es: 0 2 * * *" style="margin-top: 8px;">
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">üìß Notifiche Email</label>
                            <select class="form-input" v-model="newMigrationJob.notify_mode">
                                <option value="daily">üìÖ Solo nel riepilogo giornaliero</option>
                                <option value="always">üì® Ad ogni esecuzione</option>
                                <option value="failure">‚ö†Ô∏è Solo in caso di errore</option>
                                <option value="never">üîï Disabilitate</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Soggetto Email</label>
                            <input type="text" class="form-input" v-model="newMigrationJob.notify_subject" 
                                   placeholder="[MIGRAZIONE] {vm_name}">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showMigrationJobModal = false">Annulla</button>
                    <button class="btn btn-primary" @click="saveMigrationJob" :disabled="loading">
                        <span v-if="loading" class="spinner"></span>
                        <span v-else>{{ editingMigrationJobId ? 'Salva' : 'Crea Job' }}</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Sync Job Snapshot Management Modal -->
        <div class="modal-overlay" v-if="isAuthenticated && showSyncSnapshotModal" @click.self="showSyncSnapshotModal = false">
            <div class="modal" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title">üì∏ Versioni Disponibili - {{ syncSnapshotJob?.name }}</h3>
                    <button class="btn btn-icon" @click="showSyncSnapshotModal = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <div v-if="syncSnapshotLoading" style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 16px; color: var(--text-secondary);">Caricamento snapshot...</p>
                    </div>
                    
                    <div v-else-if="syncJobSnapshots.length === 0" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 16px;">üì≠</div>
                        <p>Nessuna snapshot trovata sul dataset destinazione.</p>
                        <p style="font-size: 0.9rem;">Le snapshot vengono create automaticamente durante la replica.</p>
                    </div>
                    
                    <div v-else>
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                            <strong>Dataset:</strong> {{ syncSnapshotJob?.dest_dataset }}<br>
                            <strong>Snapshot disponibili:</strong> {{ syncJobSnapshots.length }}
                            <span v-if="syncSnapshotJob?.keep_snapshots > 0" style="color: var(--accent-info);">
                                (retention: {{ syncSnapshotJob.keep_snapshots }})
                            </span>
                        </div>
                        
                        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Snapshot</th>
                                        <th>Data</th>
                                        <th>Usato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="snap in syncJobSnapshots" :key="snap.name">
                                        <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">
                                            {{ snap.snapshot_name }}
                                        </td>
                                        <td>{{ formatDate(snap.creation) }}</td>
                                        <td>{{ snap.used || '-' }}</td>
                                        <td>
                                            <button class="btn btn-primary btn-sm" @click="rollbackSyncSnapshot(snap)" :disabled="loading" title="Ripristina">
                                                ‚è™ Rollback
                                            </button>
                                            <button class="btn btn-secondary btn-sm" @click="cloneSyncJobSnapshot(snap)" :disabled="loading" title="Clona">
                                                üìã Clone
                                            </button>
                                            <button class="btn btn-danger btn-sm" @click="deleteSyncSnapshot(snap)" :disabled="loading" title="Elimina">
                                                üóëÔ∏è
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border: 1px solid var(--accent-warning);">
                            <strong style="color: var(--accent-warning);">‚ö†Ô∏è Attenzione:</strong>
                            <ul style="margin: 8px 0 0 20px; color: var(--text-secondary);">
                                <li><strong>Rollback</strong>: Ripristina il dataset allo stato della snapshot. Le modifiche successive verranno perse!</li>
                                <li><strong>Clone</strong>: Crea una copia del dataset allo stato della snapshot (non distruttivo).</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showSyncSnapshotModal = false">Chiudi</button>
                    <button class="btn btn-primary" @click="loadSyncJobSnapshots(syncSnapshotJob)" :disabled="syncSnapshotLoading">
                        üîÑ Aggiorna
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Sync Job Clone Snapshot Modal -->
        <div class="modal-overlay" v-if="showSyncCloneModal" @click.self="showSyncCloneModal = false">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 class="modal-title">üìã Clona Snapshot</h3>
                    <button class="btn btn-icon" @click="showSyncCloneModal = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 16px;">
                        Clona la snapshot <strong>{{ syncCloneSourceSnap?.snapshot_name }}</strong> in un nuovo dataset.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Nome del clone</label>
                        <input type="text" class="form-input" v-model="syncCloneName" placeholder="es: vm-100-recovery">
                        <small style="color: var(--text-secondary);">
                            Il clone verr√† creato in: {{ syncSnapshotJob?.dest_dataset?.split('/')[0] }}/{{ syncCloneName || '...' }}
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showSyncCloneModal = false">Annulla</button>
                    <button class="btn btn-primary" @click="confirmSyncClone" :disabled="!syncCloneName || loading">
                        <span v-if="loading" class="spinner"></span>
                        <span v-else>Crea Clone</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="modal-overlay" v-if="isAuthenticated && showUserModal" @click.self="showUserModal = false">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">{{ editingUser ? 'Modifica' : 'Nuovo' }} Utente</h3>
                    <button class="btn btn-icon" @click="showUserModal = false">‚úï</button>
            </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" v-model="newUser.username" :disabled="editingUser">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" v-model="newUser.email">
                    </div>
                    <div class="form-group" v-if="!editingUser">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" v-model="newUser.password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nome Completo</label>
                        <input type="text" class="form-input" v-model="newUser.full_name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ruolo</label>
                        <select class="form-input" v-model="newUser.role">
                            <option value="admin">Admin</option>
                            <option value="operator">Operator</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showUserModal = false">Annulla</button>
                    <button class="btn btn-primary" @click="saveUser" :disabled="loading">Salva</button>
                </div>
            </div>
        </div>
        
        <!-- Modal Snapshot -->
        <div class="modal-overlay" v-if="isAuthenticated && showSnapshotModal" @click.self="showSnapshotModal = false">
            <div class="modal" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">üì∑ Snapshot - VM {{ snapshotModalData.vmId }}</h3>
                    <button class="btn btn-icon" @click="showSnapshotModal = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <!-- Tab per sorgente/destinazione -->
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button class="btn" :class="snapshotTab === 'source' ? 'btn-primary' : 'btn-secondary'" @click="snapshotTab = 'source'">
                            üì§ Sorgente ({{ snapshotModalData.sourceSnapshots.length }})
                        </button>
                        <button class="btn" :class="snapshotTab === 'dest' ? 'btn-primary' : 'btn-secondary'" @click="snapshotTab = 'dest'">
                            üì• Destinazione ({{ snapshotModalData.destSnapshots.length }})
                        </button>
                    </div>
                    
                    <!-- Snapshot Sorgente -->
                    <div v-if="snapshotTab === 'source'">
                        <h4 style="color: var(--accent-primary); margin-bottom: 12px;">
                            üì§ {{ snapshotModalData.sourceNode }} - Snapshot Sorgente
                        </h4>
                        <div v-if="snapshotModalData.loadingSource" style="text-align: center; padding: 20px;">
                            ‚è≥ Caricamento...
                        </div>
                        <div v-else-if="snapshotModalData.sourceSnapshots.length === 0" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            Nessuno snapshot trovato
                        </div>
                        <div v-else class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table>
                                <thead><tr><th>Dataset</th><th>Snapshot</th><th>Dimensione</th><th>Data Creazione</th></tr></thead>
                                <tbody>
                                    <tr v-for="snap in snapshotModalData.sourceSnapshots" :key="snap.full_name">
                                        <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">{{ snap.dataset.split('/').pop() }}</td>
                                        <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--accent-primary);">{{ snap.snapshot }}</td>
                                        <td>{{ snap.used }}</td>
                                        <td>{{ snap.creation }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Snapshot Destinazione -->
                    <div v-if="snapshotTab === 'dest'">
                        <h4 style="color: var(--accent-secondary); margin-bottom: 12px;">
                            üì• {{ snapshotModalData.destNode }} - Snapshot Destinazione
                        </h4>
                        <div v-if="snapshotModalData.loadingDest" style="text-align: center; padding: 20px;">
                            ‚è≥ Caricamento...
                        </div>
                        <div v-else-if="snapshotModalData.destSnapshots.length === 0" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            Nessuno snapshot trovato (la replica potrebbe non essere ancora stata eseguita)
                        </div>
                        <div v-else class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table>
                                <thead><tr><th>Dataset</th><th>Snapshot</th><th>Dimensione</th><th>Data Creazione</th></tr></thead>
                                <tbody>
                                    <tr v-for="snap in snapshotModalData.destSnapshots" :key="snap.full_name">
                                        <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">{{ snap.dataset.split('/').pop() }}</td>
                                        <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--accent-secondary);">{{ snap.snapshot }}</td>
                                        <td>{{ snap.used }}</td>
                                        <td>{{ snap.creation }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showSnapshotModal = false">Chiudi</button>
                    <button class="btn btn-primary" @click="refreshSnapshots" :disabled="loading">üîÑ Aggiorna</button>
                </div>
            </div>
        </div>
        
        <!-- Info Modal -->
        <div class="modal-overlay" v-if="showInfoModal" @click.self="showInfoModal = false">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 class="modal-title">‚ÑπÔ∏è Informazioni</h3>
                    <button class="btn btn-icon" @click="showInfoModal = false">‚úï</button>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <img src="images/domarc-logo.png" alt="Domarc" style="max-width: 180px; margin-bottom: 20px;">
                    
                    <h2 style="margin-bottom: 8px;">DAPX-backandrepl</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Backup & Replica per Proxmox</p>
                    
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary);">Versione:</span>
                            <strong>3.3.0</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary);">Release:</span>
                            <strong>Dicembre 2025</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Licenza:</span>
                            <strong>Proprietaria</strong>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 16px;">
                        <p style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">
                            ¬© 2025 <strong>Domarc S.r.l.</strong>
                        </p>
                        <p style="font-size: 0.85em; color: var(--text-muted);">
                            Tutti i diritti riservati. Questo software √® propriet√† esclusiva di Domarc S.r.l.<br>
                            L'uso non autorizzato √® vietato.
                        </p>
                        <p style="font-size: 0.85em; color: var(--accent-primary); margin-top: 12px;">
                            <a href="https://www.domarc.it" target="_blank" style="color: var(--accent-primary);">www.domarc.it</a>
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" @click="showInfoModal = false">Chiudi</button>
                </div>
            </div>
        </div>
        
        <!-- Toast -->
        <div class="toast-container">
            <div v-for="toast in toasts" :key="toast.id" class="toast" :class="'toast-' + toast.type">{{ toast.message }}</div>
        </div>
    </div>
    
    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        const API = '/api';
        
        // Setup axios interceptor
        axios.interceptors.request.use(config => {
            const token = localStorage.getItem('access_token');
            if (token) config.headers.Authorization = `Bearer ${token}`;
            return config;
        });
        
        axios.interceptors.response.use(
            response => response,
            error => {
                if (error.response?.status === 401) {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user');
                    window.location.reload();
                }
                return Promise.reject(error);
            }
        );
        
        createApp({
            setup() {
                // Auth state
                const isAuthenticated = ref(false);
                const setupRequired = ref(false);
                const currentUser = ref(null);
                const authConfig = ref({ auth_method: 'local', realms: [], allow_local_fallback: true });
                
                const loginForm = ref({ username: '', password: '', realm: 'pam' });
                const setupForm = ref({ username: '', email: '', password: '', full_name: '' });
                const loginError = ref('');
                
                // Schedule presets per job
                const schedulePresets = [
                    { value: '', label: '‚è∏Ô∏è Manuale (disattivato)', cron: '' },
                    { value: '*/30 * * * *', label: '‚è±Ô∏è Ogni 30 minuti', cron: '*/30 * * * *' },
                    { value: '0 * * * *', label: '‚è±Ô∏è Ogni ora', cron: '0 * * * *' },
                    { value: '0 */2 * * *', label: '‚è±Ô∏è Ogni 2 ore', cron: '0 */2 * * *' },
                    { value: '0 */4 * * *', label: '‚è±Ô∏è Ogni 4 ore', cron: '0 */4 * * *' },
                    { value: '0 */6 * * *', label: '‚è±Ô∏è Ogni 6 ore', cron: '0 */6 * * *' },
                    { value: '0 */12 * * *', label: '‚è±Ô∏è Ogni 12 ore', cron: '0 */12 * * *' },
                    { value: '0 2 * * *', label: 'üåô Ogni giorno alle 2:00', cron: '0 2 * * *' },
                    { value: '0 2 * * 0', label: 'üìÖ Ogni domenica alle 2:00', cron: '0 2 * * 0' },
                    { value: 'custom', label: '‚úèÔ∏è Personalizzato...', cron: '' }
                ];
                
                // App state
                const currentPage = ref('dashboard');
                const settingsTab = ref('general');
                const loading = ref(false);
                const toasts = ref([]);
                
                // Data
                const nodes = ref([]);
                const syncJobs = ref([]);
                const recentLogs = ref([]);
                const allLogs = ref([]);
                const datasets = ref([]);
                const snapshots = ref([]);
                const nodeVms = ref([]);
                const showVmBackupsModal = ref(false);
                const selectedVmForBackups = ref(null);
                const vmBackupsList = ref([]);
                const users = ref([]);
                
                // Dashboard data
                const dashboardOverview = ref(null);
                const dashboardNodes = ref([]);
                const dashboardVMs = ref([]);
                const dashboardDataFromCache = ref(false);
                
                // Detail pages data
                const selectedNodeDetail = ref(null);
                const selectedVMDetail = ref(null);
                const loadingNodeDetail = ref(false);
                const loadingVMDetail = ref(false);
                
                const selectedNodeId = ref('');
                const selectedVmNodeId = ref('');
                
                // Settings
                const settings = ref({ syncoid_default_compress: 'lz4', syncoid_default_mbuffer: '128M', log_retention_days: 30 });
                const authSettings = ref({ auth_method: 'proxmox', auth_session_timeout: 480, auth_allow_local_fallback: true });
                const notifSettings = ref({ 
                    smtp_enabled: false, 
                    smtp_host: '', 
                    smtp_port: 587, 
                    smtp_user: '',
                    smtp_password: '',
                    smtp_from: '',
                    smtp_to: '',
                    smtp_subject_prefix: '[DAPX]',
                    smtp_tls: true,
                    notify_on_failure: true, 
                    notify_on_success: false,
                    notify_on_warning: true
                });
                const dailySummaryHour = ref(8);
                
                // Modals
                const showNodeModal = ref(false);
                const showEditNodeModal = ref(false);
                const editingNode = ref(null);
                const showSyncJobModal = ref(false);
                const editingSyncJobId = ref(null);
                
                // Sync Job Snapshot management
                const showSyncSnapshotModal = ref(false);
                const syncSnapshotJob = ref(null);
                const syncJobSnapshots = ref([]);
                const syncSnapshotLoading = ref(false);
                const showSyncCloneModal = ref(false);
                const syncCloneSourceSnap = ref(null);
                const syncCloneName = ref('');
                
                const showUserModal = ref(false);
                const showInfoModal = ref(false);
                const editingUser = ref(null);
                const selectedLog = ref(null);
                
                // SSH Keys
                const sshKeyInfo = ref({ exists: false, public_key: '', key_type: '', fingerprint: '', comment: '' });
                const sshTestResults = ref({});
                const showDistributeModal = ref(false);
                const distributePassword = ref('');
                const selectedNodesForDistribute = ref([]);
                const distributeResults = ref([]);
                
                // SSL/HTTPS Configuration
                const sslStatus = ref(null);
                const sslLoading = ref(false);
                const sslGenHostname = ref('');
                const sslGenDays = ref(365);
                const sslGenIps = ref('');
                const sslUploadCert = ref('');
                const sslUploadKey = ref('');
                
                // VM Snapshot Management
                const showVmSnapshotModal = ref(false);
                const vmSnapshotData = ref({
                    vmId: null,
                    vmName: '',
                    nodeId: null,
                    nodeName: '',
                    total: 0,
                    datasets: {},
                    loading: false
                });
                
                // Snapshot Modal
                const showSnapshotModal = ref(false);
                const snapshotTab = ref('source');
                const snapshotModalData = ref({
                    vmId: null,
                    sourceNodeId: null,
                    destNodeId: null,
                    sourceNode: '',
                    destNode: '',
                    sourceDatasets: [],
                    destDatasets: [],
                    sourceSnapshots: [],
                    destSnapshots: [],
                    loadingSource: false,
                    loadingDest: false
                });
                
                // Forms
                const newNode = ref({ 
                    name: '', 
                    hostname: '', 
                    ssh_port: 22, 
                    ssh_user: 'root', 
                    ssh_key_path: '/root/.ssh/id_rsa',
                    // Node type: pve (Proxmox VE) or pbs (Proxmox Backup Server)
                    node_type: 'pve',
                    // PBS specific
                    pbs_datastore: 'datastore1',
                    pbs_fingerprint: '',
                    pbs_username: 'root@pam',
                    pbs_password: '',
                    // BTRFS support (only for PVE nodes)
                    storage_type: 'zfs',
                    btrfs_mount: '/mnt/btrfs-storage',
                    btrfs_snapshot_dir: '',
                    // SSH auto-setup
                    ssh_password: '',
                    auto_distribute_key: true
                });
                const newSyncJob = ref({ 
                    name: '', 
                    source_node_id: '', 
                    source_dataset: '', 
                    dest_node_id: '', 
                    dest_dataset: '', 
                    schedule: '', 
                    schedulePreset: '',
                    compress: 'lz4', 
                    recursive: false, 
                    register_vm: false, 
                    vm_id: '', 
                    dest_vm_id: '', 
                    dest_vm_name_suffix: '',
                    vm_type: 'qemu',
                    notify_mode: 'daily',
                    notify_subject: '',
                    keep_snapshots: 0,  // 0 = solo ultima, N = mantieni ultime N
                    force_cpu_host: true,  // Forza CPU host per compatibilit√†
                    // BTRFS support
                    sync_method: 'syncoid',
                    btrfs_snapshot_dir: '',
                    btrfs_dest_snapshot_dir: '',
                    btrfs_max_snapshots: 5,
                    btrfs_full_sync: false,
                    disk_name: ''
                });
                const syncJobCompatibility = ref({ warnings: [], info: {}, loading: false });
                const newUser = ref({ username: '', email: '', password: '', full_name: '', role: 'viewer' });
                const sourceDatasets = ref([]);
                const destDatasets = ref([]);
                
                // Recovery Jobs (PBS)
                const recoveryJobs = ref([]);
                const pbsNodes = ref([]);
                const pveNodes = ref([]);
                const showAddRecoveryJobModal = ref(false);
                const sourceVmsForRecovery = ref([]);
                
                // PBS Browse
                const pbsBrowseData = ref({
                    nodeId: null,
                    nodeName: '',
                    datastore: '',
                    backups: [],
                    loading: false
                });
                
                // Restore from PBS (pagina dedicata)
                const selectedRestorePbs = ref(null);
                const restorePbsBackups = ref([]);
                const showRestoreModal = ref(false);
                const expandedBackupGroups = ref({});
                const restoreData = ref({
                    backup_id: '',
                    vmid: '',
                    vm_name: '',
                    vm_type: 'qemu',
                    pbs_node_id: '',
                    dest_node_id: '',
                    dest_vmid: '',
                    dest_vm_name: '',
                    dest_storage: '',
                    start_after_restore: false
                });
                const restoreStorages = ref([]);
                
                // Host Config Backup
                const hostBackup = ref({
                    selectedNodeId: '',
                    hostType: '',
                    paths: [],
                    totalSize: 0,
                    totalSizeHuman: '',
                    existingPaths: 0,
                    compress: true,
                    encrypt: false,
                    encryptPassword: '',
                    destPath: '/var/backups/proxmox-config',
                    backups: []
                });
                const hostBackupJobs = ref([]);
                const hostBackupJob = ref({
                    name: '',
                    node_id: '',
                    dest_path: '/var/backups/proxmox-config',
                    compress: true,
                    encrypt: false,
                    encrypt_password: '',
                    keep_last: 7,
                    schedule: '',
                    schedulePreset: '',
                    is_active: true,
                    notify_mode: 'daily',
                    notify_subject: ''
                });
                const showHostRetentionModal = ref(false);
                const hostRetentionCount = ref(7);
                
                // Computed: raggruppa backup per VM/CT ID
                const groupedRestoreBackups = computed(() => {
                    const groups = {};
                    for (const backup of restorePbsBackups.value) {
                        const key = `${backup.vm_type || 'vm'}_${backup.vmid}`;
                        if (!groups[key]) {
                            groups[key] = [];
                        }
                        groups[key].push(backup);
                    }
                    // Ordina ogni gruppo per data (pi√π recente prima)
                    for (const key in groups) {
                        groups[key].sort((a, b) => (b.backup_time || 0) - (a.backup_time || 0));
                    }
                    // Ordina i gruppi per VMID
                    const sortedGroups = {};
                    Object.keys(groups).sort((a, b) => {
                        const vmidA = parseInt(a.split('_')[1]) || 0;
                        const vmidB = parseInt(b.split('_')[1]) || 0;
                        return vmidA - vmidB;
                    }).forEach(key => {
                        sortedGroups[key] = groups[key];
                    });
                    return sortedGroups;
                });
                
                const toggleBackupGroup = (vmKey) => {
                    expandedBackupGroups.value[vmKey] = !expandedBackupGroups.value[vmKey];
                };
                
                // Backup Jobs
                const backupJobs = ref([]);
                const sourceVmsForBackup = ref([]);
                const backupPbsStorages = ref([]);
                const showEditBackupJobModal = ref(false);
                const editingBackupJob = ref(null);
                const newBackupJob = ref({
                    name: '',
                    source_node_id: '',
                    vm_id: '',
                    vm_type: 'qemu',
                    vm_name: '',
                    pbs_node_id: '',
                    pbs_storage_id: '',
                    backup_mode: 'snapshot',
                    backup_compress: 'zstd',
                    keep_last: 3,
                    schedule: '',
                    schedulePreset: '',
                    notify_mode: 'daily',
                    notify_subject: '',
                    is_active: true
                });
                // Migration Jobs
                const migrationJobs = ref([]);
                const showMigrationJobModal = ref(false);
                const editingMigrationJobId = ref(null);
                const selectedMigrationVm = ref(null);
                const migrationVmDisks = ref([]);
                const migrationVmNetworks = ref([]);
                const destNodeStorages = ref([]);
                const destNodeBridges = ref([]);
                const newMigrationJob = ref({
                    name: '',
                    source_node_id: '',
                    vm_id: '',
                    vm_type: 'qemu',
                    dest_node_id: '',
                    dest_vm_id: '',
                    dest_vm_name_suffix: '',
                    migration_type: 'copy',
                    create_snapshot: true,
                    keep_snapshots: 1,
                    start_after_migration: false,
                    hw_config: {
                        memory: null,
                        cores: null,
                        sockets: null,
                        cpu: null,
                        network: {},
                        storage: {}
                    },
                    schedule: '',
                    schedulePreset: '',
                    notify_mode: 'daily',
                    notify_subject: ''
                });
                const newRecoveryJob = ref({
                    name: '',
                    source_node_id: '',
                    vm_id: '',
                    vm_type: 'qemu',
                    vm_name: '',
                    pbs_node_id: '',
                    pbs_datastore: '',
                    pbs_storage_id: '',
                    dest_node_id: '',
                    dest_vm_id: '',
                    dest_vm_name_suffix: '',
                    dest_storage: '',
                    backup_mode: 'snapshot',
                    backup_compress: 'zstd',
                    restore_start_vm: false,
                    restore_unique: true,
                    overwrite_existing: true,
                    schedule: '',
                    schedulePreset: '',
                    notify_mode: 'daily',
                    notify_subject: ''
                });
                const selectedSchedule = ref('');
                const destRootPool = ref('');
                const destSubPath = ref('replica');
                
                // VM Replica Wizard
                const sourceVMs = ref([]);
                const destPools = ref([]);
                const vmReplicaWizard = ref({
                    active: false,
                    sourceNodeId: '',
                    destNodeId: '',
                    selectedVM: null,
                    disks: [],
                    totalSize: '0 B',
                    destPool: '',
                    destSubfolder: 'replica',
                    destStorage: '',  // Nome storage Proxmox destinazione
                    destVmId: '',
                    destVmNameSuffix: '-replica',  // Suffisso per nome VM su destinazione
                    schedule: '',
                    schedulePreset: '',
                    compress: 'lz4',
                    registerVM: true,
                    notify_mode: 'daily',
                    notify_subject: '',
                    keep_snapshots: 7,  // Mantieni ultime 7 snapshot per default
                    // BTRFS support
                    syncMethod: 'syncoid',  // syncoid | btrfs_send
                    btrfsMount: '/mnt/btrfs-storage',
                    btrfsSnapshotDir: '',
                    btrfsMaxSnapshots: 5
                });
                
                // BTRFS Wizard
                const btrfsWizard = ref({
                    active: false,
                    sourceNodeId: '',
                    destNodeId: '',
                    vmId: '',
                    vmName: '',
                    diskPath: '',
                    diskName: '',
                    btrfsMount: '/mnt/btrfs-storage',
                    snapshotDir: '',
                    destSnapshotDir: '',
                    maxSnapshots: 5,
                    fullSync: false,
                    schedule: '',
                    registerVM: false
                });
                
                // Computed per raggruppare job per VM
                const vmGroups = computed(() => {
                    const groups = {};
                    syncJobs.value.filter(j => j.vm_group_id).forEach(job => {
                        if (!groups[job.vm_group_id]) {
                            groups[job.vm_group_id] = {
                                vm_group_id: job.vm_group_id,
                                vm_id: job.vm_id,
                                vm_name: job.vm_name,
                                dest_vm_id: job.dest_vm_id,
                                source_node_id: job.source_node_id,
                                dest_node_id: job.dest_node_id,
                                source_node: job.source_node_name,
                                dest_node: job.dest_node_name,
                                schedule: job.schedule,
                                register_vm: job.register_vm,
                                sync_method: job.sync_method || 'syncoid',
                                last_sync_type: job.last_sync_type,
                                jobs: []
                            };
                        }
                        groups[job.vm_group_id].jobs.push(job);
                    });
                    return Object.values(groups);
                });
                
                const singleJobs = computed(() => {
                    return syncJobs.value.filter(j => !j.vm_group_id);
                });
                
                // Computed per suggerimento dataset destinazione
                const suggestedDestDataset = computed(() => {
                    if (!newSyncJob.value.source_dataset || !destRootPool.value) return '';
                    // Prendi il nome base del dataset sorgente (ultima parte del path)
                    const sourceParts = newSyncJob.value.source_dataset.split('/');
                    const baseName = sourceParts[sourceParts.length - 1] || newSyncJob.value.source_dataset;
                    // Costruisci il path destinazione
                    const subPath = destSubPath.value ? `/${destSubPath.value}` : '';
                    return `${destRootPool.value}${subPath}/${baseName}`;
                });
                
                // Computed
                const isAdmin = computed(() => currentUser.value?.role === 'admin');
                const canEdit = computed(() => ['admin', 'operator'].includes(currentUser.value?.role));
                
                // Methods
                const showToast = (message, type = 'success') => {
                    const id = Date.now();
                    toasts.value.push({ id, message, type });
                    setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
                };
                
                const formatDate = d => d ? new Date(d).toLocaleString('it-IT') : '-';
                
                const formatSchedule = (cron) => {
                    if (!cron) return 'Manuale';
                    const preset = schedulePresets.find(p => p.value === cron);
                    if (preset) return preset.label.replace(/^[^\s]+\s/, '');
                    return cron;
                };
                
                const onSchedulePresetChange = (obj) => {
                    if (obj.schedulePreset === 'custom') {
                        // Mantieni il valore corrente o imposta vuoto
                        if (!obj.schedule) obj.schedule = '';
                    } else if (obj.schedulePreset === '') {
                        obj.schedule = '';
                    } else {
                        obj.schedule = obj.schedulePreset;
                    }
                };
                
                const getSchedulePreset = (schedule) => {
                    if (!schedule) return '';
                    const preset = schedulePresets.find(p => p.value === schedule);
                    return preset ? preset.value : 'custom';
                };
                
                const formatUptime = (seconds) => {
                    if (!seconds) return 'N/A';
                    const days = Math.floor(seconds / 86400);
                    const hours = Math.floor((seconds % 86400) / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    if (days > 0) {
                        return `${days}d ${hours}h ${minutes}m`;
                    } else if (hours > 0) {
                        return `${hours}h ${minutes}m`;
                    } else {
                        return `${minutes}m`;
                    }
                };
                
                const formatSize = (bytes) => {
                    // Se √® una stringa gi√† formattata (es: "46.4 GB"), restituiscila
                    if (typeof bytes === 'string') {
                        if (bytes.match(/[\d.,]+\s*(B|KB|MB|GB|TB|PB)/i)) {
                            return bytes;
                        }
                        // Prova a convertire in numero
                        bytes = parseFloat(bytes.replace(',', '.'));
                    }
                    // Verifica che sia un numero valido
                    if (bytes === null || bytes === undefined || isNaN(bytes) || bytes === 0) {
                        return '0 B';
                    }
                    const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
                    let size = Math.abs(bytes);
                    let unitIndex = 0;
                    while (size >= 1024 && unitIndex < units.length - 1) {
                        size /= 1024;
                        unitIndex++;
                    }
                    return `${size.toFixed(2)} ${units[unitIndex]}`;
                };
                
                const getStatusClass = s => {
                    if (!s) return 'badge-info';
                    switch(s.toLowerCase()) {
                        case 'success': return 'badge-success';
                        case 'failed': return 'badge-danger';
                        case 'running': case 'started': return 'badge-warning';
                        default: return 'badge-info';
                    }
                };
                
                // Auth methods
                const checkSetup = async () => {
                    try {
                        const res = await axios.get(`${API}/setup-required`);
                        setupRequired.value = res.data.setup_required;
                        if (!setupRequired.value) {
                            const cfg = await axios.get(`${API}/auth/config`);
                            authConfig.value = cfg.data;
                            if (cfg.data.realms.length > 0) {
                                loginForm.value.realm = cfg.data.realms.find(r => r.default)?.realm || cfg.data.realms[0].realm;
                            }
                        }
                    } catch (e) { console.error(e); }
                };
                
                const doSetup = async () => {
                    loading.value = true;
                    loginError.value = '';
                    try {
                        await axios.post(`${API}/auth/setup`, setupForm.value);
                        showToast('Setup completato! Effettua il login.');
                        setupRequired.value = false;
                        await checkSetup();
                    } catch (e) {
                        loginError.value = e.response?.data?.detail || 'Errore setup';
                    }
                    loading.value = false;
                };
                
                const doLogin = async () => {
                    loading.value = true;
                    loginError.value = '';
                    try {
                        const res = await axios.post(`${API}/auth/login`, loginForm.value);
                        localStorage.setItem('access_token', res.data.access_token);
                        localStorage.setItem('refresh_token', res.data.refresh_token);
                        localStorage.setItem('user', JSON.stringify(res.data.user));
                        currentUser.value = res.data.user;
                        isAuthenticated.value = true;
                        await loadAllData();
                    } catch (e) {
                        loginError.value = e.response?.data?.detail || 'Login fallito';
                    }
                    loading.value = false;
                };
                
                const doLogout = async () => {
                    try { await axios.post(`${API}/auth/logout`); } catch (e) {}
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user');
                    isAuthenticated.value = false;
                    currentUser.value = null;
                };
                
                const checkAuth = () => {
                    const token = localStorage.getItem('access_token');
                    const user = localStorage.getItem('user');
                    if (token && user) {
                        isAuthenticated.value = true;
                        currentUser.value = JSON.parse(user);
                        return true;
                    }
                    return false;
                };
                
                // === MIGRATION JOBS ===
                const loadMigrationJobs = async () => {
                    try { 
                        migrationJobs.value = (await axios.get(`${API}/migration-jobs/`)).data; 
                    } catch (e) { 
                        showToast('Errore caricamento migration jobs', 'error'); 
                    }
                };
                
                const loadMigrationSourceVMs = async () => {
                    if (!newMigrationJob.value.source_node_id) {
                        sourceVMs.value = [];
                        return;
                    }
                    try {
                        const resp = await axios.get(`${API}/vms/node/${newMigrationJob.value.source_node_id}`);
                        sourceVMs.value = resp.data || [];
                    } catch (e) {
                        console.error('Errore caricamento VM:', e);
                        sourceVMs.value = [];
                    }
                };
                
                const loadMigrationDestResources = async () => {
                    if (!newMigrationJob.value.dest_node_id) {
                        destNodeStorages.value = [];
                        destNodeBridges.value = [];
                        return;
                    }
                    try {
                        // Carica storage
                        const storagesResp = await axios.get(`${API}/nodes/${newMigrationJob.value.dest_node_id}/storages`);
                        destNodeStorages.value = storagesResp.data.storages || [];
                        
                        // Carica bridge
                        const bridgesResp = await axios.get(`${API}/nodes/${newMigrationJob.value.dest_node_id}/bridges`);
                        destNodeBridges.value = bridgesResp.data.bridges || [];
                    } catch (e) {
                        console.error('Errore caricamento risorse destinazione:', e);
                        destNodeStorages.value = [];
                        destNodeBridges.value = [];
                    }
                };
                
                const loadMigrationVmDetails = async () => {
                    if (!newMigrationJob.value.vm_id || !newMigrationJob.value.source_node_id) {
                        migrationVmDisks.value = [];
                        migrationVmNetworks.value = [];
                        selectedMigrationVm.value = null;
                        return;
                    }
                    try {
                        // Carica dettagli VM
                        const vm = sourceVMs.value.find(v => v.vmid == newMigrationJob.value.vm_id);
                        if (vm) {
                            selectedMigrationVm.value = vm;
                            newMigrationJob.value.vm_type = vm.type;
                            
                            // Carica dischi
                            const disksResp = await axios.get(`${API}/vms/node/${newMigrationJob.value.source_node_id}/vm/${vm.vmid}/disks`);
                            migrationVmDisks.value = disksResp.data.disks || [];
                            
                            // Carica config per network
                            const configResp = await axios.get(`${API}/vms/node/${newMigrationJob.value.source_node_id}/vm/${vm.vmid}?vm_type=${vm.type}`);
                            const config = configResp.data.config || '';
                            
                            // Estrai network cards dalla config
                            const networkRegex = /^(net\d+):\s*(.+)$/gm;
                            const networks = [];
                            let match;
                            while ((match = networkRegex.exec(config)) !== null) {
                                const iface = match[1];
                                const configStr = match[2];
                                const bridgeMatch = configStr.match(/bridge=([^,\s]+)/);
                                networks.push({
                                    interface: iface,
                                    current_bridge: bridgeMatch ? bridgeMatch[1] : null,
                                    config: configStr
                                });
                            }
                            migrationVmNetworks.value = networks;
                        }
                    } catch (e) {
                        console.error('Errore caricamento dettagli VM:', e);
                        migrationVmDisks.value = [];
                        migrationVmNetworks.value = [];
                    }
                };
                
                const resetMigrationJobForm = () => {
                    newMigrationJob.value = {
                        name: '',
                        source_node_id: '',
                        vm_id: '',
                        vm_type: 'qemu',
                        dest_node_id: '',
                        dest_vm_id: '',
                        dest_vm_name_suffix: '',
                        migration_type: 'copy',
                        create_snapshot: true,
                        keep_snapshots: 1,
                        start_after_migration: false,
                        hw_config: {
                            memory: null,
                            cores: null,
                            sockets: null,
                            cpu: null,
                            network: {},
                            storage: {}
                        },
                        schedule: '',
                        schedulePreset: '',
                        notify_mode: 'daily',
                        notify_subject: ''
                    };
                    selectedMigrationVm.value = null;
                    migrationVmDisks.value = [];
                    migrationVmNetworks.value = [];
                    destNodeStorages.value = [];
                    destNodeBridges.value = [];
                };
                
                const saveMigrationJob = async () => {
                    if (!newMigrationJob.value.name || !newMigrationJob.value.source_node_id || 
                        !newMigrationJob.value.dest_node_id || !newMigrationJob.value.vm_id) {
                        showToast('Compila tutti i campi obbligatori', 'error');
                        return;
                    }
                    
                    loading.value = true;
                    try {
                        // Pulisci hw_config da valori null
                        const hwConfig = {};
                        if (newMigrationJob.value.hw_config.memory) hwConfig.memory = newMigrationJob.value.hw_config.memory;
                        if (newMigrationJob.value.hw_config.cores) hwConfig.cores = newMigrationJob.value.hw_config.cores;
                        if (newMigrationJob.value.hw_config.sockets) hwConfig.sockets = newMigrationJob.value.hw_config.sockets;
                        if (newMigrationJob.value.hw_config.cpu) hwConfig.cpu = newMigrationJob.value.hw_config.cpu;
                        if (Object.keys(newMigrationJob.value.hw_config.network).length > 0) {
                            hwConfig.network = {};
                            for (const [key, value] of Object.entries(newMigrationJob.value.hw_config.network)) {
                                // Il valore √® il nome del bridge, lo formattiamo come "bridge=vmbr1"
                                if (value) hwConfig.network[key] = `bridge=${value}`;
                            }
                        }
                        if (Object.keys(newMigrationJob.value.hw_config.storage).length > 0) {
                            hwConfig.storage = {};
                            for (const [key, value] of Object.entries(newMigrationJob.value.hw_config.storage)) {
                                if (value) hwConfig.storage[key] = value;
                            }
                        }
                        
                        const payload = {
                            name: newMigrationJob.value.name,
                            source_node_id: newMigrationJob.value.source_node_id,
                            vm_id: parseInt(newMigrationJob.value.vm_id),
                            vm_type: newMigrationJob.value.vm_type,
                            dest_node_id: newMigrationJob.value.dest_node_id,
                            dest_vm_id: newMigrationJob.value.dest_vm_id || null,
                            dest_vm_name_suffix: newMigrationJob.value.dest_vm_name_suffix || null,
                            migration_type: newMigrationJob.value.migration_type,
                            create_snapshot: newMigrationJob.value.create_snapshot,
                            keep_snapshots: newMigrationJob.value.keep_snapshots,
                            start_after_migration: newMigrationJob.value.start_after_migration,
                            hw_config: Object.keys(hwConfig).length > 0 ? hwConfig : null,
                            schedule: newMigrationJob.value.schedule || null,
                            notify_mode: newMigrationJob.value.notify_mode,
                            notify_subject: newMigrationJob.value.notify_subject || null
                        };
                        
                        if (editingMigrationJobId.value) {
                            await axios.put(`${API}/migration-jobs/${editingMigrationJobId.value}`, payload);
                            showToast('Job aggiornato!', 'success');
                        } else {
                            await axios.post(`${API}/migration-jobs/`, payload);
                            showToast('Job creato!', 'success');
                        }
                        
                        showMigrationJobModal.value = false;
                        editingMigrationJobId.value = null;
                        resetMigrationJobForm();
                        loadMigrationJobs();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore salvataggio', 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                
                const editMigrationJob = async (job) => {
                    editingMigrationJobId.value = job.id;
                    newMigrationJob.value = {
                        name: job.name,
                        source_node_id: job.source_node_id,
                        vm_id: job.vm_id.toString(),
                        vm_type: job.vm_type,
                        dest_node_id: job.dest_node_id,
                        dest_vm_id: job.dest_vm_id || '',
                        dest_vm_name_suffix: job.dest_vm_name_suffix || '',
                        migration_type: job.migration_type,
                        create_snapshot: job.create_snapshot,
                        keep_snapshots: job.keep_snapshots,
                        start_after_migration: job.start_after_migration,
                        hw_config: job.hw_config || {
                            memory: null,
                            cores: null,
                            sockets: null,
                            cpu: null,
                            network: {},
                            storage: {}
                        },
                        schedule: job.schedule || '',
                        schedulePreset: getSchedulePreset(job.schedule),
                        notify_mode: job.notify_mode || 'daily',
                        notify_subject: job.notify_subject || ''
                    };
                    
                    // Carica dettagli VM
                    await loadMigrationSourceVMs();
                    await loadMigrationDestResources();
                    await loadMigrationVmDetails();
                    
                    showMigrationJobModal.value = true;
                };
                
                const deleteMigrationJob = async (jobId) => {
                    if (!confirm('Eliminare questo job di migrazione?')) return;
                    try {
                        await axios.delete(`${API}/migration-jobs/${jobId}`);
                        showToast('Job eliminato!', 'success');
                        loadMigrationJobs();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore eliminazione', 'error');
                    }
                };
                
                const runMigrationJob = async (jobId) => {
                    if (!confirm('Eseguire la migrazione ora?')) return;
                    loading.value = true;
                    try {
                        await axios.post(`${API}/migration-jobs/${jobId}/run`);
                        showToast('Migrazione avviata!', 'success');
                        loadMigrationJobs();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore avvio migrazione', 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                
                const toggleMigrationJob = async (jobId) => {
                    try {
                        await axios.post(`${API}/migration-jobs/${jobId}/toggle`);
                        loadMigrationJobs();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore', 'error');
                    }
                };
                
                const updateNetworkConfig = (iface) => {
                    // Funzione helper per aggiornare config network
                };
                
                // Data loading
                const loadAllData = async () => {
                    await Promise.all([loadNodes(), loadSyncJobs(), loadRecoveryJobs(), loadMigrationJobs(), loadLogs(), loadUsers(), loadSSHKeyInfo()]);
                };
                
                const loadNodes = async () => {
                    try { 
                        nodes.value = (await axios.get(`${API}/nodes/`)).data;
                        // Separa nodi PVE e PBS
                        pbsNodes.value = nodes.value.filter(n => n.node_type === 'pbs');
                        pveNodes.value = nodes.value.filter(n => n.node_type !== 'pbs');
                    } catch (e) { showToast('Errore caricamento nodi', 'error'); }
                };
                
                const loadSyncJobs = async () => {
                    try { syncJobs.value = (await axios.get(`${API}/sync-jobs/`)).data; } catch (e) { showToast('Errore caricamento job', 'error'); }
                };
                
                const loadRecoveryJobs = async () => {
                    try { recoveryJobs.value = (await axios.get(`${API}/recovery-jobs/`)).data; } catch (e) { showToast('Errore caricamento recovery jobs', 'error'); }
                };
                
                // Backup Jobs methods
                const loadBackupJobs = async () => {
                    try { 
                        backupJobs.value = (await axios.get(`${API}/backup-jobs/`)).data; 
                    } catch (e) { 
                        console.error('Errore caricamento backup jobs:', e);
                    }
                };
                
                const loadSourceVmsForBackup = async () => {
                    if (!newBackupJob.value.source_node_id) {
                        sourceVmsForBackup.value = [];
                        return;
                    }
                    try {
                        const resp = await axios.get(`${API}/nodes/${newBackupJob.value.source_node_id}/vms`);
                        // L'API restituisce direttamente la lista o un oggetto con 'vms'
                        sourceVmsForBackup.value = Array.isArray(resp.data) ? resp.data : (resp.data.vms || []);
                        console.log('VM caricate per backup:', sourceVmsForBackup.value);
                        // Carica anche gli storage PBS disponibili sul nodo
                        loadBackupPbsStorages();
                    } catch (e) {
                        console.error('Errore caricamento VM:', e);
                        sourceVmsForBackup.value = [];
                    }
                };
                
                const loadBackupPbsStorages = async () => {
                    backupPbsStorages.value = [];
                    if (!newBackupJob.value.source_node_id) return;
                    
                    try {
                        const resp = await axios.get(`${API}/recovery-jobs/node/${newBackupJob.value.source_node_id}/pbs-storages`);
                        backupPbsStorages.value = resp.data.pbs_storages || [];
                        console.log('Storage PBS disponibili:', backupPbsStorages.value);
                        // Auto-seleziona il primo storage se disponibile
                        if (backupPbsStorages.value.length > 0 && !newBackupJob.value.pbs_storage_id) {
                            newBackupJob.value.pbs_storage_id = backupPbsStorages.value[0].storage;
                        }
                    } catch (e) {
                        console.error('Errore caricamento storage PBS:', e);
                    }
                };
                
                const selectBackupVm = () => {
                    const vmId = parseInt(newBackupJob.value.vm_id);
                    const vm = sourceVmsForBackup.value.find(v => parseInt(v.vmid) === vmId);
                    console.log('selectBackupVm:', vmId, vm);
                    if (vm) {
                        newBackupJob.value.vm_type = vm.type || 'qemu';
                        newBackupJob.value.vm_name = vm.name || '';
                        console.log('VM name set to:', newBackupJob.value.vm_name);
                    }
                };
                
                const createBackupJob = async () => {
                    try {
                        const payload = { ...newBackupJob.value };
                        if (payload.schedule === '') payload.schedule = null;
                        await axios.post(`${API}/backup-jobs/`, payload);
                        showToast('Backup job creato!', 'success');
                        loadBackupJobs();
                        newBackupJob.value = {
                            name: '', source_node_id: '', vm_id: '', vm_type: 'qemu', vm_name: '',
                            pbs_node_id: '', backup_mode: 'snapshot', backup_compress: 'zstd',
                            keep_last: 3, schedule: '', schedulePreset: '', 
                            notify_mode: 'daily', notify_subject: '', is_active: true
                        };
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore creazione backup job', 'error');
                    }
                };
                
                const runBackupJob = async (jobId) => {
                    try {
                        await axios.post(`${API}/backup-jobs/${jobId}/run`);
                        showToast('Backup avviato!', 'success');
                        loadBackupJobs();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore avvio backup', 'error');
                    }
                };
                
                const deleteBackupJob = async (jobId) => {
                    if (!confirm('Eliminare questo backup job?')) return;
                    try {
                        await axios.delete(`${API}/backup-jobs/${jobId}`);
                        showToast('Backup job eliminato', 'success');
                        loadBackupJobs();
                    } catch (e) {
                        showToast('Errore eliminazione', 'error');
                    }
                };
                
                const editBackupJob = (job) => {
                    editingBackupJob.value = { 
                        ...job,
                        schedulePreset: getSchedulePreset(job.schedule),
                        notify_mode: job.notify_mode || 'daily',
                        notify_subject: job.notify_subject || ''
                    };
                    showEditBackupJobModal.value = true;
                };
                
                const saveBackupJob = async () => {
                    try {
                        const payload = {
                            name: editingBackupJob.value.name,
                            backup_mode: editingBackupJob.value.backup_mode,
                            backup_compress: editingBackupJob.value.backup_compress,
                            keep_last: editingBackupJob.value.keep_last,
                            schedule: editingBackupJob.value.schedule || null,
                            notify_mode: editingBackupJob.value.notify_mode || 'daily',
                            notify_subject: editingBackupJob.value.notify_subject || null,
                            is_active: editingBackupJob.value.is_active
                        };
                        await axios.put(`${API}/backup-jobs/${editingBackupJob.value.id}`, payload);
                        showToast('Backup job aggiornato!', 'success');
                        showEditBackupJobModal.value = false;
                        editingBackupJob.value = null;
                        loadBackupJobs();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore aggiornamento', 'error');
                    }
                };
                
                // === HOST CONFIG BACKUP ===
                const loadHostBackupData = async () => {
                    await loadHostBackupJobs();
                    if (hostBackup.value.selectedNodeId) {
                        await loadHostBackupPaths();
                        await loadHostBackups();
                    }
                };
                
                const loadHostBackupJobs = async () => {
                    try {
                        const resp = await axios.get(`${API}/host-backup/jobs`);
                        hostBackupJobs.value = resp.data.jobs || [];
                    } catch (e) {
                        console.error('Errore caricamento host backup jobs:', e);
                    }
                };
                
                const loadHostBackupPaths = async () => {
                    const nodeId = hostBackup.value.selectedNodeId || hostBackupJob.value.node_id;
                    if (!nodeId) {
                        hostBackup.value.paths = [];
                        hostBackup.value.hostType = '';
                        return;
                    }
                    
                    loading.value = true;
                    try {
                        const resp = await axios.get(`${API}/host-backup/nodes/${nodeId}/backup-paths`);
                        hostBackup.value.paths = resp.data.paths || [];
                        hostBackup.value.hostType = resp.data.host_type;
                        hostBackup.value.totalSize = resp.data.total_size;
                        hostBackup.value.totalSizeHuman = resp.data.total_size_human;
                        hostBackup.value.existingPaths = resp.data.existing_paths;
                        if (hostBackup.value.selectedNodeId) await loadHostBackups();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore caricamento percorsi', 'error');
                    }
                    loading.value = false;
                };
                
                const loadHostBackups = async () => {
                    if (!hostBackup.value.selectedNodeId) return;
                    
                    try {
                        const resp = await axios.get(`${API}/host-backup/nodes/${hostBackup.value.selectedNodeId}/backups`, {
                            params: { backup_path: hostBackup.value.destPath }
                        });
                        hostBackup.value.backups = resp.data.backups || [];
                    } catch (e) {
                        console.error('Errore caricamento backup host:', e);
                    }
                };
                
                const createHostBackupJob = async () => {
                    if (!hostBackupJob.value.name || !hostBackupJob.value.node_id) {
                        showToast('Compila nome e nodo', 'error');
                        return;
                    }
                    
                    loading.value = true;
                    try {
                        await axios.post(`${API}/host-backup/jobs`, hostBackupJob.value);
                        showToast('Job creato con successo', 'success');
                        hostBackupJob.value = {
                            name: '', node_id: '', dest_path: '/var/backups/proxmox-config',
                            compress: true, encrypt: false, encrypt_password: '',
                            keep_last: 7, schedule: '', schedulePreset: '',
                            is_active: true, notify_mode: 'daily', notify_subject: ''
                        };
                        await loadHostBackupJobs();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore creazione job', 'error');
                    }
                    loading.value = false;
                };
                
                const runHostBackupJob = async (jobId) => {
                    loading.value = true;
                    showToast('Avvio backup...', 'info');
                    try {
                        const resp = await axios.post(`${API}/host-backup/jobs/${jobId}/run`);
                        showToast(`Backup completato: ${resp.data.backup_name} (${resp.data.size_human})`, 'success');
                        await loadHostBackupJobs();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore esecuzione backup', 'error');
                    }
                    loading.value = false;
                };
                
                const editHostBackupJob = (job) => {
                    hostBackupJob.value = {
                        ...job,
                        schedulePreset: getSchedulePreset(job.schedule)
                    };
                    showToast('Modifica il job e clicca "Crea Job" per salvare le modifiche', 'info');
                };
                
                const deleteHostBackupJob = async (jobId) => {
                    if (!confirm('Eliminare questo job?')) return;
                    try {
                        await axios.delete(`${API}/host-backup/jobs/${jobId}`);
                        showToast('Job eliminato', 'success');
                        await loadHostBackupJobs();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore eliminazione', 'error');
                    }
                };
                
                const createHostBackup = async () => {
                    if (!hostBackup.value.selectedNodeId) return;
                    
                    if (hostBackup.value.encrypt && !hostBackup.value.encryptPassword) {
                        showToast('Inserisci una password per la cifratura', 'error');
                        return;
                    }
                    
                    loading.value = true;
                    showToast('Creazione backup configurazione in corso...', 'info');
                    
                    try {
                        const resp = await axios.post(`${API}/host-backup/nodes/${hostBackup.value.selectedNodeId}/backup`, {
                            compress: hostBackup.value.compress,
                            encrypt: hostBackup.value.encrypt,
                            encrypt_password: hostBackup.value.encrypt ? hostBackup.value.encryptPassword : null,
                            dest_path: hostBackup.value.destPath
                        });
                        
                        showToast(`Backup creato: ${resp.data.backup_name} (${resp.data.size_human})`, 'success');
                        await loadHostBackups();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore creazione backup', 'error');
                    }
                    loading.value = false;
                };
                
                const deleteHostBackup = async (backup) => {
                    if (!confirm(`Eliminare il backup ${backup.filename}?`)) return;
                    
                    try {
                        await axios.delete(`${API}/host-backup/nodes/${hostBackup.value.selectedNodeId}/backups`, {
                            params: { 
                                backup_file: backup.filename,
                                backup_path: hostBackup.value.destPath 
                            }
                        });
                        showToast('Backup eliminato', 'success');
                        await loadHostBackups();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore eliminazione', 'error');
                    }
                };
                
                const applyHostRetention = async () => {
                    showHostRetentionModal.value = false;
                    
                    try {
                        const resp = await axios.post(`${API}/host-backup/nodes/${hostBackup.value.selectedNodeId}/backups/retention`, {
                            keep_last: hostRetentionCount.value
                        }, {
                            params: { backup_path: hostBackup.value.destPath }
                        });
                        
                        showToast(`Retention applicata: ${resp.data.deleted_count} backup eliminati`, 'success');
                        await loadHostBackups();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore retention', 'error');
                    }
                };
                
                // === RESTORE FROM PBS ===
                const browseRestorePbs = async (pbs) => {
                    selectedRestorePbs.value = pbs;
                    restorePbsBackups.value = [];
                    showToast(`Caricamento backup da ${pbs.name}...`, 'info');
                    
                    try {
                        const resp = await axios.get(`${API}/recovery-jobs/pbs-nodes/${pbs.id}/backups`);
                        restorePbsBackups.value = resp.data.backups || [];
                        if (restorePbsBackups.value.length === 0) {
                            showToast(`Nessun backup trovato su ${pbs.name}`, 'warning');
                        } else {
                            showToast(`Trovati ${restorePbsBackups.value.length} backup`, 'success');
                        }
                    } catch (e) {
                        console.error('Errore caricamento backup PBS:', e);
                        showToast(e.response?.data?.detail || 'Errore caricamento backup', 'error');
                    }
                };
                
                const startRestore = (backup) => {
                    restoreStorages.value = [];
                    restoreData.value = {
                        backup_id: backup.backup_id,
                        vmid: backup.vmid,
                        vm_name: backup.vm_name || '',
                        vm_type: backup.vm_type || 'qemu',
                        pbs_node_id: selectedRestorePbs.value?.id,
                        dest_node_id: '',
                        dest_vmid: backup.vmid,
                        dest_vm_name: backup.vm_name || '',
                        dest_storage: '',
                        start_after_restore: false
                    };
                    showRestoreModal.value = true;
                };
                
                const loadRestoreStorages = async () => {
                    if (!restoreData.value.dest_node_id) {
                        restoreStorages.value = [];
                        return;
                    }
                    try {
                        const resp = await axios.get(`${API}/recovery-jobs/node/${restoreData.value.dest_node_id}/storages`);
                        const allStorages = resp.data.storages || [];
                        // Mostra tutti gli storage attivi tranne PBS
                        restoreStorages.value = allStorages
                            .filter(s => s.active !== false && s.type !== 'pbs')
                            .map(s => ({
                                storage: s.name || s.storage,
                                type: s.type,
                                avail: s.avail || 0
                            }));
                        console.log('Storage caricati:', restoreStorages.value);
                    } catch (e) {
                        console.error('Errore caricamento storage:', e);
                        restoreStorages.value = [];
                    }
                };
                
                const executeRestore = async () => {
                    if (!restoreData.value.dest_node_id) {
                        showToast('Seleziona un nodo di destinazione', 'error');
                        return;
                    }
                    
                    try {
                        showToast('Avvio restore in corso...', 'info');
                        
                        // Usa l'endpoint di restore esistente
                        const payload = {
                            pbs_node_id: restoreData.value.pbs_node_id,
                            backup_id: restoreData.value.backup_id,
                            dest_node_id: restoreData.value.dest_node_id,
                            dest_vmid: restoreData.value.dest_vmid || null,
                            dest_storage: restoreData.value.dest_storage || null,
                            vm_type: restoreData.value.vm_type
                        };
                        
                        const resp = await axios.post(`${API}/recovery-jobs/restore`, payload);
                        
                        showRestoreModal.value = false;
                        showToast('Restore avviato con successo!', 'success');
                        
                        // Se richiesto, avvia la VM dopo il restore
                        if (restoreData.value.start_after_restore && resp.data.vmid) {
                            setTimeout(async () => {
                                try {
                                    await axios.post(`${API}/nodes/${restoreData.value.dest_node_id}/vms/${resp.data.vmid}/start`);
                                    showToast('VM avviata', 'success');
                                } catch (e) {
                                    console.error('Errore avvio VM:', e);
                                }
                            }, 5000);
                        }
                    } catch (e) {
                        console.error('Errore restore:', e);
                        showToast(e.response?.data?.detail || 'Errore durante il restore', 'error');
                    }
                };
                
                // Dashboard methods
                const loadDashboardFromStorage = () => {
                    try {
                        const stored = localStorage.getItem('dashboard_data');
                        if (stored) {
                            const data = JSON.parse(stored);
                            dashboardOverview.value = data.overview;
                            dashboardNodes.value = data.nodes;
                            dashboardVMs.value = data.vms;
                            dashboardDataFromCache.value = true;
                            return true;
                        }
                    } catch (e) {
                        console.error('Errore caricamento dati da storage:', e);
                    }
                    dashboardDataFromCache.value = false;
                    return false;
                };
                
                const saveDashboardToStorage = () => {
                    try {
                        const data = {
                            overview: dashboardOverview.value,
                            nodes: dashboardNodes.value,
                            vms: dashboardVMs.value,
                            timestamp: Date.now()
                        };
                        localStorage.setItem('dashboard_data', JSON.stringify(data));
                    } catch (e) {
                        console.error('Errore salvataggio dati in storage:', e);
                    }
                };
                
                const loadDashboard = async (forceRefresh = false) => {
                    // Carica da localStorage se disponibile e non √® un refresh forzato
                    if (!forceRefresh && loadDashboardFromStorage()) {
                        // Carica comunque jobs e log (non vengono salvati in cache)
                        await Promise.all([loadSyncJobs(), loadRecoveryJobs(), loadLogs()]);
                        return;
                    }
                    
                    loading.value = true;
                    try {
                        // Load overview
                        const overviewRes = await axios.get(`${API}/dashboard/overview`);
                        dashboardOverview.value = overviewRes.data;
                        
                        // Load nodes
                        const nodesRes = await axios.get(`${API}/dashboard/nodes`);
                        console.log('Dashboard nodes response:', nodesRes.data);
                        dashboardNodes.value = nodesRes.data;
                        
                        // Load VMs
                        const vmsRes = await axios.get(`${API}/dashboard/vms`);
                        dashboardVMs.value = vmsRes.data;
                        
                        // Load jobs and logs (non vengono salvati in cache)
                        await Promise.all([loadSyncJobs(), loadRecoveryJobs(), loadLogs()]);
                        
                        // Salva in localStorage
                        saveDashboardToStorage();
                        dashboardDataFromCache.value = false;
                    } catch (error) {
                        console.error('Errore caricamento dashboard:', error);
                        showToast('Errore caricamento dashboard', 'error');
                        // Se c'√® un errore, prova a caricare da storage
                        if (!loadDashboardFromStorage()) {
                            showToast('Nessun dato disponibile in cache', 'warning');
                        }
                        // Prova comunque a caricare jobs e log
                        try {
                            await Promise.all([loadSyncJobs(), loadRecoveryJobs(), loadLogs()]);
                        } catch (e) {
                            console.error('Errore caricamento jobs/logs:', e);
                        }
                    }
                    loading.value = false;
                };
                
                const loadNodeDetails = async (nodeId) => {
                    loadingNodeDetail.value = true;
                    selectedNodeDetail.value = null;
                    try {
                        const res = await axios.get(`${API}/nodes/${nodeId}/host-details`);
                        selectedNodeDetail.value = res.data;
                    } catch (error) {
                        console.error('Errore caricamento dettagli nodo:', error);
                        showToast('Errore caricamento dettagli nodo', 'error');
                    }
                    loadingNodeDetail.value = false;
                };
                
                const loadVMDetails = async (nodeId, vmid, vmType = 'qemu') => {
                    loadingVMDetail.value = true;
                    selectedVMDetail.value = null;
                    try {
                        console.log(`Caricamento dettagli VM: nodeId=${nodeId}, vmid=${vmid}, vmType=${vmType}`);
                        const res = await axios.get(`${API}/nodes/${nodeId}/vms/${vmid}/full-details?vm_type=${vmType}`);
                        console.log('VM details response:', res.data);
                        selectedVMDetail.value = res.data;
                    } catch (error) {
                        console.error('Errore caricamento dettagli VM:', error);
                        console.error('Error response:', error.response?.data);
                        showToast(`Errore caricamento dettagli VM: ${error.response?.data?.detail || error.message}`, 'error');
                        selectedVMDetail.value = null;
                    }
                    loadingVMDetail.value = false;
                };
                
                const viewNodeDetails = (nodeId) => {
                    currentPage.value = 'node-details';
                    loadNodeDetails(nodeId);
                };
                
                const viewVMDetails = (nodeId, vmid, vmType = 'qemu') => {
                    currentPage.value = 'vm-details';
                    loadVMDetails(nodeId, vmid, vmType);
                };
                
                // Helper per ottenere il nome di un nodo dato l'ID
                const getNodeName = (nodeId) => {
                    if (!nodeId) return '?';
                    const node = nodes.value.find(n => n.id === nodeId);
                    return node ? node.name : `Node #${nodeId}`;
                };
                
                const loadLogs = async () => {
                    try { allLogs.value = (await axios.get(`${API}/logs/?limit=100`)).data; recentLogs.value = allLogs.value.slice(0, 10); } catch (e) {}
                };
                
                const showLogDetail = (log) => {
                    selectedLog.value = log;
                };
                
                // Recovery Jobs methods
                const loadSourceVms = async () => {
                    if (!newRecoveryJob.value.source_node_id) {
                        sourceVmsForRecovery.value = [];
                        sourcePbsStorages.value = [];
                        return;
                    }
                    try {
                        const resp = await axios.get(`${API}/nodes/${newRecoveryJob.value.source_node_id}/vms`);
                        sourceVmsForRecovery.value = resp.data;
                        // Carica anche storage PBS dal nodo sorgente
                        loadSourcePbsStorages();
                    } catch (e) {
                        showToast('Errore caricamento VM', 'error');
                    }
                };
                
                // Storage PBS disponibili sul nodo sorgente
                const sourcePbsStorages = ref([]);
                
                const loadSourcePbsStorages = async () => {
                    sourcePbsStorages.value = [];
                    if (!newRecoveryJob.value.source_node_id) return;
                    
                    try {
                        const resp = await axios.get(`${API}/recovery-jobs/node/${newRecoveryJob.value.source_node_id}/pbs-storages`);
                        sourcePbsStorages.value = resp.data.pbs_storages || [];
                    } catch (e) {
                        console.error('Errore caricamento storage PBS:', e);
                        // Non mostrare errore, potrebbe essere normale
                    }
                };
                
                // Storage e VMID check per Recovery Jobs
                const destStorages = ref([]);
                const vmidCheckResult = ref(null);
                
                const loadDestStorages = async () => {
                    destStorages.value = [];
                    vmidCheckResult.value = null;
                    
                    if (!newRecoveryJob.value.dest_node_id) {
                        return;
                    }
                    
                    try {
                        const resp = await axios.get(`${API}/recovery-jobs/node/${newRecoveryJob.value.dest_node_id}/storages`);
                        destStorages.value = resp.data.vm_storages || resp.data.storages || [];
                        
                        // Auto-seleziona primo storage se disponibile
                        if (destStorages.value.length > 0 && !newRecoveryJob.value.dest_storage) {
                            newRecoveryJob.value.dest_storage = destStorages.value[0].name;
                        }
                    } catch (e) {
                        console.error('Errore caricamento storage:', e);
                        // Non mostrare errore, potrebbe essere SSH non configurato
                    }
                };
                
                const checkDestVmid = async () => {
                    vmidCheckResult.value = null;
                    
                    const vmid = newRecoveryJob.value.dest_vm_id || newRecoveryJob.value.vm_id;
                    if (!vmid || !newRecoveryJob.value.dest_node_id) {
                        return;
                    }
                    
                    try {
                        const resp = await axios.get(`${API}/recovery-jobs/node/${newRecoveryJob.value.dest_node_id}/check-vmid/${vmid}`);
                        vmidCheckResult.value = resp.data;
                    } catch (e) {
                        vmidCheckResult.value = {
                            available: false,
                            message: 'Errore verifica VMID'
                        };
                    }
                };
                
                const createRecoveryJob = async () => {
                    try {
                        // Find VM name
                        const vm = sourceVmsForRecovery.value.find(v => v.vmid == newRecoveryJob.value.vm_id);
                        if (vm) {
                            newRecoveryJob.value.vm_name = vm.name;
                            newRecoveryJob.value.vm_type = vm.type;
                        }
                        
                        // Prepara payload convertendo stringhe vuote in null per campi opzionali numerici
                        const payload = { ...newRecoveryJob.value };
                        if (payload.dest_vm_id === '' || payload.dest_vm_id === null) {
                            payload.dest_vm_id = null;
                        } else {
                            payload.dest_vm_id = parseInt(payload.dest_vm_id);
                        }
                        if (payload.dest_storage === '') payload.dest_storage = null;
                        if (payload.pbs_datastore === '') payload.pbs_datastore = null;
                        if (payload.pbs_storage_id === '') payload.pbs_storage_id = null;
                        if (payload.dest_vm_name_suffix === '') payload.dest_vm_name_suffix = null;
                        if (payload.schedule === '') payload.schedule = null;
                        
                        await axios.post(`${API}/recovery-jobs/`, payload);
                        showToast('Recovery job creato!', 'success');
                        showAddRecoveryJobModal.value = false;
                        loadRecoveryJobs();
                        // Reset form
                        newRecoveryJob.value = {
                            name: '', source_node_id: '', vm_id: '', vm_type: 'qemu', vm_name: '',
                            pbs_node_id: '', pbs_datastore: '', dest_node_id: '', dest_vm_id: '', dest_vm_name_suffix: '',
                            dest_storage: '', backup_mode: 'snapshot', backup_compress: 'zstd',
                            restore_start_vm: false, restore_unique: true, overwrite_existing: true, 
                            schedule: '', schedulePreset: '', notify_mode: 'daily', notify_subject: ''
                        };
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore creazione job', 'error');
                    }
                };
                
                // Auto-refresh interval per recovery jobs
                let recoveryRefreshInterval = null;
                
                const startRecoveryRefresh = () => {
                    // Refresh ogni 5 secondi mentre c'√® un job in esecuzione
                    if (recoveryRefreshInterval) return;
                    recoveryRefreshInterval = setInterval(async () => {
                        await loadRecoveryJobs();
                        // Se nessun job √® in esecuzione, ferma il refresh
                        const hasRunning = recoveryJobs.value.some(j => 
                            ['backing_up', 'restoring', 'registering', 'started'].includes(j.current_status)
                        );
                        if (!hasRunning && recoveryRefreshInterval) {
                            clearInterval(recoveryRefreshInterval);
                            recoveryRefreshInterval = null;
                        }
                    }, 5000);
                };
                
                const runRecoveryJob = async (jobId) => {
                    try {
                        await axios.post(`${API}/recovery-jobs/${jobId}/run`);
                        showToast('Recovery job avviato! Lo stato si aggiorner√† automaticamente.', 'success');
                        await loadRecoveryJobs();
                        startRecoveryRefresh();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore avvio job', 'error');
                    }
                };
                
                const deleteRecoveryJob = async (jobId) => {
                    if (!confirm('Eliminare questo recovery job?')) return;
                    try {
                        await axios.delete(`${API}/recovery-jobs/${jobId}`);
                        showToast('Recovery job eliminato', 'success');
                        loadRecoveryJobs();
                    } catch (e) {
                        showToast('Errore eliminazione job', 'error');
                    }
                };
                
                const editingRecoveryJob = ref(null);
                const showEditRecoveryJobModal = ref(false);
                
                const editRecoveryJob = (job) => {
                    // Copia il job per la modifica
                    editingRecoveryJob.value = { 
                        ...job,
                        schedulePreset: getSchedulePreset(job.schedule),
                        notify_mode: job.notify_mode || 'daily',
                        notify_subject: job.notify_subject || ''
                    };
                    showEditRecoveryJobModal.value = true;
                };
                
                const saveRecoveryJob = async () => {
                    if (!editingRecoveryJob.value) return;
                    
                    try {
                        const payload = {
                            name: editingRecoveryJob.value.name,
                            vm_name: editingRecoveryJob.value.vm_name,
                            pbs_datastore: editingRecoveryJob.value.pbs_datastore || null,
                            pbs_storage_id: editingRecoveryJob.value.pbs_storage_id || null,
                            dest_vm_id: editingRecoveryJob.value.dest_vm_id ? parseInt(editingRecoveryJob.value.dest_vm_id) : null,
                            dest_vm_name_suffix: editingRecoveryJob.value.dest_vm_name_suffix || null,
                            dest_storage: editingRecoveryJob.value.dest_storage || null,
                            backup_mode: editingRecoveryJob.value.backup_mode,
                            backup_compress: editingRecoveryJob.value.backup_compress,
                            restore_start_vm: editingRecoveryJob.value.restore_start_vm,
                            restore_unique: editingRecoveryJob.value.restore_unique,
                            overwrite_existing: editingRecoveryJob.value.overwrite_existing,
                            schedule: editingRecoveryJob.value.schedule || null,
                            is_active: editingRecoveryJob.value.is_active,
                            notify_mode: editingRecoveryJob.value.notify_mode || 'daily',
                            notify_subject: editingRecoveryJob.value.notify_subject || null
                        };
                        
                        await axios.put(`${API}/recovery-jobs/${editingRecoveryJob.value.id}`, payload);
                        showToast('Recovery job aggiornato!', 'success');
                        showEditRecoveryJobModal.value = false;
                        editingRecoveryJob.value = null;
                        loadRecoveryJobs();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore salvataggio', 'error');
                    }
                };
                
                const testPbsNode = async (nodeId) => {
                    try {
                        const resp = await axios.post(`${API}/recovery-jobs/pbs-nodes/${nodeId}/test`);
                        if (resp.data.success) {
                            showToast(`PBS OK - Versione ${resp.data.pbs?.version || 'N/A'}`, 'success');
                        } else {
                            showToast('PBS non raggiungibile', 'error');
                        }
                        loadNodes();
                    } catch (e) {
                        showToast('Errore test PBS', 'error');
                    }
                };
                
                // Browse PBS Backups
                const browsePbsBackups = async (nodeId) => {
                    const node = pbsNodes.value.find(n => n.id === nodeId);
                    if (!node) return;
                    
                    pbsBrowseData.value = {
                        nodeId: nodeId,
                        nodeName: node.name,
                        datastore: node.pbs_datastore || 'datastore1',
                        backups: [],
                        loading: true
                    };
                    
                    try {
                        const resp = await axios.get(`${API}/recovery-jobs/pbs-nodes/${nodeId}/backups`);
                        pbsBrowseData.value.backups = resp.data.backups || [];
                        pbsBrowseData.value.datastore = resp.data.datastore;
                    } catch (e) {
                        showToast('Errore caricamento backup da PBS', 'error');
                        console.error(e);
                    } finally {
                        pbsBrowseData.value.loading = false;
                    }
                };
                
                const extractVmIdFromBackup = (backupId) => {
                    // Format: "vm/100/2024-01-15T10:30:00Z" or "ct/101/..."
                    const match = backupId.match(/(?:vm|ct)\/(\d+)\//);
                    return match ? match[1] : backupId;
                };
                
                const extractTypeFromBackup = (backupId) => {
                    if (backupId.startsWith('vm/')) return 'QEMU';
                    if (backupId.startsWith('ct/')) return 'LXC';
                    return 'N/A';
                };
                
                const formatBackupDate = (backupId) => {
                    // Extract date from backup ID: "vm/100/2024-01-15T10:30:00Z"
                    const match = backupId.match(/(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})/);
                    if (match) {
                        const date = new Date(match[1]);
                        return date.toLocaleString('it-IT');
                    }
                    return '-';
                };
                
                const createRecoveryFromPbsBackup = (backup) => {
                    // Pre-popola il form recovery con i dati del backup esistente
                    const vmId = extractVmIdFromBackup(backup['backup-id']);
                    const vmType = backup['backup-id'].startsWith('ct/') ? 'lxc' : 'qemu';
                    
                    newRecoveryJob.value = {
                        name: `Restore-VM${vmId}`,
                        source_node_id: '',  // Sar√† selezionato dall'utente
                        vm_id: parseInt(vmId),
                        vm_type: vmType,
                        vm_name: '',
                        pbs_node_id: pbsBrowseData.value.nodeId,
                        pbs_datastore: pbsBrowseData.value.datastore,
                        pbs_storage_id: '',
                        dest_node_id: '',
                        dest_vm_id: null,
                        dest_vm_name_suffix: '-restored',
                        dest_storage: '',
                        backup_mode: 'snapshot',
                        backup_compress: 'zstd',
                        restore_start_vm: false,
                        restore_unique: true,
                        overwrite_existing: true,
                        schedule: '', schedulePreset: '',
                        notify_mode: 'daily', notify_subject: '',
                        is_active: false  // Disattivato per default per restore manuali
                    };
                    
                    showAddRecoveryJobModal.value = true;
                    showToast(`Configura il restore per VM ${vmId} dal backup PBS`, 'info');
                };
                
                const getRecoveryJobStatus = (job) => {
                    if (job.current_status === 'backing_up') return '‚è≥ Backup in corso...';
                    if (job.current_status === 'restoring') return '‚è≥ Restore in corso...';
                    if (job.last_status === 'success') return '‚úì Completato';
                    if (job.last_status === 'failed') return '‚úó Fallito';
                    return '‚óã In attesa';
                };
                
                const loadUsers = async () => {
                    if (currentUser.value?.role !== 'admin') return;
                    try { users.value = (await axios.get(`${API}/auth/users`)).data; } catch (e) {}
                };
                
                const loadNotifSettings = async () => {
                    if (currentUser.value?.role !== 'admin') return;
                    try {
                        const res = await axios.get(`${API}/settings/notifications`);
                        notifSettings.value = { ...notifSettings.value, ...res.data };
                        // Carica anche l'orario del riepilogo giornaliero
                        try {
                            const hourRes = await axios.get(`${API}/settings/system/daily_summary_hour`);
                            dailySummaryHour.value = parseInt(hourRes.data.value) || 8;
                        } catch (e) { dailySummaryHour.value = 8; }
                    } catch (e) {
                        console.log('Notifiche non configurate');
                    }
                };
                
                const loadNodeDatasets = async () => {
                    if (!selectedNodeId.value) { datasets.value = []; return; }
                    loading.value = true;
                    try { datasets.value = (await axios.get(`${API}/nodes/${selectedNodeId.value}/datasets?refresh=true`)).data; } catch (e) { showToast('Errore', 'error'); }
                    loading.value = false;
                };
                
                const loadNodeSnapshots = async () => {
                    if (!selectedNodeId.value) return;
                    loading.value = true;
                    try { snapshots.value = (await axios.get(`${API}/snapshots/node/${selectedNodeId.value}`)).data; } catch (e) {}
                    loading.value = false;
                };
                
                const loadNodeVms = async () => {
                    if (!selectedVmNodeId.value) { nodeVms.value = []; return; }
                    loading.value = true;
                    try { 
                        nodeVms.value = (await axios.get(`${API}/vms/node/${selectedVmNodeId.value}`)).data;
                        // Carica conteggio backup per ogni VM (in background)
                        loadVmBackupCounts();
                    } catch (e) {}
                    loading.value = false;
                };
                
                const loadVmBackupCounts = async () => {
                    // Per ogni PBS, cerca backup per le VM caricate
                    const pbsNodes = nodes.value.filter(n => n.node_type === 'pbs');
                    for (const pbs of pbsNodes) {
                        try {
                            const resp = await axios.get(`${API}/recovery-jobs/pbs-nodes/${pbs.id}/backups`);
                            const backups = resp.data.backups || [];
                            // Aggiorna conteggio backup per ogni VM
                            for (const vm of nodeVms.value) {
                                const vmBackups = backups.filter(b => b.vmid == vm.vmid);
                                if (vmBackups.length > 0) {
                                    vm.backup_count = (vm.backup_count || 0) + vmBackups.length;
                                }
                            }
                        } catch (e) {
                            console.log('Errore caricamento backup da PBS', pbs.name);
                        }
                    }
                };
                
                const showVmBackups = async (vm) => {
                    selectedVmForBackups.value = vm;
                    vmBackupsList.value = [];
                    showVmBackupsModal.value = true;
                    
                    // Cerca backup in tutti i PBS
                    const pbsNodes = nodes.value.filter(n => n.node_type === 'pbs');
                    for (const pbs of pbsNodes) {
                        try {
                            const resp = await axios.get(`${API}/recovery-jobs/pbs-nodes/${pbs.id}/backups?vm_id=${vm.vmid}`);
                            const backups = (resp.data.backups || []).map(b => ({
                                ...b,
                                pbs_id: pbs.id,
                                pbs_name: pbs.name
                            }));
                            vmBackupsList.value.push(...backups);
                        } catch (e) {
                            console.error('Errore backup da', pbs.name, e);
                        }
                    }
                    // Ordina per data (pi√π recente prima)
                    vmBackupsList.value.sort((a, b) => (b.backup_time || 0) - (a.backup_time || 0));
                };
                
                const startRestoreFromVmBackup = (backup) => {
                    showVmBackupsModal.value = false;
                    selectedRestorePbs.value = nodes.value.find(n => n.id === backup.pbs_id);
                    restoreStorages.value = [];
                    restoreData.value = {
                        backup_id: backup.backup_id,
                        vmid: backup.vmid,
                        vm_name: backup.vm_name || selectedVmForBackups.value?.name || '',
                        vm_type: backup.vm_type || 'qemu',
                        pbs_node_id: backup.pbs_id,
                        dest_node_id: '',
                        dest_vmid: backup.vmid,
                        dest_vm_name: backup.vm_name || selectedVmForBackups.value?.name || '',
                        dest_storage: '',
                        start_after_restore: false
                    };
                    showRestoreModal.value = true;
                };
                
                // ========== VM Replica Wizard Functions ==========
                const loadSourceVMs = async () => {
                    if (!vmReplicaWizard.value.sourceNodeId) { sourceVMs.value = []; return; }
                    loading.value = true;
                    try {
                        sourceVMs.value = (await axios.get(`${API}/vms/node/${vmReplicaWizard.value.sourceNodeId}`)).data;
                    } catch (e) { showToast('Errore caricamento VM', 'error'); }
                    loading.value = false;
                };
                
                const loadDestPools = async () => {
                    if (!vmReplicaWizard.value.destNodeId) { destPools.value = []; return; }
                    try {
                        const res = await axios.get(`${API}/sync-jobs/nodes/${vmReplicaWizard.value.destNodeId}/pools`);
                        destPools.value = res.data.pools || [];
                    } catch (e) { 
                        // Fallback: carica dataset e estrai pool
                        try {
                            const ds = (await axios.get(`${API}/nodes/${vmReplicaWizard.value.destNodeId}/datasets`)).data;
                            const pools = new Set();
                            ds.forEach(d => pools.add(d.name.split('/')[0]));
                            destPools.value = Array.from(pools);
                        } catch (e2) {}
                    }
                };
                
                const selectVMForReplica = async (vm) => {
                    vmReplicaWizard.value.active = true;
                    vmReplicaWizard.value.selectedVM = vm;
                    vmReplicaWizard.value.disks = [];
                    vmReplicaWizard.value.destVmId = '';
                    
                    loading.value = true;
                    try {
                        const res = await axios.get(`${API}/vms/node/${vmReplicaWizard.value.sourceNodeId}/vm/${vm.vmid}/disks?vm_type=${vm.type}`);
                        vmReplicaWizard.value.disks = res.data.disks.map(d => ({ ...d, selected: !!d.dataset }));
                        vmReplicaWizard.value.totalSize = res.data.total_size;
                    } catch (e) { 
                        showToast('Errore caricamento dischi: ' + (e.response?.data?.detail || e.message), 'error'); 
                    }
                    loading.value = false;
                };
                
                const cancelVMReplica = () => {
                    vmReplicaWizard.value.active = false;
                    vmReplicaWizard.value.selectedVM = null;
                    vmReplicaWizard.value.disks = [];
                };
                
                const createVMReplica = async () => {
                    const w = vmReplicaWizard.value;
                    if (!w.destPool) { showToast('Seleziona pool destinazione', 'error'); return; }
                    
                    const selectedDisks = w.disks.filter(d => d.selected && d.dataset);
                    if (selectedDisks.length === 0) { showToast('Seleziona almeno un disco', 'error'); return; }
                    
                    loading.value = true;
                    try {
                        const payload = {
                            vm_id: w.selectedVM.vmid,
                            vm_type: w.selectedVM.type,
                            vm_name: w.selectedVM.name,
                            source_node_id: parseInt(w.sourceNodeId),
                            dest_node_id: parseInt(w.destNodeId),
                            dest_pool: w.destPool,
                            dest_subfolder: w.destSubfolder,
                            dest_storage: w.destStorage || w.destSubfolder || null,
                            dest_vm_id: w.destVmId ? parseInt(w.destVmId) : null,
                            dest_vm_name_suffix: w.destVmNameSuffix || null,
                            schedule: w.schedule || null,
                            compress: w.compress,
                            register_vm: w.registerVM,
                            keep_snapshots: w.keep_snapshots || 0,
                            disks: selectedDisks,
                            // BTRFS support
                            sync_method: w.syncMethod || 'syncoid'
                        };
                        
                        // Aggiungi parametri BTRFS se metodo BTRFS selezionato
                        if (w.syncMethod === 'btrfs_send') {
                            payload.btrfs_mount = w.btrfsMount;
                            payload.btrfs_snapshot_dir = w.btrfsSnapshotDir || null;
                            payload.btrfs_max_snapshots = w.btrfsMaxSnapshots || 5;
                        }
                        
                        const res = await axios.post(`${API}/sync-jobs/vm-replica`, payload);
                        
                        const methodLabel = w.syncMethod === 'btrfs_send' ? 'BTRFS' : 'ZFS';
                        showToast(`‚úÖ Creati ${res.data.jobs_created} job ${methodLabel} per VM ${w.selectedVM.vmid}`, 'success');
                        cancelVMReplica();
                        await loadSyncJobs();
                    } catch (e) {
                        showToast('Errore: ' + (e.response?.data?.detail || e.message), 'error');
                    }
                    loading.value = false;
                };
                
                const runVMGroup = async (groupId) => {
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/sync-jobs/vm-group/${groupId}/run`);
                        showToast(`Avviati ${res.data.jobs_started} job`, 'success');
                        setTimeout(() => loadSyncJobs(), 2000);
                    } catch (e) { showToast('Errore avvio gruppo', 'error'); }
                    loading.value = false;
                };
                
                const deleteVMGroup = async (groupId) => {
                    if (!confirm('Eliminare tutti i job di replica per questa VM?')) return;
                    loading.value = true;
                    try {
                        const res = await axios.delete(`${API}/sync-jobs/vm-group/${groupId}`);
                        showToast(`Eliminati ${res.data.jobs_deleted} job`, 'success');
                        await loadSyncJobs();
                    } catch (e) { showToast('Errore eliminazione', 'error'); }
                    loading.value = false;
                };
                
                const registerVMGroup = async (group) => {
                    const job = group.jobs[0];
                    if (!job) return;
                    if (!confirm(`Registrare VM ${group.dest_vm_id || group.vm_id} su ${group.dest_node}?`)) return;
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/sync-jobs/${job.id}/register-vm`);
                        showToast(res.data.message, 'success');
                    } catch (e) { showToast(e.response?.data?.detail || 'Errore registrazione', 'error'); }
                    loading.value = false;
                };
                
                // ========== Snapshot Modal Functions ==========
                const showGroupSnapshots = async (group) => {
                    snapshotModalData.value = {
                        vmId: group.vm_id,
                        sourceNodeId: group.source_node_id,
                        destNodeId: group.dest_node_id,
                        sourceNode: group.source_node,
                        destNode: group.dest_node,
                        sourceDatasets: group.jobs.map(j => j.source_dataset),
                        destDatasets: group.jobs.map(j => j.dest_dataset),
                        sourceSnapshots: [],
                        destSnapshots: [],
                        loadingSource: true,
                        loadingDest: true
                    };
                    snapshotTab.value = 'source';
                    showSnapshotModal.value = true;
                    
                    // Carica snapshot sorgente
                    try {
                        const sourcePromises = snapshotModalData.value.sourceDatasets.map(ds => 
                            axios.get(`${API}/snapshots/node/${group.source_node_id}?dataset=${encodeURIComponent(ds)}`)
                        );
                        const sourceResults = await Promise.all(sourcePromises);
                        snapshotModalData.value.sourceSnapshots = sourceResults.flatMap(r => r.data);
                    } catch (e) {
                        console.error('Errore caricamento snapshot sorgente:', e);
                    }
                    snapshotModalData.value.loadingSource = false;
                    
                    // Carica snapshot destinazione
                    try {
                        const destPromises = snapshotModalData.value.destDatasets.map(ds => 
                            axios.get(`${API}/snapshots/node/${group.dest_node_id}?dataset=${encodeURIComponent(ds)}`)
                                .catch(() => ({ data: [] })) // Dataset potrebbe non esistere ancora
                        );
                        const destResults = await Promise.all(destPromises);
                        snapshotModalData.value.destSnapshots = destResults.flatMap(r => r.data);
                    } catch (e) {
                        console.error('Errore caricamento snapshot destinazione:', e);
                    }
                    snapshotModalData.value.loadingDest = false;
                };
                
                const refreshSnapshots = async () => {
                    if (!snapshotModalData.value.vmId) return;
                    snapshotModalData.value.loadingSource = true;
                    snapshotModalData.value.loadingDest = true;
                    
                    // Ri-carica snapshot sorgente
                    try {
                        const sourcePromises = snapshotModalData.value.sourceDatasets.map(ds => 
                            axios.get(`${API}/snapshots/node/${snapshotModalData.value.sourceNodeId}?dataset=${encodeURIComponent(ds)}`)
                        );
                        const sourceResults = await Promise.all(sourcePromises);
                        snapshotModalData.value.sourceSnapshots = sourceResults.flatMap(r => r.data);
                    } catch (e) {
                        console.error('Errore aggiornamento snapshot sorgente:', e);
                    }
                    snapshotModalData.value.loadingSource = false;
                    
                    // Ri-carica snapshot destinazione
                    try {
                        const destPromises = snapshotModalData.value.destDatasets.map(ds => 
                            axios.get(`${API}/snapshots/node/${snapshotModalData.value.destNodeId}?dataset=${encodeURIComponent(ds)}`)
                                .catch(() => ({ data: [] }))
                        );
                        const destResults = await Promise.all(destPromises);
                        snapshotModalData.value.destSnapshots = destResults.flatMap(r => r.data);
                    } catch (e) {
                        console.error('Errore aggiornamento snapshot destinazione:', e);
                    }
                    snapshotModalData.value.loadingDest = false;
                    
                    showToast('Snapshot aggiornati', 'success');
                };
                
                const loadSourceDatasets = async () => {
                    if (!newSyncJob.value.source_node_id) { sourceDatasets.value = []; return; }
                    try { 
                        sourceDatasets.value = (await axios.get(`${API}/nodes/${newSyncJob.value.source_node_id}/datasets`)).data;
                    } catch (e) { sourceDatasets.value = []; }
                };
                
                const loadDestDatasets = async () => {
                    if (!newSyncJob.value.dest_node_id) { destDatasets.value = []; destPools.value = []; return; }
                    try { 
                        destDatasets.value = (await axios.get(`${API}/nodes/${newSyncJob.value.dest_node_id}/datasets`)).data;
                        // Estrai i pool dai dataset
                        const pools = new Set();
                        destDatasets.value.forEach(ds => {
                            const root = ds.name.split('/')[0];
                            if (root) pools.add(root);
                        });
                        destPools.value = Array.from(pools);
                    } catch (e) { destDatasets.value = []; destPools.value = []; }
                };
                
                const onDestNodeChange = async () => {
                    await loadDestDatasets();
                    // Auto-seleziona il primo pool se disponibile
                    if (destPools.value.length > 0) {
                        destRootPool.value = destPools.value[0];
                        updateDestDataset();
                    }
                    // Verifica compatibilit√† se abbiamo VM ID
                    await checkSyncJobCompatibility();
                };
                
                const checkSyncJobCompatibility = async () => {
                    if (!newSyncJob.value.source_node_id || !newSyncJob.value.dest_node_id || !newSyncJob.value.vm_id) {
                        syncJobCompatibility.value = { warnings: [], info: {}, loading: false };
                        return;
                    }
                    
                    syncJobCompatibility.value.loading = true;
                    try {
                        const resp = await axios.get(`${API}/sync-jobs/check-compatibility`, {
                            params: {
                                source_node_id: newSyncJob.value.source_node_id,
                                dest_node_id: newSyncJob.value.dest_node_id,
                                vm_id: newSyncJob.value.vm_id,
                                vm_type: newSyncJob.value.vm_type || 'qemu'
                            }
                        });
                        syncJobCompatibility.value = { ...resp.data, loading: false };
                    } catch (e) {
                        console.error('Errore verifica compatibilit√†:', e);
                        syncJobCompatibility.value = { warnings: [], info: {}, loading: false };
                    }
                };
                
                const updateDestDataset = () => {
                    // Aggiorna automaticamente il dataset destinazione
                    if (suggestedDestDataset.value) {
                        newSyncJob.value.dest_dataset = suggestedDestDataset.value;
                    }
                };
                
                const applySchedule = () => {
                    if (selectedSchedule.value && selectedSchedule.value !== 'custom') {
                        newSyncJob.value.schedule = selectedSchedule.value;
                    }
                };
                
                // CRUD operations
                const createNode = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/nodes/`, newNode.value);
                        const sshSetup = res.data.ssh_key_setup;
                        
                        if (sshSetup) {
                            if (sshSetup.success || sshSetup.already_present) {
                                showToast(`Nodo creato. Chiave SSH: ${sshSetup.message}`, 'success');
                            } else if (sshSetup.needs_password) {
                                showToast('Nodo creato ma chiave SSH non distribuita. Vai su SSH Keys per configurare.', 'warning');
                            } else {
                                showToast(`Nodo creato. SSH: ${sshSetup.message}`, 'warning');
                            }
                        } else {
                            showToast('Nodo creato', 'success');
                        }
                        
                        showNodeModal.value = false;
                        newNode.value = { 
                            name: '', 
                            hostname: '', 
                            ssh_port: 22, 
                            ssh_user: 'root', 
                            ssh_key_path: '/root/.ssh/id_rsa',
                            node_type: 'pve',
                            pbs_datastore: 'datastore1',
                            pbs_fingerprint: '',
                            pbs_username: 'root@pam',
                            pbs_password: '',
                            storage_type: 'zfs',
                            btrfs_mount: '/mnt/btrfs-storage',
                            btrfs_snapshot_dir: '',
                            ssh_password: '',
                            auto_distribute_key: true
                        };
                        await loadNodes();
                    } catch (e) { showToast(e.response?.data?.detail || 'Errore', 'error'); }
                    loading.value = false;
                };
                
                const editNode = (node) => {
                    editingNode.value = { ...node };
                    showEditNodeModal.value = true;
                };
                
                const saveNode = async () => {
                    if (!editingNode.value) return;
                    loading.value = true;
                    try {
                        const payload = {
                            name: editingNode.value.name,
                            hostname: editingNode.value.hostname,
                            ssh_port: editingNode.value.ssh_port,
                            ssh_user: editingNode.value.ssh_user,
                            ssh_key_path: editingNode.value.ssh_key_path,
                            is_active: editingNode.value.is_active,
                            storage_type: editingNode.value.storage_type,
                            btrfs_mount: editingNode.value.btrfs_mount,
                            btrfs_snapshot_dir: editingNode.value.btrfs_snapshot_dir,
                            pbs_datastore: editingNode.value.pbs_datastore,
                            pbs_fingerprint: editingNode.value.pbs_fingerprint,
                            pbs_username: editingNode.value.pbs_username,
                            pbs_password: editingNode.value.pbs_password,
                            notes: editingNode.value.notes
                        };
                        await axios.put(`${API}/nodes/${editingNode.value.id}`, payload);
                        showToast('Nodo aggiornato!', 'success');
                        showEditNodeModal.value = false;
                        editingNode.value = null;
                        await loadNodes();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore salvataggio', 'error');
                    }
                    loading.value = false;
                };
                
                const testNode = async (node) => {
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/nodes/${node.id}/test`);
                        showToast(res.data.success ? 'Connessione OK' : 'Connessione fallita', res.data.success ? 'success' : 'error');
                        await loadNodes();
                    } catch (e) { showToast('Errore', 'error'); }
                    loading.value = false;
                };
                
                const installSanoid = async (node) => {
                    loading.value = true;
                    showToast('Installazione Sanoid...');
                    try {
                        await axios.post(`${API}/nodes/${node.id}/install-sanoid`);
                        showToast('Sanoid installato');
                        await loadNodes();
                    } catch (e) { showToast('Errore', 'error'); }
                    loading.value = false;
                };
                
                const deleteNode = async (node) => {
                    if (!confirm(`Eliminare ${node.name}?`)) return;
                    try { await axios.delete(`${API}/nodes/${node.id}`); showToast('Eliminato'); await loadNodes(); } catch (e) { showToast('Errore', 'error'); }
                };
                
                const refreshNodeDatasets = async (node) => {
                    loading.value = true;
                    try { await axios.get(`${API}/nodes/${node.id}/datasets?refresh=true`); showToast('Aggiornato'); } catch (e) {}
                    loading.value = false;
                };
                
                const updateDatasetConfig = async (ds) => {
                    try { await axios.put(`${API}/snapshots/dataset/${ds.id}/config`, ds); } catch (e) { showToast('Errore', 'error'); }
                };
                
                const applySanoidConfig = async () => {
                    if (!selectedNodeId.value) return;
                    loading.value = true;
                    try { await axios.post(`${API}/snapshots/node/${selectedNodeId.value}/apply-config`); showToast('Config applicata'); } catch (e) { showToast('Errore', 'error'); }
                    loading.value = false;
                };
                
                const createSyncJob = async () => {
                    loading.value = true;
                    try {
                        if (editingSyncJobId.value) {
                            await axios.put(`${API}/sync-jobs/${editingSyncJobId.value}`, newSyncJob.value);
                            showToast('Job aggiornato');
                        } else {
                            await axios.post(`${API}/sync-jobs/`, newSyncJob.value);
                            showToast('Job creato');
                        }
                        showSyncJobModal.value = false;
                        editingSyncJobId.value = null;
                        newSyncJob.value = { name: '', source_node_id: '', source_dataset: '', dest_node_id: '', dest_dataset: '', schedule: '', schedulePreset: '', compress: 'lz4', recursive: false, mbuffer_size: '128M', no_sync_snap: false, force_delete: false, extra_args: '', register_vm: false, vm_id: '', dest_vm_id: '', dest_vm_name_suffix: '', vm_type: 'qemu', notify_mode: 'daily', notify_subject: '', keep_snapshots: 0 };
                        sourceDatasets.value = [];
                        destDatasets.value = [];
                        selectedSchedule.value = '';
                        await loadSyncJobs();
                    } catch (e) { showToast(e.response?.data?.detail || 'Errore', 'error'); }
                    loading.value = false;
                };
                
                const runSyncJob = async (job) => {
                    try { 
                        await axios.post(`${API}/sync-jobs/${job.id}/run`); 
                        showToast('Job avviato in background...', 'info'); 
                        await loadSyncJobs();
                        // Poll per aggiornamenti ogni 3 secondi per 2 minuti
                        let pollCount = 0;
                        const pollInterval = setInterval(async () => {
                            pollCount++;
                            await loadSyncJobs();
                            // Trova il job e verifica se √® completato
                            const updatedJob = syncJobs.value.find(j => j.id === job.id);
                            if (updatedJob && updatedJob.last_status !== 'running') {
                                clearInterval(pollInterval);
                                if (updatedJob.last_status === 'success') {
                                    showToast(`‚úÖ Job ${job.name} completato!`, 'success');
                                } else if (updatedJob.last_status === 'failed') {
                                    showToast(`‚ùå Job ${job.name} fallito`, 'error');
                                }
                            }
                            if (pollCount >= 40) { // 40 * 3s = 2 minuti
                                clearInterval(pollInterval);
                            }
                        }, 3000);
                    } catch (e) { showToast('Errore avvio job', 'error'); }
                };
                
                const toggleSyncJob = async (job) => {
                    try { await axios.post(`${API}/sync-jobs/${job.id}/toggle`); await loadSyncJobs(); } catch (e) {}
                };
                
                const editSyncJob = async (job) => {
                    editingSyncJobId.value = job.id;
                    newSyncJob.value = {
                        name: job.name,
                        source_node_id: job.source_node_id,
                        source_dataset: job.source_dataset,
                        dest_node_id: job.dest_node_id,
                        dest_dataset: job.dest_dataset,
                        schedule: job.schedule || '',
                        schedulePreset: getSchedulePreset(job.schedule),
                        compress: job.compress || 'lz4',
                        recursive: job.recursive || false,
                        mbuffer_size: job.mbuffer_size || '128M',
                        no_sync_snap: job.no_sync_snap || false,
                        force_delete: job.force_delete || false,
                        extra_args: job.extra_args || '',
                        register_vm: job.register_vm || false,
                        vm_id: job.vm_id || '',
                        dest_vm_id: job.dest_vm_id || '',
                        dest_vm_name_suffix: job.dest_vm_name_suffix || '',
                        vm_type: job.vm_type || 'qemu',
                        notify_mode: job.notify_mode || 'daily',
                        notify_subject: job.notify_subject || '',
                        keep_snapshots: job.keep_snapshots || 0
                    };
                    
                    // Estrai pool e sottopercorso dal dest_dataset
                    if (job.dest_dataset) {
                        const parts = job.dest_dataset.split('/');
                        destRootPool.value = parts[0] || '';
                        // Il sottopercorso √® tutto tranne il primo e l'ultimo elemento
                        if (parts.length > 2) {
                            destSubPath.value = parts.slice(1, -1).join('/');
                        } else if (parts.length === 2) {
                            destSubPath.value = '';
                        }
                    }
                    
                    await loadSourceDatasets();
                    await loadDestDatasets();
                    showSyncJobModal.value = true;
                };
                
                const registerJobVM = async (job) => {
                    if (!confirm(`Registrare VM ${job.vm_id} su ${job.dest_node_name}?\n\nQuesto copier√† la configurazione dalla sorgente e registrer√† la VM sulla destinazione.`)) return;
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/sync-jobs/${job.id}/register-vm`);
                        showToast(res.data.message, 'success');
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore registrazione VM', 'error');
                    }
                    loading.value = false;
                };
                
                const deleteSyncJob = async (job) => {
                    if (!confirm(`Eliminare ${job.name}?`)) return;
                    try { await axios.delete(`${API}/sync-jobs/${job.id}`); showToast('Eliminato'); await loadSyncJobs(); } catch (e) {}
                };
                
                // ============== Sync Job Snapshot Management ==============
                const viewJobSnapshots = async (job) => {
                    syncSnapshotJob.value = job;
                    showSyncSnapshotModal.value = true;
                    await loadSyncJobSnapshots(job);
                };
                
                const loadSyncJobSnapshots = async (job) => {
                    syncSnapshotLoading.value = true;
                    try {
                        const res = await axios.get(`${API}/sync-jobs/${job.id}/snapshots`);
                        syncJobSnapshots.value = res.data;
                    } catch (e) {
                        showToast('Errore caricamento snapshot', 'error');
                        syncJobSnapshots.value = [];
                    }
                    syncSnapshotLoading.value = false;
                };
                
                const rollbackSyncSnapshot = async (snap) => {
                    if (!confirm(`‚ö†Ô∏è ATTENZIONE!\n\nVuoi ripristinare il dataset a:\n${snap.snapshot_name}\n\nTutti i dati successivi a questa snapshot verranno PERSI!\n\nContinuare?`)) return;
                    
                    loading.value = true;
                    try {
                        await axios.post(`${API}/sync-jobs/${syncSnapshotJob.value.id}/snapshots/${snap.snapshot_name}/rollback`);
                        showToast(`‚úÖ Rollback completato a ${snap.snapshot_name}`, 'success');
                        await loadSyncJobSnapshots(syncSnapshotJob.value);
                    } catch (e) {
                        showToast('Errore rollback: ' + (e.response?.data?.detail || e.message), 'error');
                    }
                    loading.value = false;
                };
                
                const cloneSyncJobSnapshot = (snap) => {
                    syncCloneSourceSnap.value = snap;
                    syncCloneName.value = `${syncSnapshotJob.value.dest_dataset.split('/').pop()}-recovery-${new Date().toISOString().slice(0,10)}`;
                    showSyncCloneModal.value = true;
                };
                
                const confirmSyncClone = async () => {
                    if (!syncCloneName.value) return;
                    
                    loading.value = true;
                    try {
                        const res = await axios.post(
                            `${API}/sync-jobs/${syncSnapshotJob.value.id}/snapshots/${syncCloneSourceSnap.value.snapshot_name}/clone?clone_name=${encodeURIComponent(syncCloneName.value)}`
                        );
                        showToast(`‚úÖ Clone creato: ${res.data.clone_dataset}`, 'success');
                        showSyncCloneModal.value = false;
                    } catch (e) {
                        showToast('Errore clone: ' + (e.response?.data?.detail || e.message), 'error');
                    }
                    loading.value = false;
                };
                
                const deleteSyncSnapshot = async (snap) => {
                    if (!confirm(`Eliminare la snapshot ${snap.snapshot_name}?`)) return;
                    
                    loading.value = true;
                    try {
                        await axios.delete(`${API}/sync-jobs/${syncSnapshotJob.value.id}/snapshots/${snap.snapshot_name}`);
                        showToast('Snapshot eliminata', 'success');
                        await loadSyncJobSnapshots(syncSnapshotJob.value);
                    } catch (e) {
                        showToast('Errore eliminazione: ' + (e.response?.data?.detail || e.message), 'error');
                    }
                    loading.value = false;
                };
                
                const getVmDatasets = async (vm) => {
                    try {
                        const res = await axios.get(`${API}/vms/node/${selectedVmNodeId.value}/vm/${vm.vmid}/datasets?vm_type=${vm.type}`);
                        alert(`Dataset VM ${vm.vmid}:\n${res.data.datasets.join('\n') || 'Nessuno'}`);
                    } catch (e) {}
                };
                
                // User management
                const editUser = (u) => {
                    editingUser.value = u;
                    newUser.value = { ...u };
                    showUserModal.value = true;
                };
                
                const saveUser = async () => {
                    loading.value = true;
                    try {
                        if (editingUser.value) {
                            await axios.put(`${API}/auth/users/${editingUser.value.id}`, newUser.value);
                        } else {
                            await axios.post(`${API}/auth/users`, newUser.value);
                        }
                        showToast('Salvato');
                        showUserModal.value = false;
                        editingUser.value = null;
                        newUser.value = { username: '', email: '', password: '', full_name: '', role: 'viewer' };
                        await loadUsers();
                    } catch (e) { showToast(e.response?.data?.detail || 'Errore', 'error'); }
                    loading.value = false;
                };
                
                const deleteUser = async (u) => {
                    if (!confirm(`Eliminare ${u.username}?`)) return;
                    try { await axios.delete(`${API}/auth/users/${u.id}`); showToast('Eliminato'); await loadUsers(); } catch (e) { showToast('Errore', 'error'); }
                };
                
                // Settings
                const saveSettings = async () => {
                    loading.value = true;
                    try {
                        for (const [k, v] of Object.entries(settings.value)) {
                            await axios.put(`${API}/settings/system/${k}`, { value: String(v) });
                        }
                        showToast('Salvato');
                    } catch (e) { showToast('Errore', 'error'); }
                    loading.value = false;
                };
                
                const saveAuthSettings = async () => {
                    loading.value = true;
                    try { await axios.put(`${API}/settings/auth/config`, authSettings.value); showToast('Salvato'); } catch (e) { showToast('Errore', 'error'); }
                    loading.value = false;
                };
                
                const saveNotifSettings = async () => {
                    loading.value = true;
                    try { await axios.put(`${API}/settings/notifications`, notifSettings.value); showToast('Salvato'); } catch (e) { showToast('Errore', 'error'); }
                    loading.value = false;
                };
                
                const testEmailNotification = async () => {
                    loading.value = true;
                    try {
                        // Prima salva la configurazione
                        await axios.put(`${API}/settings/notifications`, notifSettings.value);
                        // Poi invia il test
                        const res = await axios.post(`${API}/settings/notifications/test?channel=email`);
                        showToast(res.data.message || 'Email di test inviata!', 'success');
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore invio email di test', 'error');
                    }
                    loading.value = false;
                };
                
                const sendDailySummary = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/settings/notifications/send-daily-summary`);
                        if (res.data.success) {
                            showToast('Riepilogo giornaliero inviato!', 'success');
                        } else {
                            showToast(res.data.message || 'Riepilogo non inviato', 'warning');
                        }
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore invio riepilogo', 'error');
                    }
                    loading.value = false;
                };
                
                const saveDailySummaryHour = async () => {
                    loading.value = true;
                    try {
                        await axios.put(`${API}/settings/system/daily_summary_hour`, { value: String(dailySummaryHour.value) });
                        showToast('Orario riepilogo salvato', 'success');
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore', 'error');
                    }
                    loading.value = false;
                };
                
                const loadDailySummaryHour = async () => {
                    try {
                        const res = await axios.get(`${API}/settings/system/daily_summary_hour`);
                        dailySummaryHour.value = parseInt(res.data.value) || 8;
                    } catch (e) {
                        dailySummaryHour.value = 8;
                    }
                };
                
                // SSH Keys Management
                const loadSSHKeyInfo = async () => {
                    try {
                        const res = await axios.get(`${API}/ssh-keys/info`);
                        sshKeyInfo.value = res.data;
                    } catch (e) {
                        console.error('Errore caricamento info chiave SSH:', e);
                    }
                };
                
                const generateSSHKey = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/ssh-keys/generate`, {
                            key_type: 'rsa',
                            bits: 4096,
                            comment: 'sanoid-manager',
                            overwrite: false
                        });
                        if (res.data.key_info) {
                            sshKeyInfo.value = res.data.key_info;
                        }
                        showToast('Chiave SSH generata con successo', 'success');
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore generazione chiave', 'error');
                    }
                    loading.value = false;
                };
                
                const regenerateSSHKey = async () => {
                    if (!confirm('Sei sicuro? Dovrai ridistribuire la chiave a tutti i nodi!')) return;
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/ssh-keys/generate`, {
                            key_type: 'rsa',
                            bits: 4096,
                            comment: 'sanoid-manager',
                            overwrite: true
                        });
                        if (res.data.key_info) {
                            sshKeyInfo.value = res.data.key_info;
                        }
                        sshTestResults.value = {}; // Reset test results
                        showToast('Chiave SSH rigenerata! Ricorda di ridistribuirla ai nodi.', 'success');
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore rigenerazione chiave', 'error');
                    }
                    loading.value = false;
                };
                
                const copyPublicKey = () => {
                    if (sshKeyInfo.value.public_key) {
                        navigator.clipboard.writeText(sshKeyInfo.value.public_key);
                        showToast('Chiave copiata negli appunti');
                    }
                };
                
                const testAllSSHConnections = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/ssh-keys/test`, {});
                        for (const r of res.data) {
                            sshTestResults.value[r.node_id] = r;
                        }
                        const success = res.data.filter(r => r.success).length;
                        const total = res.data.length;
                        showToast(`Test completato: ${success}/${total} nodi OK`);
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore test connessioni', 'error');
                    }
                    loading.value = false;
                };
                
                const testSingleSSH = async (nodeId) => {
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/ssh-keys/test-single/${nodeId}`);
                        sshTestResults.value[nodeId] = res.data;
                        if (res.data.success) {
                            showToast(`Connessione OK a ${res.data.host}`);
                        } else {
                            showToast(`Errore connessione: ${res.data.message}`, 'error');
                        }
                    } catch (e) {
                        sshTestResults.value[nodeId] = { success: false, message: e.response?.data?.detail || 'Errore' };
                        showToast(e.response?.data?.detail || 'Errore test', 'error');
                    }
                    loading.value = false;
                };
                
                // SSH Key distribution con retry password
                const pendingDistributeNodeId = ref(null);
                const showPasswordPrompt = ref(false);
                const sshPassword = ref('');
                
                const distributeSingleKey = async (nodeId, password = null) => {
                    loading.value = true;
                    try {
                        const url = `${API}/ssh-keys/distribute-single/${nodeId}` + (password ? `?password=${encodeURIComponent(password)}` : '');
                        const res = await axios.post(url);
                        if (res.data.success) {
                            showToast(res.data.already_present ? 'Chiave gi√† presente' : 'Chiave distribuita con successo! üéâ');
                            sshTestResults.value[nodeId] = { success: true, message: 'Chiave installata' };
                            showPasswordPrompt.value = false;
                            sshPassword.value = '';
                        } else {
                            // Mostra prompt password se fallisce
                            if (!password && res.data.message.includes('Authentication')) {
                                pendingDistributeNodeId.value = nodeId;
                                showPasswordPrompt.value = true;
                                showToast('Autenticazione SSH fallita. Inserisci la password.', 'warning');
                            } else {
                                showToast(`Errore: ${res.data.message}`, 'error');
                            }
                        }
                    } catch (e) {
                        const errMsg = e.response?.data?.detail || e.response?.data?.message || 'Errore distribuzione';
                        // Mostra prompt password se errore di autenticazione
                        if (!password && (errMsg.includes('Authentication') || errMsg.includes('auth') || errMsg.includes('Permission'))) {
                            pendingDistributeNodeId.value = nodeId;
                            showPasswordPrompt.value = true;
                            showToast('Autenticazione SSH fallita. Inserisci la password del nodo.', 'warning');
                        } else {
                            showToast(errMsg, 'error');
                        }
                    }
                    loading.value = false;
                };
                
                const retryDistributeWithPassword = async () => {
                    if (!sshPassword.value) {
                        showToast('Inserisci la password', 'error');
                        return;
                    }
                    await distributeSingleKey(pendingDistributeNodeId.value, sshPassword.value);
                };
                
                const distributeKeyToSelected = async () => {
                    loading.value = true;
                    distributeResults.value = [];
                    try {
                        const res = await axios.post(`${API}/ssh-keys/distribute`, {
                            node_ids: selectedNodesForDistribute.value,
                            password: distributePassword.value || null
                        });
                        distributeResults.value = res.data;
                        
                        // Aggiorna test results
                        for (const r of res.data) {
                            const node = nodes.value.find(n => n.host === r.host);
                            if (node) {
                                sshTestResults.value[node.id] = { success: r.success, message: r.message };
                            }
                        }
                        
                        const success = res.data.filter(r => r.success).length;
                        showToast(`Distribuzione completata: ${success}/${res.data.length} OK`);
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore distribuzione', 'error');
                    }
                    loading.value = false;
                };
                
                const setupMeshSSH = async () => {
                    if (!confirm('Questo copier√† la stessa chiave SSH su TUTTI i nodi, permettendo a ogni nodo di connettersi agli altri.\n\nContinuare?')) return;
                    
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/ssh-keys/setup-mesh`, {});
                        
                        // Mostra risultati dettagliati
                        let msg = `Setup Mesh: ${res.data.stats.success}/${res.data.stats.total} nodi configurati\n\n`;
                        for (const r of res.data.results) {
                            const icon = r.success ? '‚úÖ' : '‚ùå';
                            msg += `${icon} ${r.node_name}: ${r.keypair_copied ? 'chiavi copiate' : r.keypair_message}\n`;
                        }
                        
                        if (res.data.stats.failed > 0) {
                            showToast(`Setup mesh parziale: ${res.data.stats.success}/${res.data.stats.total}`, 'warning');
                        } else {
                            showToast('Setup mesh completato! Tutti i nodi possono ora comunicare tra loro.', 'success');
                        }
                        
                        // Aggiorna test results
                        for (const r of res.data.results) {
                            if (r.node_id) {
                                sshTestResults.value[r.node_id] = { 
                                    success: r.success, 
                                    message: r.success ? 'Mesh configurato' : r.keypair_message 
                                };
                            }
                        }
                        
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore setup mesh', 'error');
                    }
                    loading.value = false;
                };
                
                // SSL/HTTPS Management
                const loadSslStatus = async () => {
                    try {
                        const res = await axios.get(`${API}/settings/ssl/status`);
                        sslStatus.value = res.data;
                    } catch (e) {
                        console.error('Errore caricamento stato SSL:', e);
                    }
                };
                
                const generateSslCert = async () => {
                    sslLoading.value = true;
                    try {
                        const ips = sslGenIps.value ? sslGenIps.value.split(',').map(ip => ip.trim()).filter(ip => ip) : null;
                        const res = await axios.post(`${API}/settings/ssl/generate-cert`, null, {
                            params: {
                                hostname: sslGenHostname.value || null,
                                days_valid: sslGenDays.value,
                                ip_addresses: ips
                            }
                        });
                        showToast('Certificato SSL generato con successo!', 'success');
                        loadSslStatus();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore generazione certificato', 'error');
                    }
                    sslLoading.value = false;
                };
                
                const uploadSslCert = async () => {
                    sslLoading.value = true;
                    try {
                        const res = await axios.post(`${API}/settings/ssl/upload-cert`, {
                            certificate: sslUploadCert.value,
                            private_key: sslUploadKey.value
                        });
                        showToast('Certificato caricato con successo!', 'success');
                        sslUploadCert.value = '';
                        sslUploadKey.value = '';
                        loadSslStatus();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore caricamento certificato', 'error');
                    }
                    sslLoading.value = false;
                };
                
                const deleteSslCert = async () => {
                    if (!confirm('Eliminare il certificato SSL?')) return;
                    sslLoading.value = true;
                    try {
                        await axios.delete(`${API}/settings/ssl/cert`);
                        showToast('Certificato eliminato', 'success');
                        loadSslStatus();
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore eliminazione certificato', 'error');
                    }
                    sslLoading.value = false;
                };
                
                // Crea job da VM
                const createBackupJobFromVm = (vm) => {
                    // Pre-popola il form backup e vai alla pagina
                    newBackupJob.value = {
                        name: `Backup-${vm.name || 'VM' + vm.vmid}`,
                        source_node_id: selectedVmNodeId.value,
                        vm_id: vm.vmid,
                        vm_type: vm.type || 'qemu',
                        vm_name: vm.name || '',
                        pbs_node_id: '',
                        pbs_storage_id: '',
                        backup_mode: 'snapshot',
                        backup_compress: 'zstd',
                        keep_last: 3,
                        schedule: '', schedulePreset: '',
                        notify_mode: 'daily', notify_subject: '',
                        is_active: true
                    };
                    
                    // Carica le VM del nodo (se non gi√† caricate) e gli storage PBS
                    if (selectedVmNodeId.value) {
                        loadBackupPbsStorages();
                    }
                    
                    currentPage.value = 'backup';
                    showToast(`Compila i campi mancanti per il backup di ${vm.name || vm.vmid}`, 'info');
                };
                
                const createRecoveryJobFromVm = (vm) => {
                    // Pre-popola il form recovery e vai alla pagina
                    newRecoveryJob.value = {
                        name: `Recovery-${vm.name || 'VM' + vm.vmid}`,
                        source_node_id: selectedVmNodeId.value,
                        vm_id: vm.vmid,
                        vm_type: vm.type || 'qemu',
                        vm_name: vm.name || '',
                        pbs_node_id: '',
                        dest_node_id: '',
                        dest_vm_id: null,
                        dest_vm_name_suffix: '-replica',
                        dest_storage: '',
                        backup_mode: 'snapshot',
                        backup_compress: 'zstd',
                        restore_start_vm: false,
                        restore_unique: true,
                        overwrite_existing: true,
                        schedule: '', schedulePreset: '',
                        notify_mode: 'daily', notify_subject: '',
                        is_active: true
                    };
                    currentPage.value = 'recovery';
                    showAddRecoveryJobModal.value = true;
                    showToast(`Compila i campi mancanti per il recovery di ${vm.name || vm.vmid}`, 'info');
                };
                
                const createSyncJobFromVm = async (vm) => {
                    // Verifica se la VM ha dataset ZFS
                    try {
                        const node = nodes.value.find(n => n.id == selectedVmNodeId.value);
                        if (!node) {
                            showToast('Nodo non trovato', 'error');
                            return;
                        }
                        
                        const resp = await axios.get(`${API}/vms/node/${selectedVmNodeId.value}/vm/${vm.vmid}/datasets`);
                        if (!resp.data.datasets || resp.data.datasets.length === 0) {
                            showToast('Questa VM non ha dataset ZFS. Usa Backup (PBS) per storage non-ZFS.', 'warning');
                            return;
                        }
                        
                        // Determina il tipo VM
                        const vmType = vm.type === 'lxc' ? 'lxc' : 'qemu';
                        
                        // Primo dataset trovato
                        const firstDataset = resp.data.datasets[0];
                        
                        // Pre-compila newSyncJob con i dati noti
                        editingSyncJobId.value = null;
                        newSyncJob.value = {
                            name: `${node.name}: ${vm.name || vm.vmid}`,
                            source_node_id: selectedVmNodeId.value,
                            source_dataset: firstDataset,
                            dest_node_id: '',
                            dest_dataset: '',
                            schedule: '',
                            schedulePreset: '',
                            compress: 'lz4',
                            recursive: false,
                            register_vm: true,
                            vm_id: vm.vmid.toString(),
                            dest_vm_id: '',
                            dest_vm_name_suffix: '-replica',
                            vm_type: vmType,
                            notify_mode: 'daily',
                            notify_subject: `Replica ${vm.name || vm.vmid}`,
                            keep_snapshots: 7,
                            force_cpu_host: true,
                            sync_method: 'syncoid',
                            btrfs_snapshot_dir: '',
                            btrfs_dest_snapshot_dir: '',
                            btrfs_max_snapshots: 5,
                            btrfs_full_sync: false,
                            disk_name: ''
                        };
                        
                        // Reset compatibility warnings
                        syncJobCompatibility.value = { warnings: [], info: {}, loading: false };
                        
                        // Reset pools
                        destRootPool.value = '';
                        destSubPath.value = 'replica';
                        
                        // Carica i dataset del nodo sorgente
                        await loadSourceDatasets();
                        
                        // Vai alla pagina sync e apri il modale
                        currentPage.value = 'sync';
                        showSyncJobModal.value = true;
                        
                        showToast(`Configura la destinazione per la replica di ${vm.name || vm.vmid}`, 'info');
                    } catch (e) {
                        showToast('Errore verifica dataset. Prova con Backup (PBS).', 'warning');
                        console.error(e);
                    }
                };
                
                // VM Snapshot Management
                const vmSnapshotTab = ref('snapshots');
                const vmSnapshotConfig = ref({
                    enabled: false,
                    schedule: null,
                    hourly: 0,
                    daily: 7,
                    weekly: 4,
                    monthly: 3,
                    yearly: 0,
                    template: 'production'
                });
                const vmSnapshotConfigLoading = ref(false);
                const vmSnapshotConfigSchedulePreset = ref('');
                
                const showVmSnapshots = (vm) => {
                    vmSnapshotData.value = {
                        vmId: vm.vmid,
                        vmName: vm.name,
                        nodeId: selectedVmNodeId.value,
                        nodeName: nodes.value.find(n => n.id == selectedVmNodeId.value)?.name || '',
                        total: 0,
                        datasets: {},
                        proxmoxTotal: 0,
                        proxmoxDatasets: {},
                        sanoidTotal: 0,
                        sanoidSnapshots: [],
                        syncoidTotal: 0,
                        syncoidSnapshots: [],
                        backupTotal: 0,
                        backupSnapshots: [],
                        loading: true
                    };
                    vmSnapshotTab.value = 'snapshots';
                    showVmSnapshotModal.value = true;
                    loadVmSnapshots();
                    loadVmSnapshotConfig();
                };
                
                const loadVmSnapshots = async () => {
                    vmSnapshotData.value.loading = true;
                    try {
                        const vmType = nodeVms.value.find(v => v.vmid == vmSnapshotData.value.vmId)?.type || 'qemu';
                        const res = await axios.get(`${API}/snapshots/vm/${vmSnapshotData.value.nodeId}/${vmSnapshotData.value.vmId}/all`, {
                            params: { vm_type: vmType }
                        });
                        
                        // Snapshot Proxmox
                        if (res.data.proxmox_snapshots) {
                            vmSnapshotData.value.proxmoxTotal = res.data.proxmox_snapshots.total_snapshots || 0;
                            vmSnapshotData.value.proxmoxDatasets = res.data.proxmox_snapshots.datasets || {};
                        }
                        
                        // Snapshot Sanoid
                        if (res.data.sanoid_snapshots) {
                            vmSnapshotData.value.sanoidTotal = res.data.sanoid_snapshots.length || 0;
                            vmSnapshotData.value.sanoidSnapshots = res.data.sanoid_snapshots || [];
                        }
                        
                        // Snapshot Syncoid
                        if (res.data.syncoid_snapshots) {
                            vmSnapshotData.value.syncoidTotal = res.data.syncoid_snapshots.length || 0;
                            vmSnapshotData.value.syncoidSnapshots = res.data.syncoid_snapshots || [];
                        }
                        
                        // Snapshot Backup
                        if (res.data.backup_snapshots) {
                            vmSnapshotData.value.backupTotal = res.data.backup_snapshots.length || 0;
                            vmSnapshotData.value.backupSnapshots = res.data.backup_snapshots || [];
                        }
                        
                        vmSnapshotData.value.total = res.data.total || 0;
                        vmSnapshotData.value.nodeName = res.data.node_name || vmSnapshotData.value.nodeName;
                    } catch (e) {
                        showToast('Errore caricamento snapshot', 'error');
                        console.error(e);
                    }
                    vmSnapshotData.value.loading = false;
                };
                
                const loadVmSnapshotConfig = async () => {
                    vmSnapshotConfigLoading.value = true;
                    try {
                        const vmType = nodeVms.value.find(v => v.vmid == vmSnapshotData.value.vmId)?.type || 'qemu';
                        const res = await axios.get(`${API}/snapshots/vm/${vmSnapshotData.value.nodeId}/${vmSnapshotData.value.vmId}/config`, {
                            params: { vm_type: vmType }
                        });
                        vmSnapshotConfig.value = {
                            enabled: res.data.enabled || false,
                            schedule: res.data.schedule || null,
                            hourly: res.data.hourly || 0,
                            daily: res.data.daily || 7,
                            weekly: res.data.weekly || 4,
                            monthly: res.data.monthly || 3,
                            yearly: res.data.yearly || 0,
                            template: res.data.template || 'production'
                        };
                        vmSnapshotConfigSchedulePreset.value = getSchedulePreset(vmSnapshotConfig.value.schedule);
                    } catch (e) {
                        console.error('Errore caricamento config:', e);
                    }
                    vmSnapshotConfigLoading.value = false;
                };
                
                const saveVmSnapshotConfig = async () => {
                    vmSnapshotConfigLoading.value = true;
                    try {
                        const vmType = nodeVms.value.find(v => v.vmid == vmSnapshotData.value.vmId)?.type || 'qemu';
                        await axios.put(`${API}/snapshots/vm/${vmSnapshotData.value.nodeId}/${vmSnapshotData.value.vmId}/config`, {
                            enabled: vmSnapshotConfig.value.enabled,
                            schedule: vmSnapshotConfig.value.schedule,
                            hourly: vmSnapshotConfig.value.hourly,
                            daily: vmSnapshotConfig.value.daily,
                            weekly: vmSnapshotConfig.value.weekly,
                            monthly: vmSnapshotConfig.value.monthly,
                            yearly: vmSnapshotConfig.value.yearly,
                            template: vmSnapshotConfig.value.template
                        }, {
                            params: { vm_type: vmType }
                        });
                        showToast('Configurazione salvata', 'success');
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore salvataggio configurazione', 'error');
                    }
                    vmSnapshotConfigLoading.value = false;
                };
                
                const rollbackToSnapshot = async (snap) => {
                    const msg = `‚ö†Ô∏è ATTENZIONE: Stai per eseguire un ROLLBACK!\n\nDataset: ${snap.dataset}\nSnapshot: ${snap.snapshot}\n\nTutti i dati successivi allo snapshot verranno PERSI!\n\nContinuare?`;
                    if (!confirm(msg)) return;
                    
                    // Doppia conferma per operazioni distruttive
                    if (!confirm('Sei ASSOLUTAMENTE sicuro? Questa operazione √® IRREVERSIBILE!')) return;
                    
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/snapshots/node/${vmSnapshotData.value.nodeId}/rollback?full_name=${encodeURIComponent(snap.full_name)}&force=true`);
                        if (res.data.success) {
                            showToast(`Rollback completato a ${snap.snapshot}`, 'success');
                        } else {
                            showToast(`Errore: ${res.data.message}`, 'error');
                        }
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore rollback', 'error');
                    }
                    loading.value = false;
                };
                
                const cloneSnapshot = async (snap) => {
                    const defaultName = `${snap.dataset}-clone-${Date.now()}`;
                    const cloneName = prompt(`Nome del clone:\n(Percorso completo del nuovo dataset)`, defaultName);
                    if (!cloneName) return;
                    
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API}/snapshots/node/${vmSnapshotData.value.nodeId}/clone?full_name=${encodeURIComponent(snap.full_name)}&clone_name=${encodeURIComponent(cloneName)}`);
                        if (res.data.success) {
                            showToast(`Clone creato: ${cloneName}`, 'success');
                        } else {
                            showToast(`Errore: ${res.data.message}`, 'error');
                        }
                    } catch (e) {
                        showToast(e.response?.data?.detail || 'Errore clone', 'error');
                    }
                    loading.value = false;
                };
                
                // Watch currentPage to load dashboard when navigating
                watch(currentPage, (newPage) => {
                    if (newPage === 'proxmox') {
                        // Carica dati Proxmox da localStorage, non forzare refresh
                        loadDashboard(false);
                    } else if (newPage === 'backup') {
                        loadBackupJobs();
                        loadNodes();
                    } else if (newPage === 'recovery') {
                        loadRecoveryJobs();
                        loadNodes();
                    } else if (newPage === 'restore') {
                        loadNodes();
                        // Resetta selezione PBS e backup
                        selectedRestorePbs.value = null;
                        restorePbsBackups.value = [];
                    } else if (newPage === 'logs') {
                        loadLogs();
                    } else if (newPage === 'host-backup') {
                        loadHostBackupData();
                        loadNodes();
                    } else if (newPage === 'migration') {
                        loadMigrationJobs();
                        loadNodes();
                    }
                });
                
                // Init
                onMounted(async () => {
                    if (checkAuth()) {
                        await loadAllData();
                        // Load Proxmox dashboard if on proxmox page (da localStorage)
                        if (currentPage.value === 'proxmox') {
                            await loadDashboard(false);
                        }
                    } else {
                        await checkSetup();
                    }
                });
                
                return {
                    isAuthenticated, setupRequired, currentUser, authConfig, loginForm, setupForm, loginError,
                    currentPage, settingsTab, loading, toasts,
                    nodes, syncJobs, recentLogs, allLogs, datasets, snapshots, nodeVms, users,
                    showVmBackupsModal, selectedVmForBackups, vmBackupsList,
                    selectedNodeId, selectedVmNodeId, selectedLog,
                    sourceDatasets, destDatasets, selectedSchedule,
                    destRootPool, destSubPath, destPools, suggestedDestDataset,
                    // VM Replica
                    sourceVMs, vmReplicaWizard, btrfsWizard, vmGroups, singleJobs,
                    // Recovery Jobs (PBS)
                    recoveryJobs, pbsNodes, pveNodes, showAddRecoveryJobModal, sourceVmsForRecovery, newRecoveryJob,
                    // Backup Jobs
                    backupJobs, sourceVmsForBackup, backupPbsStorages, newBackupJob, showEditBackupJobModal, editingBackupJob,
                    loadBackupJobs, loadSourceVmsForBackup, loadBackupPbsStorages, selectBackupVm, createBackupJob, runBackupJob, deleteBackupJob, editBackupJob, saveBackupJob,
                    // Migration Jobs
                    migrationJobs, showMigrationJobModal, editingMigrationJobId, selectedMigrationVm, migrationVmDisks, migrationVmNetworks, destNodeStorages, destNodeBridges, newMigrationJob,
                    loadMigrationJobs, loadMigrationSourceVMs, loadMigrationDestResources, loadMigrationVmDetails, resetMigrationJobForm, saveMigrationJob, editMigrationJob, deleteMigrationJob, runMigrationJob, toggleMigrationJob, updateNetworkConfig,
                    // Restore from PBS
                    selectedRestorePbs, restorePbsBackups, showRestoreModal, restoreData, restoreStorages,
                    expandedBackupGroups, groupedRestoreBackups, toggleBackupGroup,
                    browseRestorePbs, startRestore, loadRestoreStorages, executeRestore,
                    // Host Config Backup
                    hostBackup, hostBackupJobs, hostBackupJob, showHostRetentionModal, hostRetentionCount,
                    loadHostBackupData, loadHostBackupJobs, loadHostBackupPaths, loadHostBackups, 
                    createHostBackupJob, runHostBackupJob, editHostBackupJob, deleteHostBackupJob,
                    createHostBackup, deleteHostBackup, applyHostRetention,
                    settings, authSettings, notifSettings,
                    showNodeModal, showEditNodeModal, editingNode, showSyncJobModal, editingSyncJobId, syncJobCompatibility, showUserModal, editingUser, showInfoModal,
                    // SSH Keys
                    sshKeyInfo, sshTestResults, showDistributeModal, distributePassword, selectedNodesForDistribute, distributeResults,
                    showPasswordPrompt, sshPassword, pendingDistributeNodeId, retryDistributeWithPassword,
                    // VM Snapshots
                    showVmSnapshotModal, vmSnapshotData,
                    // Snapshot Modal
                    showSnapshotModal, snapshotTab, snapshotModalData,
                    // Dashboard
                    dashboardOverview, dashboardNodes, dashboardVMs, dashboardDataFromCache,
                    selectedNodeDetail, selectedVMDetail, loadingNodeDetail, loadingVMDetail,
                    newNode, newSyncJob, newUser,
                    // Schedule presets
                    schedulePresets, formatSchedule, onSchedulePresetChange, getSchedulePreset,
                    isAdmin, canEdit,
                    showToast, formatDate, formatUptime, formatSize, getStatusClass,
                    doSetup, doLogin, doLogout,
                    loadNodes, loadSyncJobs, loadLogs, loadNotifSettings, loadNodeDatasets, loadNodeSnapshots, loadNodeVms,
                    showVmBackups, startRestoreFromVmBackup,
                    loadSourceDatasets, loadDestDatasets, onDestNodeChange, updateDestDataset, checkSyncJobCompatibility, applySchedule, showLogDetail,
                    // Dashboard functions
                    loadDashboard, loadNodeDetails, loadVMDetails, viewNodeDetails, viewVMDetails,
                    // VM Replica functions
                    loadSourceVMs, loadDestPools, selectVMForReplica, cancelVMReplica, createVMReplica,
                    runVMGroup, deleteVMGroup, registerVMGroup,
                    // Snapshot functions
                    showGroupSnapshots, refreshSnapshots,
                    createNode, editNode, saveNode, testNode, installSanoid, deleteNode, refreshNodeDatasets,
                    updateDatasetConfig, applySanoidConfig,
                    createSyncJob, runSyncJob, toggleSyncJob, deleteSyncJob, editSyncJob, registerJobVM,
                    // Sync Job Snapshot management
                    viewJobSnapshots, loadSyncJobSnapshots, rollbackSyncSnapshot, deleteSyncSnapshot, cloneSyncJobSnapshot,
                    showSyncSnapshotModal, syncSnapshotJob, syncJobSnapshots, syncSnapshotLoading,
                    showSyncCloneModal, syncCloneSourceSnap, syncCloneName, confirmSyncClone,
                    getVmDatasets,
                    editUser, saveUser, deleteUser,
                    saveSettings, saveAuthSettings, saveNotifSettings, testEmailNotification,
                    sendDailySummary, saveDailySummaryHour, loadDailySummaryHour, dailySummaryHour,
                    // SSH Keys functions
                    loadSSHKeyInfo, generateSSHKey, regenerateSSHKey, copyPublicKey,
                    testAllSSHConnections, testSingleSSH, distributeSingleKey, distributeKeyToSelected,
                    // SSL/HTTPS
                    sslStatus, sslLoading, sslGenHostname, sslGenDays, sslGenIps, sslUploadCert, sslUploadKey,
                    loadSslStatus, generateSslCert, uploadSslCert, deleteSslCert,
                    setupMeshSSH,
                    // VM Snapshot functions
                    showVmSnapshots, loadVmSnapshots, rollbackToSnapshot, cloneSnapshot,
                    vmSnapshotTab, vmSnapshotConfig, vmSnapshotConfigLoading, vmSnapshotConfigSchedulePreset,
                    loadVmSnapshotConfig, saveVmSnapshotConfig,
                    createBackupJobFromVm, createRecoveryJobFromVm, createSyncJobFromVm,
                    // Recovery Jobs functions
                    loadRecoveryJobs, loadSourceVms, createRecoveryJob, runRecoveryJob, 
                    deleteRecoveryJob, editRecoveryJob, saveRecoveryJob, testPbsNode, getRecoveryJobStatus,
                    // PBS Browse
                    pbsBrowseData, browsePbsBackups, extractVmIdFromBackup, extractTypeFromBackup, formatBackupDate, createRecoveryFromPbsBackup,
                    destStorages, vmidCheckResult, loadDestStorages, checkDestVmid,
                    showEditRecoveryJobModal, editingRecoveryJob,
                    sourcePbsStorages, loadSourcePbsStorages,
                    // Helper functions
                    getNodeName
                };
            }
        }).mount('#app');
    </script>
</body>
</html>


